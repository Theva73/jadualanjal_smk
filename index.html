<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadual Anjal SMK</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .control-button { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; color: white; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .control-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .control-button i { margin-right: 8px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 max-w-4xl">

        <!-- Header: User ID Display -->
        <div class="bg-white p-3 mb-4 rounded-lg shadow-md text-center">
            <h2 class="text-lg font-bold text-gray-700">User ID</h2>
            <p id="userIdDisplay" class="text-sm text-gray-500 font-mono bg-gray-100 p-2 rounded-md break-all">Connecting...</p>
        </div>

        <!-- Main Controls Section -->
        <div class="bg-white p-4 rounded-lg shadow-md">
             <!-- Always Visible Controls -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                <button id="savePageBtn" class="control-button bg-blue-500 hover:bg-blue-600"><i class="fas fa-save"></i> Save Page</button>
                <button class="control-button bg-green-500 hover:bg-green-600"><i class="fas fa-file-pdf"></i> PDF</button>
                <button class="control-button bg-purple-500 hover:bg-purple-600"><i class="fas fa-eraser"></i> Clear Names</button>
                <button class="control-button bg-gray-200 text-gray-700 hover:bg-gray-300 col-span-2 sm:col-span-4"><i class="fas fa-search"></i> Search Timetable</button>
            </div>
             <!-- Toggle Button for Hidden Controls -->
            <button id="toggleControlsBtn" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-700 transition duration-300 mb-4">
                <i class="fas fa-chevron-down mr-2"></i> Show More Controls
            </button>
            <!-- Hidden Controls Container (omitted for brevity, no changes) -->
            <div id="hiddenControls" class="hidden">...</div>
        </div>

        <!-- Timetable Content Area -->
        <div id="timetableContainer" class="mt-4 bg-white p-4 rounded-lg shadow-md min-h-[300px]">
             <h3 id="loadingMessage" class="text-center text-gray-500">Your timetable content will go here.</h3>
        </div>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI Elements ---
        const userIdDisplay = document.getElementById('userIdDisplay');
        const timetableContainer = document.getElementById('timetableContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const savePageBtn = document.getElementById('savePageBtn');
        // (other UI elements...)

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
          authDomain: "jadual-3f0aa.firebaseapp.com",
          projectId: "jadual-3f0aa",
          storageBucket: "jadual-3f0aa.appspot.com",
          messagingSenderId: "496526436851",
          appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
        };

        // --- App State ---
        let auth, db, userId;

        // --- Functions ---

        /**
         * Renders the timetable data into the container.
         * @param {object} data The timetable data from Firestore.
         */
        function renderTimetable(data) {
            // Clear the container
            timetableContainer.innerHTML = '';
            
            // =================================================================
            // == TODO: PASTE YOUR ORIGINAL TABLE-BUILDING JAVASCRIPT HERE   ==
            // =================================================================
            // Example:
            const title = document.createElement('h2');
            title.textContent = data.title || 'My Timetable';
            title.className = 'text-xl font-bold text-center mb-4';
            timetableContainer.appendChild(title);

            // Here you would loop through your data and create the HTML table
            // This is just a placeholder to show it's working:
            const dataPreview = document.createElement('pre');
            dataPreview.textContent = JSON.stringify(data, null, 2);
            timetableContainer.appendChild(dataPreview);
            // =================================================================
        }

        /**
         * Fetches timetable data from Firestore for the current user.
         */
        async function loadTimetableData() {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not logged in.");
                return;
            }
            loadingMessage.textContent = 'Loading your timetable...';
            
            // This creates a reference to a document named 'main_schedule'
            // inside a 'timetables' collection for the specific user.
            const docRef = doc(db, `users/${userId}/timetables`, 'main_schedule');

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("Document data:", docSnap.data());
                    renderTimetable(docSnap.data());
                } else {
                    console.log("No such document! Creating a new one.");
                    loadingMessage.textContent = 'No saved timetable found. A new one will be created when you save.';
                }
            } catch (error) {
                console.error("Error loading document:", error);
                loadingMessage.textContent = 'Error loading timetable.';
            }
        }
        
        /**
         * Saves the current timetable data to Firestore.
         */
        async function saveTimetableData() {
            if (!db || !userId) {
                alert("Cannot save. User not connected."); // Replace with a proper modal later
                return;
            }
            console.log("Saving data for user:", userId);

            // --- This is placeholder data. You need to gather your actual timetable data ---
            const timetableDataToSave = {
                title: "My Schedule",
                lastSaved: new Date(),
                schedule: {
                    monday: ["Math", "Science"],
                    tuesday: ["History", "English"]
                }
            };
            
            const docRef = doc(db, `users/${userId}/timetables`, 'main_schedule');
            try {
                await setDoc(docRef, timetableDataToSave, { merge: true });
                console.log("Data saved successfully!");
                alert("Timetable Saved!"); // Replace with a proper modal later
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Error saving timetable."); // Replace with a proper modal later
            }
        }

        // --- Initialization ---
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("User is authenticated. UID:", userId);
                    await loadTimetableData(); // <<< LOAD DATA AFTER SIGN-IN
                } else {
                    userIdDisplay.textContent = "Not Logged In";
                }
            });
            
            await signInAnonymously(auth);
            
            // Add event listener for the save button
            savePageBtn.addEventListener('click', saveTimetableData);

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            userIdDisplay.textContent = "Connection Error";
        }

    </script>
</body>
</html>


