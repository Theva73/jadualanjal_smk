<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.1, maximum-scale=5.0">
    <title>Jadual Anjal (Enhanced)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            min-height: 100vh;
        }
        .main-container {
            width: 100%;
            max-width: 1400px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }
        h2, h3 {
            color: #1c1e21;
            text-align: center;
            margin-bottom: 20px;
        }
        #scheduleTitle {
            font-size: 2em;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
        }
        #userIdDisplay {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
            min-height: 1.2em;
            word-break: break-all;
        }
        #topActionButtonsBar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: stretch;
            justify-content: center;
            margin-bottom: 20px;
            width: 100%;
        }
        .top-action-btn {
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            color: #ffffff;
            transition: all 0.25s ease-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.03);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
            flex-grow: 1;
            flex-basis: 150px;
            text-align: center;
            min-height: 40px;
            box-sizing: border-box;
        }
        #controlsToggler.top-action-btn { background-image: linear-gradient(to right, #007bff 0%, #0056b3 100%); }
        #controlsToggler.top-action-btn:hover { background-image: linear-gradient(to right, #0069d9 0%, #004085 100%); box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06); transform: translateY(-1px); }
        #manualSaveBtn.top-action-btn { background-image: linear-gradient(to right, #17a2b8 0%, #117a8b 100%); }
        #manualSaveBtn.top-action-btn:hover { background-image: linear-gradient(to right, #138496 0%, #0c6270 100%); box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06); transform: translateY(-1px); }
        #downloadPdfBtn.top-action-btn { background-image: linear-gradient(to right, #28a745 0%, #1e7e34 100%); }
        #downloadPdfBtn.top-action-btn:hover { background-image: linear-gradient(to right, #218838 0%, #155724 100%); box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06); transform: translateY(-1px); }
        #clearScheduledNamesBtn.top-action-btn { background-image: linear-gradient(to right, #6f42c1 0%, #563d7c 100%); }
        #clearScheduledNamesBtn.top-action-btn:hover { background-image: linear-gradient(to right, #5a2a9e 0%, #452863 100%); box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .top-action-btn:active { transform: translateY(0px); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        #controlsToggler .toggler-icon { transition: transform 0.3s ease-out; width: 18px; height: 18px; }
        #controlsToggler[aria-expanded="false"] .toggler-icon { transform: rotate(180deg); }
        #controlsToggler[aria-expanded="true"] .toggler-icon { transform: rotate(0deg); }
        #collapsibleButtonBars { max-height: 1000px; overflow: hidden; transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, padding-top 0.4s ease-in-out, padding-bottom 0.4s ease-in-out; padding-top: 5px; padding-bottom: 5px; width: 100%; }
        #collapsibleButtonBars:not(.open) { max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; }
        .bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; align-items: stretch; justify-content: center; }
        .bar button { padding: 10px 15px; font-size: 0.9em; font-weight: 500; border-radius: 8px; cursor: pointer; border: 1px solid #ced4da; background-color: #f8f9fa; color: #212529; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.04); display: inline-flex; align-items: center; justify-content: center; gap: 6px; flex-grow: 1; flex-basis: 120px; text-align: center; min-width: 100px; }
        .bar button:hover { border-color: #adb5bd; background-color: #e9ecef; box-shadow: 0 2px 5px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .bar button:active { transform: translateY(0px); background-color: #dee2e6; box-shadow: inset 0 1px 2px rgba(0,0,0,0.06); }
        #directCopyFullHtmlBtn { background-color: #545b62; color: white; border-color: #4e555b;}
        #excelBtnTrigger, #importExcelBtn, .input-group button, #subjectGroupsBtn, #createGroupBtn { background-color: #28a745; color: white; border-color: #23923d;}
        #saveSharedScheduleBtn { background-color: #007bff; color: white; border-color: #0069d9;}
        #loadSharedScheduleBtn { background-color: #ffc107; color: #212529; border-color: #e0a800;}
        #restoreBackupBtn { background-color: #fd7e0f; color: white; border-color: #df6e0d; }
        #clearAndResetScheduleBtn, #nameListBtn, #subjectListBtn { background-color: #fd7e14; color: white; border-color: #e66a04;}
        #selectBtn { background-color: #17a2b8; color: white; border-color: #117a8b;}
        #selectBtn.active { background-color: #e66a04; border-color: #d05f03;}
        #mergeBtn { background-color: #6f42c1; color: white; border-color: #5d37a2;}
        #unmergeBtn { background-color: #e83e8c; color: white; border-color: #d9307b;}
        #addTableBtn { background-color: #20c997; color: white; border-color: #1aa87f;}
        #addIndependentTableBtn.top-action-btn { background-image: linear-gradient(to right, #ff7f50 0%, #ff4500 100%); }
        #addIndependentTableBtn.top-action-btn:hover { background-image: linear-gradient(to right, #ff9966 0%, #cc3700 100%); box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06); transform: translateY(-1px); }
        #renameTableBtn, #deselectBtn { background-color: #6c757d; color: white; border-color: #5a6268;}
        #deleteTableBtn, #rowColManipulationBar button.delete-btn { background-color: #dc3545; color: white; border-color: #c82333;}
        table { border-collapse: collapse; width: 100%; margin-top: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background-color: #fff; table-layout: auto; }
        #tablesContainer, #summaryTableContainer { overflow-x: auto; position: relative; width: 100%; }
        #tablesContainer > table { display: none; }
        #tablesContainer > table.active { display: table; }
        th, td { border: 1px solid #dee2e6; padding: 10px 12px; text-align: center; min-width: 90px; box-sizing: border-box; position: relative; font-size: 0.9em; }
        table th { background-color: #f8f9fa; color: #343a40; font-weight: 600; white-space: nowrap; }
        #tablesContainer > table > thead > tr:not(.date-header-row) > th { font-weight: bold; background-color: #e9ecef; color: #343a40; }
        #tablesContainer > table > thead > tr:not(.date-header-row) > th:first-child, #tablesContainer > table > tbody > tr > td:first-child, #tablesContainer > table > tbody > tr > th:first-child { font-weight: bold; background-color: #e6f7ff; color: #1c1e21; }
        #tablesContainer > table > thead > tr.date-header-row > th.date-header-cell { font-weight: bold; background-color: #cce0ff; color: #1c1e21; white-space: normal; }
        .table-tabs { margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 0; display: flex; flex-wrap: wrap; gap: 5px; }
        .table-tabs button { background-color: transparent; border: none; border-bottom: 3px solid transparent; border-radius: 6px 6px 0 0; color: #0056b3; font-weight: 500; padding: 10px 15px; transition: all 0.2s ease; }
        .table-tabs button.active { background-color: #007bff; color: white; border-color: #0056b3; }
        .table-tabs button:hover:not(.active) { background-color: #e9f5ff; color: #004494; }
        .highlight-conflict { background-color: #f8d7da !important; font-weight: bold; color: #721c24 !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; pointer-events: none; }
        .modal-content { background-color: #fff; padding: 25px; border: 1px solid #ccc; width: 90%; max-width: 650px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); position: relative; pointer-events: auto; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        .modal-header { padding-bottom: 15px; border-bottom: 1px solid #e9ecef; margin-bottom: 20px; font-size: 1.3em; color: #333; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none; }
        .modal-close-btn { font-size: 1.8rem; font-weight: bold; line-height: 1; color: #555; text-shadow: none; opacity: .7; background: transparent; border: 0; cursor: pointer; padding: 0 5px; transition: color 0.2s; }
        .modal-close-btn:hover { opacity: 1; color: #dc3545; }
        .item-list .item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f1f3f5; }
        .item-list .item span { cursor: pointer; flex-grow: 1; }
        .item-list .item span.highlighted { background-color: #cfe2ff; font-weight: bold; }
        .delete-item-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; }
        .manager-tabs { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 15px; }
        .manager-tabs button { background: #f8f9fa; border: 1px solid #dee2e6; border-bottom: none; padding: 10px 15px; border-radius: 6px 6px 0 0; margin-right: 5px; cursor: pointer; }
        .manager-tabs button.active { background: #ffffff; color: #007bff; font-weight: bold; border-bottom: 1px solid #ffffff; }
        .subject-group-item { display: flex; flex-direction: column; align-items: stretch; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;}
        .group-header { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .group-teachers-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; background: #fff; padding: 10px; border-radius: 4px; border: 1px solid #ddd; max-height: 150px; overflow-y: auto;}
        .save-group-changes-btn { background-color: #28a745; color: white; border: none; padding: 8px; border-radius: 5px; align-self: flex-end; cursor: pointer; }
        .input-group { display: flex; margin-bottom: 15px; width: 100%; }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .input-group button { border-radius: 0 5px 5px 0; }
        .custom-message-box { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 15px 25px; border-radius: 8px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.25); font-size: 1.05em; text-align: center; width: 90%; max-width: 400px; }
        .custom-message-box.success { background-color: #28a745; }
        .custom-message-box.error { background-color: #dc3545; }
        #loadingIndicatorModal, #generalLoadingIndicator { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: 10px; }
        #generalLoadingIndicator { position: fixed; z-index: 3000; border-radius: 0; }
        .spinner { border: 5px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: #007bff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #autocompleteSuggestions { display: none; position: absolute; border: 1px solid #ccc; background-color: white; z-index: 1001; max-height: 150px; overflow-y: auto; min-width: 120px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); border-radius: 4px; }
        .suggestion-item { padding: 8px 10px; cursor: pointer; font-size: 0.9em; white-space: nowrap; }
        .suggestion-item:hover, .suggestion-item.active-suggestion { background-color: #e9ecef; color: #0056b3; }
        .panel{ position:fixed; top:80px; left:80px; width:420px; height:280px; background:#1f273b; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.35); display:flex; flex-direction:column; z-index:3000; overflow:hidden; touch-action:none; }
        .panel.hidden{display:none;}
        .panel-header{ flex:0 0 42px; background:#007bff; color:#fff; font-weight:600; display:flex;align-items:center;justify-content:space-between; padding:0 12px; cursor:grab; user-select:none; touch-action:none; }
        .panel-header:active{cursor:grabbing;}
        .panel-header button{ all:unset; font-size:1.6em; line-height:1; cursor:pointer; padding:0 4px; }
        .panel iframe{flex:1 1 auto;}
        .panel-grip{ position:absolute; right:0; bottom:0; width:22px;height:22px; background:#007bff; clip-path:polygon(100% 0,100% 100%,0 100%); cursor:se-resize; }
    </style>
</head>
<body>
<div class="main-container">
    <h2 contenteditable="true" id="scheduleTitle">Jadual Anjal</h2>
    <div id="userIdDisplay">User ID: Loading...</div>

    <div id="topActionButtonsBar">
        <button id="controlsToggler" class="top-action-btn" aria-expanded="false" aria-controls="collapsibleButtonBars" title="Toggle button controls visibility">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toggler-icon"><polyline points="18 15 12 9 6 15"></polyline></svg>
            <span>Show Controls</span>
        </button>
        <button id="manualSaveBtn" class="top-action-btn" title="Manually save current page state to Cloud (also creates a backup)">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            <span>Save Page</span>
        </button>
        <button id="downloadPdfBtn" class="top-action-btn" title="Download schedule tables as PDF">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            <span>PDF</span>
        </button>
        <button id="clearScheduledNamesBtn" class="top-action-btn" title="Clear scheduled names from ALL tables (retains merged cell content)">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="17" y1="8" x2="22" y2="13"></line><line x1="22" y1="8" x2="17" y2="13"></line></svg>
            <span>Clear Names (All Tables)</span>
        </button>
        <button id="searchTimetableBtn" class="top-action-btn" title="Open searchable timetable">🔍 Search Timetable</button>
    </div>

    <div id="collapsibleButtonBars">
        <!-- Original Button Bars -->
        <div class="bar">
            <button id="addTableBtn" title="Add a new, empty table/sheet">➕ Add Table</button>
            <button id="renameTableBtn" title="Rename the currently active table/sheet">📝 Rename Table</button>
            <button id="deleteTableBtn" title="Delete the currently active table/sheet">❌ Delete Table</button>
            <!-- MODIFIED: "Names" button now opens new manager -->
            <button id="nameListBtn" title="Open a dialog to manage shared lists of teachers and subjects">👥 Lists</button>
            <!-- NEW: Subject Groups Button -->
            <button id="subjectGroupsBtn" title="Manage teacher groups by subject">🔬 Groups</button>
        </div>
        <!-- Other original bars -->
        <div class="bar">
            <button id="selectBtn" title="Toggle cell selection mode on/off">✨ Select Cells</button>
            <button id="mergeBtn" title="Merge the currently selected cells">🔗 Merge</button>
            <button id="deselectBtn" title="Clear current cell selection">🚫 Deselect</button>
            <button id="unmergeBtn" title="Unmerge the cell that was last clicked if it's part of a merge">💔 Unmerge</button>
        </div>
        <div class="bar" id="rowColManipulationBar">
             <button id="addRowAboveBtn" title="Add a new row above the currently selected/clicked row">⬆️ Row Above</button>
            <button id="addRowBelowBtn" title="Add a new row below the currently selected/clicked row">⬇️ Row Below</button>
            <button id="addColLeftBtn" title="Add a new column to the left of the currently selected/clicked column">⬅️ Col Left</button>
            <button id="addColRightBtn" title="Add a new column to the right of the currently selected/clicked column">➡️ Col Right</button>
            <button id="deleteRowBtn" class="delete-btn" title="Delete the currently selected/clicked row">🗑️ Del Row</button>
            <button id="deleteColBtn" class="delete-btn" title="Delete the currently selected/clicked column">🗑️ Del Col</button>
        </div>
        <div class="bar">
            <button id="excelBtnTrigger" title="Export the currently active table to an Excel file">💾 Export Excel</button>
            <button id="importExcelBtn" title="Import data from an Excel file into a new table">📂 Import Excel</button>
             <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        </div>
        <div class="bar">
            <button id="saveSharedScheduleBtn" title="Save current schedule to the shared Cloud space (also creates a backup)">💠 Save Shared</button>
            <button id="loadSharedScheduleBtn" title="Show list of shared schedules from Cloud to load">☁️ Load Shared</button>
            <button id="restoreBackupBtn" title="Restore a schedule from a backup copy">🛡️ Restore Backup</button>
        </div>
    </div>

    <div id="sharedScheduleListContainer" style="display:none;"></div>
    <div class="bar table-tabs" id="tableTabs"></div>
    <div id="tablesContainer">
        <!-- Original table structure from your file -->
    </div>
    <h3>Teacher/Subject Attendance Summary</h3>
    <div id="summaryTableContainer"><table id="summaryTable"></table></div>

    <!-- NEW: Unified Manager Modal for Teachers and Subjects -->
    <div id="managerModal" class="modal">
        <div class="modal-content" id="managerModalContent">
            <div class="modal-header" id="managerModalHeader">
                <h3 id="managerModalTitle">Shared List Manager</h3>
                <button type="button" class="modal-close-btn" id="closeManagerModalBtn" title="Close manager">×</button>
            </div>
            <div class="manager-tabs">
                <button id="managerPagiTab" data-tab="pagi" class="active">Pagi</button>
                <button id="managerPetangTab" data-tab="petang">Petang</button>
                <button id="managerSubjectsTab" data-tab="subjects">Subjects</button>
            </div>
             <div class="input-group">
                <input id="managerNewItemInput" placeholder="Add new name/subject...">
                <button id="managerAddItemBtn" title="Add item to the selected list">Add</button>
             </div>
            <input type="text" id="managerSearchInput" placeholder="🔍 Search..." title="Filter the list" style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 15px;">
            <div id="managerItemList" class="item-list" style="max-height: 250px; overflow-y: auto;"></div>
            <div id="loadingIndicatorModal" style="display:none;"><div class="spinner"></div></div>
        </div>
    </div>

    <!-- NEW: Subject Groups Modal -->
    <div id="subjectGroupsModal" class="modal">
        <div class="modal-content" id="subjectGroupsModalContent">
            <div class="modal-header" id="subjectGroupsModalHeader">
                <h3>Subject Group Manager</h3>
                <button type="button" class="modal-close-btn" id="closeSubjectGroupsModalBtn" title="Close group manager">×</button>
            </div>
            <div class="input-group">
                <input id="newGroupName" placeholder="Create new group name (e.g., Science Team)">
                <button id="createGroupBtn">Create</button>
            </div>
            <div id="subjectGroupsListContainer" style="max-height: 40vh; overflow-y: auto;"></div>
             <div id="loadingIndicatorGroupsModal" style="display:none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8);"><div class="spinner"></div></div>
        </div>
    </div>

    <div id="customMessageBox" class="custom-message-box"></div>
    <div id="generalLoadingIndicator" style="display:none;"><div class="spinner"></div></div>
</div>
<div id="pdfContent"></div>

<!-- Original Panel and scripts -->
<div id="timetablePanel" class="panel hidden" data-x="0" data-y="0">
  <div class="panel-header" id="timetableHandle">
      ☰ Searchable Timetable
      <button id="closeTimetablePanel" aria-label="Close timetable">×</button>
  </div>
  <iframe id="timetableIframe" src="./timetable.html" loading="lazy" style="width:100%;height:100%;border:none;"></iframe>
  <div id="timetableGrip" class="panel-grip"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, getDoc, deleteDoc, updateDoc, query, serverTimestamp, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config.trim() !== '') {
        try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { firebaseConfig = userProvidedFirebaseConfig; }
    } else { firebaseConfig = userProvidedFirebaseConfig; }
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shared-scheduler-app';

    let fbApp, fbAuth, fbDb;
    let fbUserId = null;
    let fbIsAuthReady = false;
    let unsubscribePagiShared, unsubscribePetangShared, unsubscribeSubjects, unsubscribeGroups;

    try {
        fbApp = initializeApp(firebaseConfig);
        fbAuth = getAuth(fbApp);
        fbDb = getFirestore(fbApp);
    } catch (e) { console.error("CRITICAL Error initializing Firebase:", e); }

    // --- Global Variables ---
    let activeTableId = 'tbl_1';
    let tableCount = 1;
    let selectionMode = false;
    let selectedCells = [];
    let lastClickedCell = null;
    let selectedItemForInsertion = { type: null, name: null }; // MODIFIED
    let currentManagerTab = 'pagi'; // NEW
    
    // Data caches
    let namesPagiShared = [];
    let namesPetangShared = [];
    let subjectsShared = []; // NEW
    let subjectGroupsShared = []; // NEW
    
    let autocompleteSuggestionsDiv = null;
    let activeCellForAutocomplete = null;
    let currentAutocompleteIndex = -1;
    
    // --- UTILITY FUNCTIONS (largely from original) ---
    function showMessage(message, type = 'info', duration = 3000) {
        const customMessageBox = document.getElementById('customMessageBox');
        if (!customMessageBox) return;
        customMessageBox.textContent = message;
        customMessageBox.className = `custom-message-box ${type}`;
        customMessageBox.style.display = 'block';
        setTimeout(() => { if (customMessageBox) customMessageBox.style.display = 'none'; }, duration);
    }
    function customConfirm(message) { return new Promise(resolve => { if(window.confirm(message)) resolve(true); else resolve(false); }); }

    // --- NEW / MODIFIED CORE LOGIC ---

    // MODIFIED: getTextForSummary now understands groups
    function getTextForSummary(cellText) {
        if (typeof cellText !== 'string') return { names: [], subjects: [], groups: [] };
        const mainContent = cellText.split(' // ')[0];
        const words = mainContent.split(/\s+/).filter(word => !word.startsWith('*') && word.trim() !== '');

        const allKnownTeachers = [...namesPagiShared, ...namesPetangShared];
        const allKnownSubjects = subjectsShared.map(s => s);
        
        let names = new Set();
        let subjects = new Set();
        let groupsFound = new Set();

        words.forEach(word => {
            const group = subjectGroupsShared.find(g => g.name === word);
            if (group) {
                groupsFound.add(word);
                group.teachers.forEach(teacher => names.add(teacher));
                if (group.subject) subjects.add(group.subject);
            } else if (allKnownTeachers.includes(word)) {
                names.add(word);
            } else if (allKnownSubjects.includes(word)) {
                subjects.add(word);
            }
        });
        return { names: Array.from(names), subjects: Array.from(subjects), groups: Array.from(groupsFound) };
    }

    // OVERHAULED: Summary table logic to handle expanded groups
    function rebuildAndRenderSummary() {
        const summaryTableElement = document.getElementById('summaryTable');
        if (!summaryTableElement) return;

        let allEntries = [];
        let allNamesInSummary = new Set();
        const tablesContainer = document.getElementById('tablesContainer');

        tablesContainer.querySelectorAll('table:not([data-independent="true"])').forEach(table => {
            const timeSlotHeaderRow = Array.from(table.tHead.rows).find(row => !row.classList.contains('date-header-row'));
            if (!timeSlotHeaderRow) return;
            const headers = Array.from(timeSlotHeaderRow.cells).map(th => th.textContent.trim());

            table.tBodies[0].querySelectorAll('tr').forEach(dataRow => {
                const classId = dataRow.cells[0]?.textContent.trim();
                if (!classId) return;

                Array.from(dataRow.cells).slice(1).forEach((cell, index) => {
                    const cellContent = cell.querySelector('.merged-cell-overlay')?.textContent || cell.textContent;
                    const { names, subjects, groups } = getTextForSummary(cellContent);
                    const time = headers[index + 1];

                    if (names.length > 0) {
                        names.forEach(name => {
                            allNamesInSummary.add(name);
                            allEntries.push({ name, time, classId, subjects, groups });
                        });
                    }
                });
            });
        });
        
        // Build Skeleton
        summaryTableElement.innerHTML = ''; 
        const sortedNames = [...allNamesInSummary].sort();
        let allHeaders = new Set(allEntries.map(e=>e.time));
        const sortedHeaders = Array.from(allHeaders).sort((a, b) => (a||'').localeCompare(b||''));
        const finalHeaders = ['Teacher/Subject', ...sortedHeaders];
        const thead = summaryTableElement.createTHead();
        const headerRow = thead.insertRow();
        finalHeaders.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        const tbody = summaryTableElement.createTBody();
        if (sortedNames.length === 0) {
            const tr = tbody.insertRow();
            const td = tr.insertCell();
            td.colSpan = finalHeaders.length || 1;
            td.textContent = "No teachers or groups scheduled.";
        } else {
            sortedNames.forEach(name => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = name;
                for (let i = 1; i < finalHeaders.length; i++) tr.insertCell();
            });
        }

        // Populate Data
        allEntries.forEach(entry => {
            const row = Array.from(tbody.rows).find(r => r.cells[0].textContent === entry.name);
            if (!row) return;
            const colIndex = finalHeaders.indexOf(entry.time);
            if (colIndex > 0) {
                const cell = row.cells[colIndex];
                const subjectInfo = entry.subjects.length > 0 ? entry.subjects.join(', ') : (entry.groups.join(', ') || 'Task');
                const newContent = `${entry.classId} (${subjectInfo})`;
                if (cell.textContent) {
                    cell.textContent += ` | ${newContent}`;
                    cell.classList.add('highlight-conflict');
                } else {
                    cell.textContent = newContent;
                }
            }
        });
    }
    
    // NEW: Generic Firestore list functions for teachers and subjects
    async function saveListToFirestore(listType, itemsArray) {
        if (!fbDb || !fbIsAuthReady) { showMessage("Firebase not ready.", "error"); return; }
        const uniqueSortedItems = [...new Set(itemsArray.map(n => String(n||'').trim()).filter(n => n))].sort();
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedLists", listType);
        try {
            await setDoc(docRef, { items: uniqueSortedItems, lastUpdatedBy: fbUserId || "anonymous", updatedAt: serverTimestamp() });
            showMessage(`Shared ${listType} list updated.`, "success");
        } catch (error) { showMessage(`Failed to save ${listType} list.`, "error"); }
    }

    async function addItemToFirestoreList(item) {
        const trimmedItem = String(item || '').trim();
        if (!trimmedItem) return;
        
        let currentList;
        if (currentManagerTab === 'pagi') currentList = namesPagiShared;
        else if (currentManagerTab === 'petang') currentList = namesPetangShared;
        else if (currentManagerTab === 'subjects') currentList = subjectsShared;
        else return;

        if (currentList.map(i => String(i).toLowerCase()).includes(trimmedItem.toLowerCase())) {
            showMessage(`"${trimmedItem}" already exists.`, "info"); return;
        }
        const updatedList = [...currentList, trimmedItem];
        await saveListToFirestore(currentManagerTab, updatedList);
        document.getElementById('managerNewItemInput').value = '';
    }

    async function deleteItemFromFirestoreList(itemToDelete) {
        const itemStr = String(itemToDelete || '');
        if (!await customConfirm(`Delete "${itemStr}" from the shared list?`)) return;

        let listType = currentManagerTab;
        let currentList;
        if (listType === 'pagi') currentList = namesPagiShared;
        else if (listType === 'petang') currentList = namesPetangShared;
        else if (listType === 'subjects') currentList = subjectsShared;
        else return;

        const updatedList = currentList.filter(item => String(item || '') !== itemStr);
        await saveListToFirestore(listType, updatedList);
    }
    
    function listenToSharedList(listType, callback) {
        if (!fbDb || !fbIsAuthReady) return () => {};
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedLists", listType);
        return onSnapshot(docRef, (docSnap) => {
            const items = docSnap.exists() ? (docSnap.data().items || []) : [];
            callback(items);
            if (listType === currentManagerTab) renderManagerList();
            rebuildAndRenderSummary();
        });
    }

    // NEW: Firestore functions for Subject Groups
    function listenToSubjectGroups() {
        if (!fbDb || !fbIsAuthReady) return () => {};
        const collRef = collection(fbDb, "artifacts", appId, "public/data/subjectGroups");
        return onSnapshot(query(collRef, orderBy("name")), (snapshot) => {
            subjectGroupsShared = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSubjectGroupsList();
            rebuildAndRenderSummary();
        });
    }
    async function createSubjectGroup(groupName) {
        const trimmedName = groupName.trim();
        if (!trimmedName) return;
        if (subjectGroupsShared.some(g => g.name === trimmedName)) { showMessage(`Group "${trimmedName}" already exists.`, "error"); return; }
        await addDoc(collection(fbDb, "artifacts", appId, "public/data/subjectGroups"), { name: trimmedName, subject: "", teachers: [] });
    }
    async function updateSubjectGroup(groupId, newSubject, newTeachers) {
        await updateDoc(doc(fbDb, "artifacts", appId, "public/data/subjectGroups", groupId), { subject: newSubject, teachers: newTeachers });
    }
    async function deleteSubjectGroup(groupId) {
        await deleteDoc(doc(fbDb, "artifacts", appId, "public/data/subjectGroups", groupId));
    }
    
    // NEW: UI Functions for new modals
    function openManagerModal(tabToOpen) {
        handleManagerTabSwitch(tabToOpen);
        document.getElementById('managerModal').style.display = 'flex';
    }
    function handleManagerTabSwitch(tab) {
        currentManagerTab = tab;
        document.querySelectorAll('.manager-tabs button').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
        renderManagerList();
    }
    function renderManagerList() {
        const itemListContainer = document.getElementById('managerItemList');
        let itemsToRender;
        if (currentManagerTab === 'pagi') itemsToRender = namesPagiShared;
        else if (currentManagerTab === 'petang') itemsToRender = namesPetangShared;
        else if (currentManagerTab === 'subjects') itemsToRender = subjectsShared;
        
        itemListContainer.innerHTML = '';
        itemsToRender.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            itemDiv.innerHTML = `<span data-name="${item}">${item}</span><button class="delete-item-btn" data-name-delete="${item}">Delete</button>`;
            itemListContainer.appendChild(itemDiv);
        });
        highlightSelectedItemInList();
    }
    function renderSubjectGroupsList() {
        const container = document.getElementById('subjectGroupsListContainer');
        container.innerHTML = '';
        subjectGroupsShared.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'subject-group-item';
            let subjectOptions = '<option value="">-- Select Subject --</option>' + subjectsShared.map(s => `<option value="${s}" ${group.subject === s ? 'selected' : ''}>${s}</option>`).join('');
            let teacherCheckboxes = '<h4>Teachers</h4>' + [...namesPagiShared, ...namesPetangShared].sort().map(t => `<label><input type="checkbox" value="${t}" ${group.teachers.includes(t) ? 'checked' : ''}> ${t}</label>`).join('');
            groupDiv.innerHTML = `
                <div class="group-header"><h4>${group.name}</h4><button class="delete-item-btn" data-group-id="${group.id}">Delete</button></div>
                <label>Subject:</label><select class="group-subject-select" data-group-id="${group.id}">${subjectOptions}</select>
                <div class="group-teachers-list">${teacherCheckboxes}</div>
                <button class="save-group-changes-btn" data-group-id="${group.id}">Save Changes</button>`;
            container.appendChild(groupDiv);
        });
    }

    // MODIFIED: Autocomplete now suggests teachers, subjects, and groups
    function showCellAutocompleteSuggestions(cell, inputText) {
        if (!autocompleteSuggestionsDiv) return;
        const textForMatching = inputText.split(' // ')[0].toLowerCase().trim();
        if (!textForMatching) { hideCellAutocompleteSuggestions(); return; }

        const allSuggestions = [
            ...subjectGroupsShared.map(g => g.name),
            ...subjectsShared,
            ...namesPagiShared,
            ...namesPetangShared
        ].filter(n => n.toLowerCase().startsWith(textForMatching));

        if (allSuggestions.length > 0) {
            activeCellForAutocomplete = cell;
            autocompleteSuggestionsDiv.innerHTML = '';
            [...new Set(allSuggestions)].slice(0, 10).forEach(suggestion => {
                const item = document.createElement('div'); item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.addEventListener('mousedown', (e) => { e.preventDefault(); selectCellAutocompleteSuggestion(suggestion); });
                autocompleteSuggestionsDiv.appendChild(item);
            });
            const cellRect = cell.getBoundingClientRect();
            autocompleteSuggestionsDiv.style.left = `${cellRect.left + window.scrollX}px`;
            autocompleteSuggestionsDiv.style.top = `${cellRect.bottom + window.scrollY}px`;
            autocompleteSuggestionsDiv.style.display = 'block';
        } else { hideCellAutocompleteSuggestions(); }
    }
    function hideCellAutocompleteSuggestions() { if (autocompleteSuggestionsDiv) autocompleteSuggestionsDiv.style.display = 'none'; }
    function selectCellAutocompleteSuggestion(suggestion) {
        if (!activeCellForAutocomplete) return;
        const target = activeCellForAutocomplete.querySelector('.merged-cell-overlay') || activeCellForAutocomplete;
        target.textContent = suggestion + (target.textContent.includes(' // ') ? target.textContent.substring(target.textContent.indexOf(' // ')) : '');
        hideCellAutocompleteSuggestions();
        rebuildAndRenderSummary();
    }
    
    // MODIFIED: More generic item selection
    function selectItemForCellInsertion(type, name) {
        selectedItemForInsertion = { type, name: String(name || '') };
        highlightSelectedItemInList();
        showMessage(`Selected "${name}". Click cell to insert.`, 'info');
    }
    function clearItemSelection() {
        selectedItemForInsertion = { type: null, name: null };
        highlightSelectedItemInList();
    }
    function highlightSelectedItemInList() {
        const listContainer = document.getElementById('managerItemList');
        if (!listContainer) return;
        listContainer.querySelectorAll('.item span').forEach(span => {
            span.classList.toggle('highlighted', span.dataset.name === selectedItemForInsertion.name);
        });
    }
    
    // --- Original functions from your script (minor adaptations if needed) ---
    // (All other functions like table manipulation, PDF export, etc. are kept from your original file)
    function switchTable(id) { /* ... original code ... */ }
    function addNewTable(isInitial = false) { /* ... original code ... */ }
    // ... all other functions from your provided file ...
    function initializeEventListeners() {
        // ... all original event listeners ...
        
        // NEW LISTENERS
        document.getElementById('nameListBtn').addEventListener('click', () => openManagerModal('pagi'));
        document.getElementById('subjectListBtn')?.addEventListener('click', () => openManagerModal('subjects')); // This button needs to be added to HTML
        document.getElementById('subjectGroupsBtn').addEventListener('click', () => document.getElementById('subjectGroupsModal').style.display = 'flex');

        document.getElementById('closeManagerModalBtn').addEventListener('click', () => document.getElementById('managerModal').style.display = 'none');
        document.getElementById('managerPagiTab').addEventListener('click', () => handleManagerTabSwitch('pagi'));
        document.getElementById('managerPetangTab').addEventListener('click', () => handleManagerTabSwitch('petang'));
        document.getElementById('managerSubjectsTab').addEventListener('click', () => handleManagerTabSwitch('subjects'));
        document.getElementById('managerAddItemBtn').addEventListener('click', () => addItemToFirestoreList(document.getElementById('managerNewItemInput').value));
        document.getElementById('managerItemList').addEventListener('click', e => {
            const span = e.target.closest('.item span[data-name]');
            const button = e.target.closest('.delete-item-btn[data-name-delete]');
            if (span) selectItemForCellInsertion(currentManagerTab, span.dataset.name);
            else if (button) deleteItemFromFirestoreList(button.dataset.nameDelete);
        });

        document.getElementById('closeSubjectGroupsModalBtn').addEventListener('click', () => document.getElementById('subjectGroupsModal').style.display = 'none');
        document.getElementById('createGroupBtn').addEventListener('click', () => createSubjectGroup(document.getElementById('newGroupName').value));
        document.getElementById('subjectGroupsListContainer').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-item-btn[data-group-id]');
            const saveBtn = e.target.closest('.save-group-changes-btn[data-group-id]');
            if (deleteBtn) deleteSubjectGroup(deleteBtn.dataset.groupId);
            if (saveBtn) {
                const groupId = saveBtn.dataset.groupId;
                const groupItem = saveBtn.closest('.subject-group-item');
                const subject = groupItem.querySelector('.group-subject-select').value;
                const teachers = Array.from(groupItem.querySelectorAll('.group-teachers-list input:checked')).map(cb => cb.value);
                updateSubjectGroup(groupId, subject, teachers);
            }
        });

        // MODIFIED: Original table click listener to handle generic item insertion
        document.getElementById('tablesContainer').addEventListener('click', (e) => {
            const cell = e.target.closest('td, th');
            if (!cell) return;
            lastClickedCell = cell;
            if (selectedItemForInsertion.name && (cell.tagName === 'TD' || cell.closest('tbody'))) {
                const target = cell.querySelector('.merged-cell-overlay') || cell;
                const currentText = target.textContent;
                const remarkPart = currentText.includes(' // ') ? currentText.substring(currentText.indexOf(' // ')) : '';
                target.textContent = selectedItemForInsertion.name + " " + remarkPart; // Add space
                rebuildAndRenderSummary();
                clearItemSelection();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // ... original DOMContentLoaded setup ...
        autocompleteSuggestionsDiv = document.createElement('div');
        autocompleteSuggestionsDiv.id = 'autocompleteSuggestions';
        document.body.appendChild(autocompleteSuggestionsDiv);
        
        // This replaces the old name modal logic from your original file
        document.getElementById('nameListBtn').textContent = '👥 Lists';
        // You'll need to manually add the #subjectListBtn button in the HTML if you want it separate. 
        // For now, I've combined it into the "Lists" manager.

        // Firebase Auth Listener
        onAuthStateChanged(fbAuth, async (user) => {
            if (user) {
                fbUserId = user.uid;
                fbIsAuthReady = true;
                document.getElementById('userIdDisplay').textContent = `User ID: ${fbUserId}`;
                
                unsubscribePagiShared?.();
                unsubscribePetangShared?.();
                unsubscribeSubjects?.();
                unsubscribeGroups?.();

                unsubscribePagiShared = listenToSharedList('pagi', (items) => namesPagiShared = items);
                unsubscribePetangShared = listenToSharedList('petang', (items) => namesPetangShared = items);
                unsubscribeSubjects = listenToSharedList('subjects', (items) => subjectsShared = items);
                unsubscribeGroups = listenToSubjectGroups();

                // ... rest of original auth logic ...

            } else {
                // ... original anonymous sign-in logic ...
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(fbAuth, __initial_auth_token);
                    } else { await signInAnonymously(fbAuth); }
                } catch (error) { console.error("Auth Error:", error); }
            }
        });
        
        // Initialize other parts of the application
        initializeEventListeners();
    });

</script>
<!-- All other original script tags from your file should be kept -->
</body>
</html>

