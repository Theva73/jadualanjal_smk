<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Schedule Planner - Master Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Generation Libraries with defer to ensure order -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
    // Ensure jsPDF and autoTable are attached properly
    window.addEventListener("load", () => {
        if (window.jspdf && window.jspdf.jsPDF) {
            const { jsPDF } = window.jspdf;
            if (typeof jsPDF.prototype.autoTable !== "function" && window.jspdfAutoTable) {
                jsPDF.prototype.autoTable = window.jspdfAutoTable;
            }
        }
    });
</script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        select:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .sticky-header { position: -webkit-sticky; position: sticky; top: 0; z-index: 10; }
        .sticky-left { position: -webkit-sticky; position: sticky; left: 0; z-index: 5; background-color: #fff; }
        thead.sticky-header .sticky-left { z-index: 11; }


        /* Toggle Switch Styles */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        
        /* Error Highlighting Styles */
        .error-clash { background-color: #fee2e2 !important; border: 1px solid #f87171; }
        .error-warning { background-color: #fef9c3 !important; border: 1px solid #fde047; }
        .error-icon { display: inline-block; margin-left: 4px; color: #b91c1c; }
        .warning-icon { display: inline-block; margin-left: 4px; color: #a16207; }

    </style>
</head>
<body class="p-2 sm:p-4">
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg">
    <header class="mb-6 border-b pb-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">School Schedule Planner</h1>
        <p class="text-sm text-gray-500 mt-1">Manage multiple schedule playlists.</p>
    </header>

    <!-- Tab Navigation & Global Actions -->
    <div class="mb-6 flex flex-wrap justify-between items-center border-b border-gray-200 pb-2 gap-4">
        <nav class="flex flex-wrap space-x-2 sm:space-x-4">
            <button id="tab-schedule" class="tab-btn px-3 py-2 font-medium text-sm rounded-md active">Schedule</button>
            <button id="tab-management" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Management</button>
            <button id="tab-playlists" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Playlists</button>
            <button id="tab-summary" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Summary</button>
        </nav>
        <button id="download-pdf-btn" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            Download Schedule
        </button>
    </div>

    <!-- Tab Content -->
    <div id="tab-content-schedule" class="tab-panel">
        <div id="schedule-view" class="overflow-x-auto">
            <p id="schedule-placeholder" class="text-gray-500 py-8 text-center">Loading schedule...</p>
        </div>
    </div>

    <div id="tab-content-management" class="tab-panel hidden">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">1. Manage Classes</h3>
                <form id="add-class-form" class="flex gap-2 mb-3"><input type="text" id="class-name" placeholder="e.g., 5 Sains 1" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="class-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">2. Manage Teachers</h3>
                <form id="add-teacher-form" class="flex gap-2 mb-3"><input type="text" id="teacher-name" placeholder="Teacher's name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="teacher-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>

             <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">3. Manage Locations</h3>
                <form id="add-location-form" class="flex gap-2 mb-3"><input type="text" id="location-name" placeholder="e.g., Lab A, Hall B" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="location-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg md:col-span-2">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">4. Manage Subjects, Classes, and Teachers</h3>
                <p class="text-sm text-gray-600 mb-4">Add new subjects, then assign them to classes and teachers.</p>
                <form id="add-subject-form" class="flex gap-2 mb-3"><input type="text" id="subject-name" placeholder="New subject name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add Subject</button></form>
                <div id="subject-management-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
        <div class="mt-6 border-t pt-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">5. Manage Time Slots</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-700">Add New Time Slot</h4>
                    <form id="add-timeslot-form" class="space-y-3">
                        <div class="flex gap-2 items-center">
                            <input type="time" id="timeslot-start" class="w-full p-2 text-sm border rounded-md" required>
                            <span>-</span>
                            <input type="time" id="timeslot-end" class="w-full p-2 text-sm border rounded-md" required>
                        </div>
                        <div class="flex items-center">
                            <input id="timeslot-is-break" type="checkbox" class="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="timeslot-is-break" class="ml-2 block text-sm text-gray-900">Mark as a break time</label>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add Time Slot</button>
                    </form>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-700">Current Time Slots</h4>
                    <div id="timeslot-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tab-content-playlists" class="tab-panel hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Manage Schedule Playlists</h2>
        <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3 text-gray-800">Create New Playlist</h3>
            <form id="add-playlist-form" class="flex items-center gap-2 mb-4">
                <input type="text" id="playlist-name" placeholder="e.g., Final Term 1" class="flex-grow p-2 text-sm border rounded-md" required>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Save Current Schedule
                </button>
            </form>
            <h3 class="text-lg font-semibold mb-3 text-gray-800">Saved Playlists</h3>
            <div id="playlist-list" class="space-y-2">
                <p class="text-sm text-gray-500">No playlists saved yet.</p>
            </div>
        </div>
    </div>

    <div id="tab-content-summary" class="tab-panel hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 id="summary-title" class="text-xl font-semibold text-gray-800">Teacher Schedule Summary</h2>
            <div class="flex items-center space-x-3">
                <span class="text-sm font-medium text-gray-700">View by Subject</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="summary-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="summary-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
                <span class="text-sm font-medium text-gray-700">View by Teacher</span>
            </div>
        </div>
        <div id="summary-grid" class="overflow-x-auto"></div>
    </div>
</div>

<!-- Modals -->
<div id="modal-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setDoc, updateDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };
    
    let db, auth, userId;
    let teachers = {}, subjects = {}, schedule = {}, classes = {}, locations = {}, timeslots = {}, playlists = {};
    let summaryViewMode = 'teacher'; // 'teacher' or 'subject'

    const DAYS = ["ISNIN", "SELASA", "RABU", "KHAMIS", "JUMAAT"];
    const getPath = (collectionName) => `scheduler_v2_${collectionName}`;

    function getSortedTimeSlots() {
        if (!timeslots || Object.keys(timeslots).length === 0) return [];
        return Object.values(timeslots).sort((a, b) => a.start.localeCompare(b.start));
    }

    function renderAll() {
        renderClasses();
        renderTeachers();
        renderLocations();
        renderSubjectManagementList();
        renderTimeSlots();
        renderPlaylists();
        renderAllSchedules();
        renderSummaryGrid();
    }

    // --- Data Rendering Functions ---
    function renderClasses() {
        const classListDiv = document.getElementById('class-list');
        classListDiv.innerHTML = Object.keys(classes).length ? Object.entries(classes).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, cls]) => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${cls.name}</span>
                <div class="flex gap-2">
                    <button data-id="${id}" data-name="${cls.name}" data-collection="classes" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${id}" class="delete-class text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No classes found.</p>`;
    }
    
    function renderTeachers() {
        const teacherListDiv = document.getElementById('teacher-list');
        const teacherArray = Object.values(teachers);
        teacherListDiv.innerHTML = teacherArray.length ? teacherArray.sort((a,b) => a.name.localeCompare(b.name)).map(teacher => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${teacher.name}</span>
                 <div class="flex gap-2">
                    <button data-id="${teacher.id}" data-name="${teacher.name}" data-collection="teachers" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${teacher.id}" class="delete-teacher text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No teachers added yet.</p>`;
    }

    function renderLocations() {
        const locationListDiv = document.getElementById('location-list');
        const locationArray = Object.values(locations);
        locationListDiv.innerHTML = locationArray.length ? locationArray.sort((a, b) => a.name.localeCompare(b.name)).map(location => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${location.name}</span>
                 <div class="flex gap-2">
                    <button data-id="${location.id}" data-name="${location.name}" data-collection="locations" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${location.id}" class="delete-location text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No locations added yet.</p>`;
    }

    function renderSubjectManagementList() {
        const container = document.getElementById('subject-management-list');
        if (!container) return;

        container.innerHTML = Object.keys(subjects).length > 0
            ? Object.values(subjects).sort((a,b) => a.name.localeCompare(b.name)).map(sub => {
                const classNames = Object.values(classes)
                    .filter(cls => cls.subjectIds?.includes(sub.id))
                    .map(cls => cls.name)
                    .join(', ') || 'None assigned';
                const teacherNames = sub.teacherIds?.map(tid => teachers[tid]?.name).filter(Boolean).join(', ') || 'None assigned';

                return `
                <div class="p-3 bg-white rounded-md shadow-sm">
                    <div class="flex justify-between items-center flex-wrap gap-y-2">
                        <span class="font-semibold text-gray-800">${sub.name}</span>
                        <div class="flex gap-2 flex-shrink-0">
                            <button data-id="${sub.id}" data-name="${sub.name}" data-collection="subjects" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                            <button data-id="${sub.id}" class="assign-classes-btn bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs">ASSIGN CLASSES</button>
                            <button data-id="${sub.id}" class="assign-teachers-btn bg-green-100 text-green-700 px-2 py-1 rounded text-xs">ASSIGN TEACHERS</button>
                            <button data-id="${sub.id}" class="delete-subject text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 truncate" title="${classNames}">Classes: ${classNames}</p>
                    <p class="text-xs text-gray-500 mt-1 truncate" title="${teacherNames}">Teachers: ${teacherNames}</p>
                </div>`;
            }).join('')
            : `<p class="text-sm text-gray-500">Create a subject to begin.</p>`;
    }

    function renderTimeSlots() {
        const listDiv = document.getElementById('timeslot-list');
        const sortedTimeSlots = getSortedTimeSlots();
        listDiv.innerHTML = sortedTimeSlots.length ? sortedTimeSlots.map(slot => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <div>
                    <span class="font-semibold">${slot.start} - ${slot.end}</span>
                    ${slot.isBreak ? '<span class="ml-2 text-xs font-semibold text-green-700 bg-green-100 px-2 py-0.5 rounded-full">Break</span>' : ''}
                </div>
                <div class="flex gap-2">
                    <button data-id="${slot.id}" class="edit-timeslot text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${slot.id}" class="delete-timeslot text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No time slots defined.</p>`;
    }

    function renderPlaylists() {
        const playlistListDiv = document.getElementById('playlist-list');
        playlistListDiv.innerHTML = Object.keys(playlists).length ? Object.entries(playlists).sort(([, a], [, b]) => b.createdAt - a.createdAt).map(([id, playlist]) => `
            <div class="flex justify-between items-center p-3 bg-white rounded-md shadow-sm">
                <div>
                    <span class="font-semibold text-gray-800">${playlist.name}</span>
                    <p class="text-xs text-gray-500">Saved on: ${new Date(playlist.createdAt).toLocaleString()}</p>
                </div>
                <div class="flex gap-2">
                    <button data-id="${id}" class="load-playlist bg-green-100 text-green-700 px-3 py-1.5 rounded text-xs font-semibold hover:bg-green-200">LOAD</button>
                    <button data-id="${id}" class="delete-playlist text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No playlists saved yet.</p>`;
    }
    
    function renderAllSchedules() {
        const scheduleView = document.getElementById('schedule-view');
        const sortedTimeSlots = getSortedTimeSlots();

        if (sortedTimeSlots.length === 0) {
            scheduleView.innerHTML = '<p id="schedule-placeholder" class="text-gray-500 py-8 text-center">Please define time slots in the Management tab first.</p>';
            return;
        }

        const timeHeaders = sortedTimeSlots.map(slot => `<th class="px-2 py-2 text-sm font-medium text-gray-600 border whitespace-nowrap">${slot.start}-${slot.end}</th>`).join('');
        
        const dayRows = DAYS.map(day => {
            const timeCells = sortedTimeSlots.map(slot => {
                 const time = `${slot.start}-${slot.end}`;
                if (slot.isBreak) {
                    return `<td class="p-1 border align-middle text-center bg-green-50 text-green-700 font-semibold text-xs">Rehat</td>`;
                }

                const slotId = `${day}_${time}`;
                const entries = Object.values(schedule).filter(e => e.slotId === slotId);

                const entryCards = entries.map(entry => {
                    const subjectNames = entry.subjectIds?.map(sid => subjects[sid]?.name).filter(Boolean).join(', ') || 'No Subject';
                    const teacherNames = entry.subjectIds?.flatMap(sid => subjects[sid]?.teacherIds || [])
                        .map(tid => teachers[tid]?.name)
                        .filter(Boolean).join(', ');
                    const locationName = locations[entry.locationId]?.name || '';
                    
                    return `
                        <div class="p-1.5 rounded border border-gray-200 bg-white mb-1 cursor-pointer hover:bg-indigo-50 edit-entry-btn" data-doc-id="${entry.id}">
                            <p class="font-semibold text-xs text-gray-800">${subjectNames}</p>
                            <p class="text-xs text-gray-500">${teacherNames}</p>
                            <p class="text-xs text-indigo-500">${locationName}</p>
                        </div>
                    `;
                }).join('');

                return `<td class="p-1 border align-top min-w-[200px]">
                    ${entryCards}
                    <button class="add-entry-btn w-full p-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 mt-1" data-day="${day}" data-time="${time}">+ Add Entry</button>
                </td>`;
            }).join('');

            const isLastDay = DAYS.indexOf(day) === DAYS.length - 1;
            // Add a thick border to all day rows except the last one for clear separation.
            const rowClass = isLastDay ? '' : 'border-b-4 border-slate-300';

            return `<tr class="${rowClass}">
                <td class="px-2 py-2 text-sm border font-bold text-gray-700 bg-gray-50 sticky-left">${day}</td>
                ${timeCells}
            </tr>`;
        }).join('');

        scheduleView.innerHTML = `
            <table class="min-w-full border-collapse">
                <thead class="bg-gray-100 sticky-header">
                    <tr>
                        <th class="px-2 py-2 text-sm font-semibold text-gray-600 border sticky-left bg-gray-100" style="z-index: 11;">Day</th>
                        ${timeHeaders}
                    </tr>
                </thead>
                <tbody>${dayRows}</tbody>
            </table>`;
    }

    function analyzeScheduleForErrors() {
        const errors = {};
        const teacherSlotUsage = {}; // Tracks { 'teacherId_slotId': [entry1, entry2], ... }

        // 1. Populate teacher usage and check for empty schedule entries
        for (const entry of Object.values(schedule)) {
            if (!entry.subjectIds || entry.subjectIds.length === 0) {
                errors[entry.slotId] = { type: 'clash', message: 'This schedule entry is empty and has no subjects assigned.' };
                continue;
            }

            const teachersInEntry = entry.subjectIds.flatMap(sid => subjects[sid]?.teacherIds || []);
            for (const teacherId of teachersInEntry) {
                const key = `${teacherId}_${entry.slotId}`;
                if (!teacherSlotUsage[key]) teacherSlotUsage[key] = [];
                teacherSlotUsage[key].push(entry);
            }
        }

        // 2. Check for teacher clashes
        for (const [key, entries] of Object.entries(teacherSlotUsage)) {
            if (entries.length > 1) {
                const subjectNames = entries.map(e => e.subjectIds.map(sid => subjects[sid]?.name).join(', ')).join(' & ');
                errors[key] = { type: 'clash', message: `CLASH: This teacher is double-booked for subjects: ${subjectNames}.` };
            }
        }
        
        // 3. Check for subjects with no teachers (will be checked during render)
        return errors;
    }


    function renderSummaryGrid() {
        const summaryDiv = document.getElementById('summary-grid');
        const sortedTimeSlots = getSortedTimeSlots();
        const errors = analyzeScheduleForErrors();
        
        if (summaryViewMode === 'teacher') {
            renderTeacherSummaryGrid(summaryDiv, sortedTimeSlots, errors);
        } else {
            renderSubjectSummaryGrid(summaryDiv, sortedTimeSlots, errors);
        }
    }

    function renderTeacherSummaryGrid(container, sortedTimeSlots, errors) {
        document.getElementById('summary-title').textContent = "Teacher Schedule Summary";
        const sortedTeachers = Object.values(teachers).sort((a, b) => a.name.localeCompare(b.name));

        if (sortedTeachers.length === 0 || sortedTimeSlots.length === 0) {
            container.innerHTML = `<p class="text-gray-500 py-8 text-center">No teachers or time slots to display.</p>`;
            return;
        }

        const buildGrid = (rowsData, rowTitle) => {
            const dayHeaders = DAYS.map(day => `<th colspan="${sortedTimeSlots.length}" class="p-2 border font-semibold text-center">${day}</th>`).join('');
            const timeSubheaders = sortedTimeSlots.map(slot => `<th class="p-2 border font-semibold whitespace-nowrap">${slot.start}-${slot.end}</th>`).join('');
            
            const rows = rowsData.map(item => {
                const dayCells = DAYS.map(day => {
                    return sortedTimeSlots.map(slot => {
                        if (slot.isBreak) return `<td class="p-1 border bg-green-50"></td>`;
                        const slotId = `${day}_${slot.start}-${slot.end}`;
                        const entry = Object.values(schedule).find(e => e.slotId === slotId && e.subjectIds?.some(sid => subjects[sid]?.teacherIds?.includes(item.id)));
                        
                        let cellContent = '';
                        let cellClass = '';
                        let cellTitle = '';
                        
                        const errorKey = `${item.id}_${slotId}`;
                        if (errors[errorKey]) {
                            cellClass = 'error-clash';
                            cellTitle = errors[errorKey].message;
                            cellContent += `<span class="error-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></span>`;
                        }

                        if (entry) {
                            const subjectNames = entry.subjectIds.map(sid => subjects[sid]?.name).join(', ');
                            const locationName = locations[entry.locationId]?.name || '';
                            const classNames = Object.values(classes).filter(cls => cls.subjectIds?.some(subId => entry.subjectIds.includes(subId))).map(cls => cls.name).join(', ');
                            cellContent += `<p class="font-semibold">${subjectNames}</p><p class="text-gray-600">${classNames}</p><p class="text-indigo-600">${locationName}</p>`;
                        }
                        
                        return `<td class="p-2 border align-middle text-center text-xs ${cellClass}" title="${cellTitle}">${cellContent}</td>`;
                    }).join('');
                }).join('');
                return `<tr class="even:bg-gray-50"><td class="p-2 border font-bold sticky left-0 z-10" style="background-color: inherit;">${item.name}</td>${dayCells}</tr>`;
            }).join('');

            container.innerHTML = `<table class="min-w-full border-collapse text-xs"><thead><tr class="bg-gray-100"><th rowspan="2" class="p-2 border font-semibold sticky left-0 bg-gray-100 z-20">${rowTitle}</th>${dayHeaders}</tr><tr class="bg-gray-100">${DAYS.map(() => timeSubheaders).join('')}</tr></thead><tbody>${rows}</tbody></table>`;
        };
        
        buildGrid(sortedTeachers, 'Teacher');
    }
    
    function renderSubjectSummaryGrid(container, sortedTimeSlots, errors) {
        document.getElementById('summary-title').textContent = "Subject Schedule Summary";
        const sortedSubjects = Object.values(subjects).sort((a, b) => a.name.localeCompare(b.name));

        if (sortedSubjects.length === 0 || sortedTimeSlots.length === 0) {
            container.innerHTML = `<p class="text-gray-500 py-8 text-center">No subjects or time slots to display.</p>`;
            return;
        }
        
        const buildGrid = (rowsData, rowTitle) => {
            const dayHeaders = DAYS.map(day => `<th colspan="${sortedTimeSlots.length}" class="p-2 border font-semibold text-center">${day}</th>`).join('');
            const timeSubheaders = sortedTimeSlots.map(slot => `<th class="p-2 border font-semibold whitespace-nowrap">${slot.start}-${slot.end}</th>`).join('');
            
            const rows = rowsData.map(item => {
                const dayCells = DAYS.map(day => {
                    return sortedTimeSlots.map(slot => {
                        if (slot.isBreak) return `<td class="p-1 border bg-green-50"></td>`;
                        const slotId = `${day}_${slot.start}-${slot.end}`;
                        const entry = Object.values(schedule).find(e => e.slotId === slotId && e.subjectIds?.includes(item.id));
                        
                        let cellContent = '';
                        let cellClass = '';
                        let cellTitle = '';
                        
                        if (!item.teacherIds || item.teacherIds.length === 0) {
                            cellClass = 'error-warning';
                            cellTitle = 'WARNING: No teacher is assigned to this subject.';
                            cellContent += `<span class="warning-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></span>`;
                        }

                        if (entry) {
                            const teacherNames = item.teacherIds?.map(tid => teachers[tid]?.name).join(', ') || 'N/A';
                            const locationName = locations[entry.locationId]?.name || '';
                            const classNames = Object.values(classes).filter(cls => cls.subjectIds?.includes(item.id)).map(cls => cls.name).join(', ');
                            cellContent += `<p class="font-semibold">${teacherNames}</p><p class="text-gray-600">${classNames}</p><p class="text-indigo-600">${locationName}</p>`;
                        }
                        
                        return `<td class="p-2 border align-middle text-center text-xs ${cellClass}" title="${cellTitle}">${cellContent}</td>`;
                    }).join('');
                }).join('');
                return `<tr class="even:bg-gray-50"><td class="p-2 border font-bold sticky left-0 z-10" style="background-color: inherit;">${item.name}</td>${dayCells}</tr>`;
            }).join('');

            container.innerHTML = `<table class="min-w-full border-collapse text-xs"><thead><tr class="bg-gray-100"><th rowspan="2" class="p-2 border font-semibold sticky left-0 bg-gray-100 z-20">${rowTitle}</th>${dayHeaders}</tr><tr class="bg-gray-100">${DAYS.map(() => timeSubheaders).join('')}</tr></thead><tbody>${rows}</tbody></table>`;
        };
        
        buildGrid(sortedSubjects, 'Subject');
    }


    // --- Core Logic Functions ---
    function generateMasterSchedulePDF() {
        try {
            // Check if the main jspdf library is loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                showToast("Error: PDF library not ready. Please wait a moment and try again.");
                console.error("jsPDF library is missing from the window object.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            // Fallback: try to attach plugin if only API path exists
            if (typeof doc.autoTable !== 'function' && window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && typeof window.jspdf.jsPDF.API.autoTable === 'function') {
                doc.autoTable = window.jspdf.jsPDF.API.autoTable.bind(doc);
            }


            // Check if the autoTable plugin is attached
            if (typeof doc.autoTable !== 'function') {
                showToast("Error: PDF Table plugin not ready. Please wait a moment and try again.");
                console.error("jsPDF-AutoTable plugin is not attached to jsPDF prototype.");
                return;
            }

            if (Object.keys(classes).length === 0 || Object.keys(timeslots).length === 0) {
                showToast("Please define classes and time slots before generating a PDF.");
                return;
            }

            DAYS.forEach((day, index) => {
                if (index > 0) doc.addPage();

                const dayTitle = day.charAt(0).toUpperCase() + day.slice(1).toLowerCase();
                doc.setFontSize(18);
                doc.text('Jadual Waktu Kelas', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(14);
                doc.text(dayTitle, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });

                const sortedClasses = Object.values(classes).sort((a, b) => a.name.localeCompare(b.name));
                const sortedTimeSlots = getSortedTimeSlots();
                
                const head = [['Kelas/Masa', ...sortedTimeSlots.map(slot => `${slot.start} - ${slot.end}`)]];
                const body = sortedClasses.map(cls => {
                    const row = [cls.name];
                    sortedTimeSlots.forEach(slot => {
                        if (slot.isBreak) {
                            row.push('REHAT');
                            return;
                        }

                        const slotId = `${day}_${slot.start}-${slot.end}`;
                        const classSubjects = cls.subjectIds || [];
                        const entriesInSlot = Object.values(schedule).filter(e => e.slotId === slotId);
                        let cellContent = '';

                        for (const entry of entriesInSlot) {
                            const matchingSubjectId = entry.subjectIds.find(sid => classSubjects.includes(sid));
                            if (matchingSubjectId) {
                                const subject = subjects[matchingSubjectId];
                                const teacherNames = subject.teacherIds?.map(tid => teachers[tid]?.name).filter(Boolean).join(',\n') || '';
                                cellContent = teacherNames;
                                break; 
                            }
                        }
                        row.push(cellContent);
                    });
                    return row;
                });

                const breakColumnIndex = sortedTimeSlots.findIndex(slot => slot.isBreak);
                
                doc.autoTable({
                    head: head,
                    body: body,
                    startY: 28,
                    theme: 'grid',
                    headStyles: { fillColor: [45, 55, 72], textColor: 255, fontStyle: 'bold', halign: 'center' },
                    styles: {
                        cellPadding: 1.5,
                        fontSize: 7,
                        valign: 'middle',
                        halign: 'center',
                        lineWidth: 0.1,
                        lineColor: [150, 150, 150]
                    },
                    columnStyles: { 0: { fontStyle: 'bold', halign: 'left', minCellWidth: 25 } },
                    didParseCell: (data) => {
                        if (data.column.index === breakColumnIndex + 1 && data.cell.raw === 'REHAT') {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 8;
                            data.cell.text = 'R\nE\nH\nA\nT';
                        }
                    }
                });

                 const pageCount = doc.internal.getNumberOfPages();
                 doc.setPage(pageCount);
                 doc.setFontSize(8);
                 doc.setTextColor(150);
                 doc.text(
                     `Generated: ${new Date().toLocaleString()}`,
                     doc.internal.pageSize.getWidth() - 14,
                     doc.internal.pageSize.getHeight() - 7,
                     { align: 'right' }
                 );

            });

            doc.save(`Jadual_Penuh_Mingguan_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("Failed to generate PDF:", error);
            showToast("An unexpected error occurred while generating the PDF.");
        }
    }

    async function handleScheduleEntrySave(e) {
        e.preventDefault();
        const form = e.target;
        const day = form.querySelector('#modal-entry-day').value;
        const time = form.querySelector('#modal-entry-time').value;
        const locationId = form.querySelector('#modal-entry-location').value;
        const docId = form.querySelector('#modal-entry-doc-id').value;
        const selectedSubjectIds = Array.from(form.querySelectorAll('input[name="subject"]:checked')).map(el => el.value);

        if (selectedSubjectIds.length === 0) {
            showToast("Please select at least one subject.");
            return;
        }

        let clashFound = false;
        let clashDetails = [];
        const newTeachers = selectedSubjectIds.flatMap(sid => subjects[sid]?.teacherIds || []).filter((v, i, a) => a.indexOf(v) === i);

        if (newTeachers.length > 0) {
            const q = query(collection(db, getPath('schedule')), where("day", "==", day), where("time", "==", time));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(docSnap => {
                const entry = docSnap.data();
                if (docSnap.id === docId) return; 

                const scheduledSubjectIds = entry.subjectIds || [];
                const scheduledTeachers = scheduledSubjectIds.flatMap(sid => subjects[sid]?.teacherIds || []).filter(Boolean);
                const intersection = newTeachers.filter(tid => scheduledTeachers.includes(tid));

                if (intersection.length > 0) {
                    clashFound = true;
                    const teacherNames = intersection.map(tid => teachers[tid]?.name).join(', ');
                    clashDetails.push(`Teacher Clash: ${teacherNames} already scheduled at this time.`);
                }
            });
        }
        
        if (clashFound) {
            openConfirmationModal(
                "Scheduling Clash Detected!",
                `Details:\n- ${[...new Set(clashDetails)].join('\n- ')}\n\nDo you want to proceed with this assignment anyway?`,
                "Proceed Anyway",
                () => {
                    saveScheduleEntry({ day, time, locationId, subjectIds: selectedSubjectIds, docId, proceededWithClash: true });
                },
                true
            );
        } else {
            await saveScheduleEntry({ day, time, locationId, subjectIds: selectedSubjectIds, docId, proceededWithClash: false });
        }

        toggleModal('schedule-entry-modal', false);
    }

    async function saveScheduleEntry({ day, time, locationId, subjectIds, docId, proceededWithClash }) {
        const slotId = `${day}_${time}`;
        const schedulePath = getPath('schedule');

        const data = {
            day, time, slotId,
            locationId: locationId || null,
            subjectIds: subjectIds || [],
            proceededWithClash: proceededWithClash || false
        };

        const docRef = docId ? doc(db, schedulePath, docId) : doc(collection(db, schedulePath));
        await setDoc(docRef, data, { merge: true });
    }

    async function savePlaylist(name) {
        if (!name) return;
        const playlistData = { name, createdAt: Date.now(), data: { classes, teachers, subjects, locations, schedule, timeslots } };
        await addDoc(collection(db, getPath('playlists')), playlistData);
    }

    async function loadPlaylist(playlistId) {
        const playlist = playlists[playlistId];
        if (!playlist) return;
        
        openConfirmationModal(
            `Load Playlist: "${playlist.name}"?`,
            "This will overwrite all current live data. This action cannot be undone.",
            "Load Playlist",
            async () => {
                const data = playlist.data;
                const batch = writeBatch(db);
                const collectionsToClear = ['classes', 'teachers', 'subjects', 'locations', 'schedule', 'timeslots'];
                for (const coll of collectionsToClear) {
                    const snapshot = await getDocs(collection(db, getPath(coll)));
                    snapshot.forEach(docSnap => batch.delete(docSnap.ref));
                }
                await batch.commit();

                const wb = writeBatch(db);
                const addDataToBatch = (coll, dataToadd) => {
                     if (dataToadd) {
                        for (const [id, itemData] of Object.entries(dataToadd)) {
                            if (typeof itemData === 'object' && itemData !== null) {
                                const { id: _docId, ...rest } = itemData;
                                wb.set(doc(db, getPath(coll), id), rest);
                            }
                        }
                    }
                };

                addDataToBatch('classes', data.classes);
                addDataToBatch('teachers', data.teachers);
                addDataToBatch('subjects', data.subjects);
                addDataToBatch('locations', data.locations);
                addDataToBatch('schedule', data.schedule);
                addDataToBatch('timeslots', data.timeslots);
                
                await wb.commit();
                showToast(`Playlist "${playlist.name}" loaded successfully!`);
            }
        );
    }

     function deletePlaylist(playlistId) {
        const playlist = playlists[playlistId];
        if (!playlist) return;
        openConfirmationModal(
            `Delete Playlist: "${playlist.name}"?`,
            "Are you sure you want to permanently delete this playlist?",
            "Delete",
            async () => {
                await deleteDoc(doc(db, getPath('playlists'), playlistId));
                showToast("Playlist deleted.");
            },
            true
        );
    }
    
    // --- UI & Utility Functions ---
    function toggleModal(modalId, show) { const modal = document.getElementById(modalId); if (!modal) return; const modalContent = modal.querySelector('.modal'); if (show) { modal.classList.remove('hidden'); setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 20); } else { modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); } }
    
    function openConfirmationModal(title, message, confirmText, onConfirm, isDestructive = false) {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        const confirmBtn = document.getElementById('confirmation-confirm-btn');
        confirmBtn.textContent = confirmText;
        confirmBtn.className = `px-4 py-2 text-sm rounded-md text-white ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'}`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', () => {
            onConfirm();
            toggleModal('confirmation-modal', false);
        });

        document.getElementById('confirmation-cancel-btn').onclick = () => toggleModal('confirmation-modal', false);
        toggleModal('confirmation-modal', true);
    }

    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0', 'translate-y-4');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => toast.classList.add('hidden'), 500);
        }, 3000);
    }

    function switchTab(targetTabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-content-${targetTabId}`).classList.remove('hidden');
        document.getElementById(`tab-${targetTabId}`).classList.add('active');
    }

    function attachEventListeners() {
        document.getElementById('download-pdf-btn').addEventListener('click', generateMasterSchedulePDF);
        document.getElementById('summary-toggle').addEventListener('change', (e) => {
            summaryViewMode = e.target.checked ? 'teacher' : 'subject';
            renderSummaryGrid();
        });
        
        document.getElementById('add-class-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('class-name').value.trim(); if(name) await addDoc(collection(db, getPath('classes')), { name, subjectIds: [] }); e.target.reset(); });
        document.getElementById('add-teacher-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('teacher-name').value.trim(); if(name) await addDoc(collection(db, getPath('teachers')), { name }); e.target.reset(); });
        document.getElementById('add-location-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('location-name').value.trim(); if(name) await addDoc(collection(db, getPath('locations')), { name }); e.target.reset(); });
        document.getElementById('add-subject-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('subject-name').value.trim(); if(name) await addDoc(collection(db, getPath('subjects')), { name, teacherIds: [] }); e.target.reset(); });
        document.getElementById('add-timeslot-form').addEventListener('submit', async e => { e.preventDefault(); const start = document.getElementById('timeslot-start').value; const end = document.getElementById('timeslot-end').value; const isBreak = document.getElementById('timeslot-is-break').checked; if (start && end && start < end) { await addDoc(collection(db, getPath('timeslots')), { start, end, isBreak }); e.target.reset(); } else { showToast("Error: End time must be after start time."); }});

        document.getElementById('class-list').addEventListener('click', async e => { if (e.target.classList.contains('delete-class')) await deleteDoc(doc(db, getPath('classes'), e.target.dataset.id)); });
        document.getElementById('teacher-list').addEventListener('click', async e => { if (e.target.classList.contains('delete-teacher')) await deleteDoc(doc(db, getPath('teachers'), e.target.dataset.id)); });
        document.getElementById('location-list').addEventListener('click', async e => { if (e.target.classList.contains('delete-location')) await deleteDoc(doc(db, getPath('locations'), e.target.dataset.id)); });
        document.getElementById('timeslot-list').addEventListener('click', e => { if (e.target.classList.contains('delete-timeslot')) deleteDoc(doc(db, getPath('timeslots'), e.target.dataset.id)); if (e.target.classList.contains('edit-timeslot')) openEditTimeSlotModal(e.target.dataset.id);});
        
        document.getElementById('subject-management-list').addEventListener('click', e => {
            const target = e.target;
            const subjectId = target.dataset.id;
            
            if (target.classList.contains('delete-subject')) {
                const subjectName = subjects[subjectId]?.name || 'this subject';
                openConfirmationModal(
                    `Delete Subject: "${subjectName}"?`,
                    "This will permanently delete the subject and un-assign it from all classes and schedule entries. This action cannot be undone.",
                    "Delete Subject",
                    async () => {
                        const batch = writeBatch(db);
                        const subjectRef = doc(db, getPath('subjects'), subjectId);
                        batch.delete(subjectRef);

                        Object.values(classes).forEach(cls => {
                            if (cls.subjectIds?.includes(subjectId)) {
                                const classRef = doc(db, getPath('classes'), cls.id);
                                const updatedSubjectIds = cls.subjectIds.filter(id => id !== subjectId);
                                batch.update(classRef, { subjectIds: updatedSubjectIds });
                            }
                        });

                        Object.values(schedule).forEach(entry => {
                            if (entry.subjectIds?.includes(subjectId)) {
                                const entryRef = doc(db, getPath('schedule'), entry.id);
                                const updatedSubjectIds = entry.subjectIds.filter(id => id !== subjectId);
                                if (updatedSubjectIds.length > 0) {
                                    batch.update(entryRef, { subjectIds: updatedSubjectIds });
                                } else {
                                    batch.delete(entryRef);
                                }
                            }
                        });

                        await batch.commit();
                        showToast(`Subject "${subjectName}" deleted successfully.`);
                    },
                    true // isDestructive
                );
            }
            if (target.classList.contains('assign-teachers-btn')) {
                openTeacherAssignmentModal(subjectId);
            }
            if (target.classList.contains('assign-classes-btn')) {
                openClassAssignmentModal(subjectId);
            }
        });

        document.getElementById('tab-content-management').addEventListener('click', e => { if (e.target.classList.contains('edit-btn')) { openEditModal(e.target.dataset.id, e.target.dataset.name, e.target.dataset.collection); } });
        
        document.getElementById('schedule-view').addEventListener('click', e => {
            const addBtn = e.target.closest('.add-entry-btn');
            const editBtn = e.target.closest('.edit-entry-btn');
            if (addBtn) {
                openScheduleEntryModal(addBtn.dataset.day, addBtn.dataset.time);
            } else if (editBtn) {
                openScheduleEntryModal(null, null, editBtn.dataset.docId);
            }
        });
        
        document.getElementById('add-playlist-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('playlist-name').value.trim(); if(name) { await savePlaylist(name); showToast('Playlist saved!'); e.target.reset(); } });
        document.getElementById('playlist-list').addEventListener('click', e => { if (e.target.classList.contains('load-playlist')) loadPlaylist(e.target.dataset.id); if (e.target.classList.contains('delete-playlist')) deletePlaylist(e.target.dataset.id); });


        document.getElementById('tab-schedule').addEventListener('click', () => switchTab('schedule')); 
        document.getElementById('tab-management').addEventListener('click', () => switchTab('management'));
        document.getElementById('tab-playlists').addEventListener('click', () => switchTab('playlists'));
        document.getElementById('tab-summary').addEventListener('click', () => switchTab('summary'));

    }
    
    function openScheduleEntryModal(day, time, docId = null) {
        const form = document.getElementById('schedule-entry-form');
        const modalTitle = document.getElementById('schedule-entry-modal-title');
        const subjectList = document.getElementById('modal-subject-list');
        const locationSelector = document.getElementById('modal-entry-location');
        const deleteBtn = document.getElementById('delete-entry-btn');

        form.reset();
        
        const entry = docId ? schedule[docId] : null;
        day = entry ? entry.day : day;
        time = entry ? entry.time : time;

        modalTitle.textContent = docId ? `Edit Entry for ${day} at ${time}` : `Add Entry for ${day} at ${time}`;
        document.getElementById('modal-entry-day').value = day;
        document.getElementById('modal-entry-time').value = time;
        document.getElementById('modal-entry-doc-id').value = docId || '';

        locationSelector.innerHTML = `<option value="">-- Optional: Select Location --</option>` + Object.entries(locations).sort(([, a], [, b]) => a.name.localeCompare(b.name)).map(([id, loc]) => `<option value="${id}">${loc.name}</option>`).join('');
        
        const populateSubjects = () => {
            const allSubjects = Object.entries(subjects).sort(([,a],[,b]) => a.name.localeCompare(b.name));
            subjectList.innerHTML = allSubjects.length > 0 ? allSubjects.map(([id, subject]) => `<label class="flex items-center p-1.5 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="subject" value="${id}" class="mr-2 h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><span>${subject.name}</span></label>`).join('') : '<p class="text-sm text-gray-500">No subjects have been created yet.</p>';
            
            if (entry) {
                entry.subjectIds?.forEach(sid => {
                    const checkbox = subjectList.querySelector(`input[value="${sid}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        };

        if (entry) {
            locationSelector.value = entry.locationId;
            deleteBtn.classList.remove('hidden');
        } else {
            deleteBtn.classList.add('hidden');
        }
        
        populateSubjects();
        toggleModal('schedule-entry-modal', true);
    }

    function openTeacherAssignmentModal(subjectId) {
        const subject = subjects[subjectId]; 
        document.getElementById('modal-teacher-subject-name').textContent = subject.name; 
        document.getElementById('modal-teacher-subject-id').value = subjectId;
        const listContainer = document.getElementById('modal-teacher-list');
        listContainer.innerHTML = Object.keys(teachers).length ? Object.entries(teachers).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, teacher]) => `<label class="flex items-center p-1.5 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="teacher" value="${id}" ${subject.teacherIds?.includes(id) ? 'checked' : ''} class="mr-2 h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><span>${teacher.name}</span></label>`).join('') : '<p class="text-sm text-gray-500">No teachers found to assign.</p>';
        toggleModal('teacher-assignment-modal', true);
    }
    
    function openClassAssignmentModal(subjectId) {
        const subject = subjects[subjectId];
        document.getElementById('modal-class-assignment-subject-name').textContent = subject.name;
        document.getElementById('modal-class-assignment-subject-id').value = subjectId;
        const listContainer = document.getElementById('modal-class-assignment-class-list');
        listContainer.innerHTML = Object.keys(classes).length ? Object.values(classes).sort((a,b) => a.name.localeCompare(b.name)).map(cls => {
            const isChecked = cls.subjectIds?.includes(subjectId);
            return `<label class="flex items-center p-1.5 rounded hover:bg-gray-100 cursor-pointer">
                        <input type="checkbox" name="class-for-subject" value="${cls.id}" ${isChecked ? 'checked' : ''} class="mr-2 h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <span>${cls.name}</span>
                    </label>`;
        }).join('') : '<p class="text-sm text-gray-500">No classes found to assign.</p>';
        toggleModal('class-assignment-modal', true);
    }

    function openEditModal(id, name, collection) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-collection').value = collection;
        document.getElementById('edit-name-input').value = name;
        document.getElementById('edit-modal-title').textContent = `Edit ${collection.slice(0, -1)}`;
        toggleModal('edit-modal', true);
    }
    
    function openEditTimeSlotModal(id) {
        const slot = timeslots[id];
        if (!slot) return;
        document.getElementById('edit-timeslot-id').value = id;
        document.getElementById('edit-timeslot-start').value = slot.start;
        document.getElementById('edit-timeslot-end').value = slot.end;
        document.getElementById('edit-timeslot-is-break').checked = slot.isBreak;
        toggleModal('timeslot-edit-modal', true);
    }

    function initModals() {
        document.getElementById('modal-container').innerHTML = `
            <div id="schedule-entry-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4" id="schedule-entry-modal-title">Add/Edit Entry</h3><form id="schedule-entry-form"><input type="hidden" id="modal-entry-day"><input type="hidden" id="modal-entry-time"><input type="hidden" id="modal-entry-doc-id"><div class="space-y-4"><div><label class="text-sm font-medium">Subject(s)</label><div id="modal-subject-list" class="space-y-1 max-h-40 overflow-y-auto mt-1 border p-2 rounded bg-gray-50"></div></div><div><label class="text-sm font-medium">Location</label><select id="modal-entry-location" class="w-full p-2 mt-1 border rounded"></select></div></div><div class="flex justify-between items-center gap-3 mt-6"><button type="button" id="delete-entry-btn" class="px-4 py-2 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">Delete</button><div class="flex gap-3"><button type="button" id="cancel-schedule-entry-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save</button></div></div></form></div></div>
            <div id="teacher-assignment-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Assign Teachers to <span id="modal-teacher-subject-name" class="font-bold"></span></h3><form id="teacher-assignment-form"><input type="hidden" id="modal-teacher-subject-id"><div id="modal-teacher-list" class="space-y-1 max-h-64 overflow-y-auto mb-4 border p-3 rounded-md bg-gray-50"></div><div class="flex justify-end gap-3 mt-4"><button type="button" data-modal-id="teacher-assignment-modal" class="cancel-modal-btn px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save</button></div></form></div></div>
            <div id="class-assignment-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Assign Classes to <span id="modal-class-assignment-subject-name" class="font-bold"></span></h3><form id="class-assignment-form"><input type="hidden" id="modal-class-assignment-subject-id"><div id="modal-class-assignment-class-list" class="space-y-1 max-h-64 overflow-y-auto mb-4 border p-3 rounded-md bg-gray-50"></div><div class="flex justify-end gap-3 mt-4"><button type="button" data-modal-id="class-assignment-modal" class="cancel-modal-btn px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save</button></div></form></div></div>
            <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 id="edit-modal-title" class="text-lg font-semibold mb-4">Edit Name</h3><form id="edit-form"><input type="hidden" id="edit-id"><input type="hidden" id="edit-collection"><input type="text" id="edit-name-input" class="w-full p-2 border rounded-md" required><div class="flex justify-end gap-3 mt-4"><button type="button" data-modal-id="edit-modal" class="cancel-modal-btn px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button></div></form></div></div>
            <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0 whitespace-pre-wrap"><h3 id="confirmation-title" class="text-lg font-semibold mb-2">Confirmation</h3><p id="confirmation-message" class="text-sm text-gray-600 mb-4"></p><div class="flex justify-end gap-3 mt-4"><button type="button" id="confirmation-cancel-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="button" id="confirmation-confirm-btn" class="px-4 py-2 text-sm rounded-md text-white">Confirm</button></div></div></div>
            <div id="timeslot-edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Edit Time Slot</h3><form id="edit-timeslot-form"><input type="hidden" id="edit-timeslot-id"><div class="space-y-3"><div class="flex gap-2 items-center"><input type="time" id="edit-timeslot-start" class="w-full p-2 text-sm border rounded-md" required><span>-</span><input type="time" id="edit-timeslot-end" class="w-full p-2 text-sm border rounded-md" required></div><div class="flex items-center"><input id="edit-timeslot-is-break" type="checkbox" class="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><label for="edit-timeslot-is-break" class="ml-2 block text-sm text-gray-900">Mark as a break time</label></div></div><div class="flex justify-end gap-3 mt-4"><button type="button" data-modal-id="timeslot-edit-modal" class="cancel-modal-btn px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button></div></form></div></div>
            <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 opacity-0 translate-y-4"></div>`; 
        
        document.getElementById('schedule-entry-form').addEventListener('submit', handleScheduleEntrySave);
        document.getElementById('cancel-schedule-entry-btn').addEventListener('click', () => toggleModal('schedule-entry-modal', false));
        document.getElementById('delete-entry-btn').addEventListener('click', () => {
            const docId = document.getElementById('modal-entry-doc-id').value;
            if (docId) {
                openConfirmationModal('Delete Entry?', 'Are you sure you want to permanently delete this schedule entry?', 'Delete', async () => {
                    await deleteDoc(doc(db, getPath('schedule'), docId));
                    toggleModal('schedule-entry-modal', false);
                    showToast('Entry deleted.');
                }, true);
            }
        });

        document.getElementById('teacher-assignment-form').addEventListener('submit', async e => { e.preventDefault(); const subjectId = document.getElementById('modal-teacher-subject-id').value; const teacherIds = Array.from(e.target.querySelectorAll('input:checked')).map(el => el.value); await updateDoc(doc(db, getPath('subjects'), subjectId), { teacherIds }); toggleModal('teacher-assignment-modal', false); });
        
        document.getElementById('class-assignment-form').addEventListener('submit', async e => {
            e.preventDefault();
            const subjectId = document.getElementById('modal-class-assignment-subject-id').value;
            const checkedClassIds = Array.from(e.target.querySelectorAll('input:checked')).map(el => el.value);
            const batch = writeBatch(db);

            Object.entries(classes).forEach(([classId, classData]) => {
                const classRef = doc(db, getPath('classes'), classId);
                const originalSubjectIds = classData.subjectIds || [];
                const isCurrentlyAssigned = originalSubjectIds.includes(subjectId);
                const shouldBeAssigned = checkedClassIds.includes(classId);

                if (shouldBeAssigned && !isCurrentlyAssigned) {
                    batch.update(classRef, { subjectIds: [...originalSubjectIds, subjectId] });
                } else if (!shouldBeAssigned && isCurrentlyAssigned) {
                    batch.update(classRef, { subjectIds: originalSubjectIds.filter(id => id !== subjectId) });
                }
            });

            await batch.commit();
            toggleModal('class-assignment-modal', false);
            showToast('Class assignments updated successfully!');
        });

        document.getElementById('edit-timeslot-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('edit-timeslot-id').value; const start = document.getElementById('edit-timeslot-start').value; const end = document.getElementById('edit-timeslot-end').value; const isBreak = document.getElementById('edit-timeslot-is-break').checked; if (id && start && end && start < end) { await updateDoc(doc(db, getPath('timeslots'), id), { start, end, isBreak }); toggleModal('timeslot-edit-modal', false); } else { showToast("Error: End time must be after start time."); }});
        
        document.getElementById('modal-container').addEventListener('click', e => { if (e.target.classList.contains('cancel-modal-btn')) toggleModal(e.target.dataset.modalId, false); });
        
        document.getElementById('edit-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('edit-id').value; const collection = document.getElementById('edit-collection').value; const newName = document.getElementById('edit-name-input').value.trim(); if (id && collection && newName) { await updateDoc(doc(db, getPath(collection), id), { name: newName }); toggleModal('edit-modal', false); } });
    }

    function setupDataListeners() {
        const collectionsToWatch = ['classes', 'teachers', 'subjects', 'schedule', 'locations', 'timeslots', 'playlists'];
        collectionsToWatch.forEach(name => {
            onSnapshot(collection(db, getPath(name)), snapshot => {
                const dataObject = {};
                snapshot.forEach(docSnap => dataObject[docSnap.id] = {...docSnap.data(), id: docSnap.id});
                
                if (name === 'classes') classes = dataObject;
                if (name === 'teachers') teachers = dataObject;
                if (name === 'subjects') subjects = dataObject;
                if (name === 'schedule') schedule = dataObject;
                if (name === 'locations') locations = dataObject;
                if (name === 'timeslots') timeslots = dataObject;
                if (name === 'playlists') playlists = dataObject;
                
                renderAll();
            }, err => console.error(`Error fetching ${name}:`, err));
        });
    }

    async function initializeAppData() {
        document.getElementById('summary-toggle').checked = true; // Default to teacher view
        setupDataListeners();
    }
    
    async function main() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app); auth = getAuth(app);
            initModals(); attachEventListeners();
            onAuthStateChanged(auth, async (user) => {
                if (user) { 
                    if (!userId) { 
                        userId = user.uid; 
                        await initializeAppData();
                    }
                } else { 
                    await signInAnonymously(auth); 
                }
            });
        } catch (error) { console.error("Firebase initialization failed:", error); document.body.innerHTML = `<div class="p-8 text-center text-red-600">Failed to initialize Firebase. Check console.</div>`; }
    }

    main();
</script>
</body>
</html>

