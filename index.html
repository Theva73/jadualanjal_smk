<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete School Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        select:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .summary-clash { background-color: #fee2e2 !important; color: #b91c1c; font-weight: bold; }
        .schedule-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
        }
        .schedule-entry span {
            font-size: 0.75rem;
            line-height: 1rem;
            color: #4338ca;
        }
        .delete-entry-btn {
            background: none; border: none; cursor: pointer; color: #ef4444; padding: 2px;
        }
        .delete-entry-btn:hover { color: #b91c1c; }
    </style>
</head>
<body class="p-2 sm:p-4">
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg">
    <header class="mb-6 border-b pb-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Complete School Schedule Planner</h1>
        <p class="text-sm text-gray-500 mt-1">All features integrated with your database.</p>
    </header>

    <!-- Tab Navigation -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="flex flex-wrap space-x-2 sm:space-x-4">
            <button id="tab-schedule" class="tab-btn px-3 py-2 font-medium text-sm rounded-md active">Schedule</button>
            <button id="tab-management" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Management</button>
            <button id="tab-versions" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Schedule Versions</button>
            <button id="tab-summary" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Summary</button>
        </nav>
    </div>

    <!-- Tab Content -->
    <div id="tab-content-schedule" class="tab-panel">
        <div class="mb-4">
            <label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Select a Class to View/Edit Schedule:</label>
            <select id="class-selector" class="w-full max-w-xs p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
        </div>
        <div id="schedule-view" class="overflow-x-auto">
            <p id="schedule-placeholder" class="text-gray-500 py-8 text-center">Please select a class to view its schedule.</p>
        </div>
    </div>

    <div id="tab-content-management" class="tab-panel hidden">
         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">1. Manage Classes</h3>
                <form id="add-class-form" class="flex gap-2 mb-3"><input type="text" id="class-name" placeholder="e.g., 5 Sains 1" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="class-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">2. Manage Teachers</h3>
                <form id="add-teacher-form" class="flex gap-2 mb-3"><input type="text" id="teacher-name" placeholder="Teacher's name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="teacher-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
             <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">3. Manage Locations</h3>
                <form id="add-location-form" class="flex gap-2 mb-3"><input type="text" id="location-name" placeholder="e.g., Lab A, Hall B" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="location-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">4. Manage & Assign Subjects</h3>
                <form id="add-subject-form" class="flex gap-2 mb-3"><input type="text" id="subject-name" placeholder="New subject name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="subject-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <div id="tab-content-versions" class="tab-panel hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Manage Schedule Versions</h2>
        <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3 text-gray-800">Create New Version</h3>
            <form id="add-version-form" class="flex items-center gap-2 mb-4">
                <input type="text" id="version-name" placeholder="e.g., Final Term 1" class="flex-grow p-2 text-sm border rounded-md" required>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Save Current Schedule
                </button>
            </form>
            <h3 class="text-lg font-semibold mb-3 text-gray-800">Saved Versions</h3>
            <div id="version-list" class="space-y-2">
                <p class="text-sm text-gray-500">No versions saved yet.</p>
            </div>
        </div>
    </div>
    
    <div id="tab-content-summary" class="tab-panel hidden">
         <h2 class="text-xl font-semibold mb-4 text-gray-800">Teacher Schedule Summary</h2>
         <div id="summary-grid" class="overflow-x-auto"></div>
    </div>
</div>

<!-- Modals -->
<div id="modal-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // This configuration is taken from your working file.
    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };
    
    let db, auth, userId;
    let teachers = {}, subjects = {}, schedule = {}, classes = {}, locations = {}, versions = {};
    let selectedClassId = null;

    const DAYS = ["ISNIN", "SELASA", "RABU", "KHAMIS", "JUMAAT"];
    const TIME_SLOTS = ["07:15-08:15", "08:15-09:15", "09:15-10:15", "10:15-10:30", "10:30-11:00", "11:00-12:00", "12:00-13:00"];
    const REHAT_TIME = "10:15-10:30";

    const getPath = (collectionName) => `scheduler_final_${collectionName}`;

    function renderAll() {
        renderClasses();
        renderTeachers();
        renderLocations();
        renderSubjects();
        renderVersions();
        renderClassSelector();
        renderScheduleForClass();
        renderSummaryGrid();
    }

    function renderClasses() {
        const classListDiv = document.getElementById('class-list');
        classListDiv.innerHTML = Object.keys(classes).length ? Object.entries(classes).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, cls]) => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${cls.name}</span><button data-id="${id}" class="delete-class text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
            </div>`).join('') : `<p class="text-sm text-gray-500">No classes found.</p>`;
    }
    
    function renderTeachers() {
        const teacherListDiv = document.getElementById('teacher-list');
        teacherListDiv.innerHTML = Object.keys(teachers).length ? Object.entries(teachers).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, teacher]) => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${teacher.name}</span><button data-id="${id}" class="delete-teacher text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
            </div>`).join('') : `<p class="text-sm text-gray-500">No teachers added yet.</p>`;
    }

    function renderLocations() {
        const locationListDiv = document.getElementById('location-list');
        locationListDiv.innerHTML = Object.keys(locations).length ? Object.entries(locations).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, loc]) => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${loc.name}</span><button data-id="${id}" class="delete-location text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
            </div>`).join('') : `<p class="text-sm text-gray-500">No locations added yet.</p>`;
    }

    function renderSubjects() {
        const subjectListDiv = document.getElementById('subject-list');
        subjectListDiv.innerHTML = Object.keys(subjects).length ? Object.entries(subjects).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, subject]) => {
            const teacherNames = subject.teacherIds?.map(tid => teachers[tid]?.name).filter(Boolean).join(', ') || 'None assigned';
            return `<div class="p-3 bg-white rounded-md shadow-sm">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-800">${subject.name}</span>
                    <div class="flex gap-2">
                        <button data-id="${id}" class="assign-teachers bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs">ASSIGN</button>
                        <button data-id="${id}" class="delete-subject text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Teachers: ${teacherNames}</p>
            </div>`;
        }).join('') : `<p class="text-sm text-gray-500">No subjects created yet.</p>`;
    }

     function renderVersions() {
        const versionListDiv = document.getElementById('version-list');
        versionListDiv.innerHTML = Object.keys(versions).length ? Object.entries(versions).sort(([, a], [, b]) => b.createdAt - a.createdAt).map(([id, version]) => `
            <div class="flex justify-between items-center p-3 bg-white rounded-md shadow-sm">
                <div>
                    <span class="font-semibold text-gray-800">${version.name}</span>
                    <p class="text-xs text-gray-500">Saved on: ${new Date(version.createdAt).toLocaleString()}</p>
                </div>
                <div class="flex gap-2">
                    <button data-id="${id}" class="load-version bg-green-100 text-green-700 px-3 py-1.5 rounded text-xs font-semibold hover:bg-green-200">LOAD</button>
                    <button data-id="${id}" class="delete-version text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No versions saved yet.</p>`;
    }

    function renderClassSelector() {
        const selector = document.getElementById('class-selector');
        const hasClasses = Object.keys(classes).length > 0;
        selector.disabled = !hasClasses;
        const currentSelected = selector.value;
        selector.innerHTML = !hasClasses ? `<option>Please add a class first</option>` : `<option value="">-- Select a Class --</option>` + Object.entries(classes).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, cls]) => `<option value="${id}">${cls.name}</option>`).join('');
        selector.value = currentSelected;
    }

    function renderScheduleForClass() {
        const scheduleView = document.getElementById('schedule-view');
        if (!selectedClassId) { scheduleView.innerHTML = '<p id="schedule-placeholder" class="text-gray-500 py-8 text-center">Please select a class to view its schedule.</p>'; return; }
        
        const scheduleEntries = Object.values(schedule).filter(entry => entry.classId === selectedClassId);

        const tableBody = DAYS.map(day => `<tr><td class="px-2 py-2 text-sm border font-bold text-gray-700 bg-gray-50 sticky left-0 z-10">${day}</td>${TIME_SLOTS.map(time => {
            if (time === REHAT_TIME) return `<td class="p-1 border align-middle text-center bg-green-50 text-green-700 font-semibold text-xs">Rehat</td>`;
            const slotId = `${day}_${time}`;
            const entriesForSlot = scheduleEntries.filter(e => e.slotId === slotId);
            const entriesHtml = entriesForSlot.map(entry => `
                <div class="schedule-entry">
                    <span>
                        <strong>${subjects[entry.subjectId]?.name || 'N/A'}</strong><br>
                        ${locations[entry.locationId]?.name || 'N/A'}
                    </span>
                    <button data-doc-id="${entry.id}" class="delete-entry-btn" title="Delete entry">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('');

            return `<td class="p-1 border align-top min-w-[180px]">
                <div class="space-y-1">${entriesHtml}</div>
                <button data-slot-id="${slotId}" class="add-entry-btn w-full mt-2 text-xs p-1 bg-gray-100 hover:bg-gray-200 rounded-md text-gray-600">+ Add</button>
            </td>`;
        }).join('')}</tr>`).join('');

        scheduleView.innerHTML = `<table class="min-w-full border-collapse"><thead><tr class="bg-gray-100"><th class="px-2 py-2 text-sm font-semibold text-gray-600 border sticky left-0 bg-gray-100 z-10">Class/Time</th>${TIME_SLOTS.map(ts => `<th class="px-2 py-2 text-sm font-medium text-gray-600 border whitespace-nowrap">${ts}</th>`).join('')}</tr></thead><tbody>${tableBody}</tbody></table>`;
    }

    function renderSummaryGrid() {
        const summaryDiv = document.getElementById('summary-grid');
        if (!Object.keys(teachers).length) { summaryDiv.innerHTML = `<p class="text-gray-500 py-8 text-center">No teachers to display.</p>`; return; }
        const teacherSchedules = {};
        Object.keys(teachers).forEach(tid => { teacherSchedules[tid] = {}; DAYS.forEach(day => teacherSchedules[tid][day] = {}); });
        
        Object.values(schedule).forEach(entry => {
            const subject = subjects[entry.subjectId]; const className = classes[entry.classId]?.name || 'Unknown'; const locationName = locations[entry.locationId]?.name;
            if (subject?.teacherIds) {
                subject.teacherIds.forEach(tid => {
                    if (teacherSchedules[tid]?.[entry.day]) {
                        if (!teacherSchedules[tid][entry.day][entry.time]) teacherSchedules[tid][entry.day][entry.time] = [];
                        const entryText = `${className} (${subjects[entry.subjectId]?.name}, ${locationName || 'N/A'})`;
                        teacherSchedules[tid][entry.day][entry.time].push(entryText);
                    }
                });
            }
        });
        
        const dayHeaders = DAYS.map(day => `<th colspan="${TIME_SLOTS.length}" class="p-2 border font-semibold text-center">${day}</th>`).join('');
        const timeHeaders = TIME_SLOTS.map(ts => `<th class="p-2 border font-semibold whitespace-nowrap">${ts}</th>`).join('');
        summaryDiv.innerHTML = `<p class="text-xs text-gray-500 mb-2">Clashes (multiple assignments in one slot) are highlighted in red.</p><table class="min-w-full border-collapse text-xs"><thead><tr class="bg-gray-100"><th rowspan="2" class="p-2 border font-semibold sticky left-0 bg-gray-100 z-20">Nama/Masa</th>${dayHeaders}</tr><tr class="bg-gray-100">${DAYS.map(() => timeHeaders).join('')}</tr></thead><tbody>${Object.entries(teachers).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([tid, teacher]) => `<tr class="even:bg-gray-50"><td class="p-2 border font-bold sticky left-0 z-10" style="background-color: inherit;">${teacher.name}</td>${DAYS.map(day => TIME_SLOTS.map(time => { if (time === REHAT_TIME) return `<td class="p-1 border bg-green-50"></td>`; const classesAssigned = teacherSchedules[tid]?.[day]?.[time] || []; const isClash = classesAssigned.length > 1; return `<td class="p-2 border align-middle text-center ${isClash ? 'summary-clash' : ''}" title="${day} ${time}">${classesAssigned.join('<br>')}</td>`; }).join('')).join('')}</tr>`).join('')}</tbody></table>`;
    }

    async function addScheduleEntry(slotId, subjectId, locationId) {
        if (!subjectId) { alert("Please select a subject."); return; }
        const [day, time] = slotId.split('_');

        let clashes = [];
        const teachersForSubject = subjects[subjectId]?.teacherIds || [];
        if (teachersForSubject.length > 0) {
            const q = query(collection(db, getPath('schedule')), where("day", "==", day), where("time", "==", time));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                const entry = doc.data();
                const scheduledTeachers = subjects[entry.subjectId]?.teacherIds || [];
                const intersection = teachersForSubject.filter(tid => scheduledTeachers.includes(tid));
                if (intersection.length > 0) {
                    clashes.push(`Teacher Clash: ${intersection.map(tid => teachers[tid]?.name).join(', ')} is already scheduled for ${subjects[entry.subjectId]?.name} in class ${classes[entry.classId]?.name}.`);
                }
            });
        }
        if (locationId) {
            const q = query(collection(db, getPath('schedule')), where("day", "==", day), where("time", "==", time), where("locationId", "==", locationId));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const entry = querySnapshot.docs[0].data();
                clashes.push(`Location Clash: ${locations[locationId]?.name} is already booked for class ${classes[entry.classId]?.name}.`);
            }
        }
        
        const saveData = async () => {
            await addDoc(collection(db, getPath('schedule')), { day, time, slotId, classId: selectedClassId, subjectId, locationId: locationId || null });
        };

        if (clashes.length > 0) {
            openClashConfirmationModal(clashes.join('\n'), saveData);
        } else {
            await saveData();
        }
    }
    
    async function saveVersion(name) {
        if (!name) return;
        const versionData = { name, createdAt: Date.now(), data: { classes, teachers, subjects, locations, schedule } };
        await addDoc(collection(db, getPath('versions')), versionData);
    }

    async function loadVersion(versionId) {
        const version = versions[versionId];
        if (!version) return;
        
        openConfirmationModal(
            `Load Schedule: "${version.name}"?`,
            "This will overwrite all current data. This action cannot be undone.",
            "Load Version",
            async () => {
                const { classes: vClasses, teachers: vTeachers, subjects: vSubjects, locations: vLocations, schedule: vSchedule } = version.data;
                const batch = writeBatch(db);
                const collectionsToClear = ['classes', 'teachers', 'subjects', 'locations', 'schedule'];
                for (const coll of collectionsToClear) {
                    const snapshot = await getDocs(collection(db, getPath(coll)));
                    snapshot.forEach(doc => batch.delete(doc.ref));
                }
                const addDataToBatch = (coll, data) => {
                    if (data) Object.entries(data).forEach(([id, itemData]) => batch.set(doc(db, getPath(coll), id), itemData));
                };
                addDataToBatch('classes', vClasses);
                addDataToBatch('teachers', vTeachers);
                addDataToBatch('subjects', vSubjects);
                addDataToBatch('locations', vLocations);
                addDataToBatch('schedule', vSchedule);
                await batch.commit();
                showToast("Schedule version loaded successfully!");
            }
        );
    }
    
    function deleteVersion(versionId) {
        const version = versions[versionId];
        if (!version) return;
        openConfirmationModal( `Delete Schedule: "${version.name}"?`, "This action cannot be undone.", "Delete",
            async () => {
                await deleteDoc(doc(db, getPath('versions'), versionId));
                showToast("Version deleted.");
            }, true 
        );
    }

    function switchTab(targetTabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-content-${targetTabId}`).classList.remove('hidden');
        document.getElementById(`tab-${targetTabId}`).classList.add('active');
    }

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if(!modal) return;
        const modalContent = modal.querySelector('.modal');
        if (show) {
            modal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 20);
        } else {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }
    
    function openClashConfirmationModal(message, onConfirm) {
        document.getElementById('clash-confirmation-message').textContent = message;
        const confirmBtn = document.getElementById('clash-confirmation-proceed-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', () => { onConfirm(); toggleModal('clash-confirmation-modal', false); });
        toggleModal('clash-confirmation-modal', true);
    }
    
     function openConfirmationModal(title, message, confirmText, onConfirm, isDestructive = false) {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        const confirmBtn = document.getElementById('confirmation-confirm-btn');
        confirmBtn.textContent = confirmText;
        confirmBtn.className = `px-4 py-2 text-sm rounded-md text-white ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'}`;
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', () => { onConfirm(); toggleModal('confirmation-modal', false); });
        toggleModal('confirmation-modal', true);
    }
    
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0', 'translate-y-4');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => toast.classList.add('hidden'), 500);
        }, 3000);
    }

    function attachEventListeners() {
        document.getElementById('add-class-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('class-name').value.trim(); if(name) await addDoc(collection(db, getPath('classes')), { name }); e.target.reset(); });
        document.getElementById('add-teacher-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('teacher-name').value.trim(); if(name) await addDoc(collection(db, getPath('teachers')), { name }); e.target.reset(); });
        document.getElementById('add-location-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('location-name').value.trim(); if(name) await addDoc(collection(db, getPath('locations')), { name }); e.target.reset(); });
        document.getElementById('add-subject-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('subject-name').value.trim(); if(name) await addDoc(collection(db, getPath('subjects')), { name, teacherIds: [] }); e.target.reset(); });
        document.getElementById('add-version-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('version-name').value.trim(); if(name) { await saveVersion(name); showToast('Schedule version saved!'); e.target.reset(); } });
        
        document.getElementById('class-list').addEventListener('click', async e => { if (e.target.closest('.delete-class')) await deleteDoc(doc(db, getPath('classes'), e.target.closest('.delete-class').dataset.id)); });
        document.getElementById('teacher-list').addEventListener('click', async e => { if (e.target.closest('.delete-teacher')) await deleteDoc(doc(db, getPath('teachers'), e.target.closest('.delete-teacher').dataset.id)); });
        document.getElementById('location-list').addEventListener('click', async e => { if (e.target.closest('.delete-location')) await deleteDoc(doc(db, getPath('locations'), e.target.closest('.delete-location').dataset.id)); });
        
        document.getElementById('version-list').addEventListener('click', e => {
            if (e.target.closest('.load-version')) loadVersion(e.target.closest('.load-version').dataset.id);
            if (e.target.closest('.delete-version')) deleteVersion(e.target.closest('.delete-version').dataset.id);
        });
        
        document.getElementById('subject-list').addEventListener('click', e => {
            const target = e.target;
            if (target.closest('.delete-subject')) deleteDoc(doc(db, getPath('subjects'), target.closest('.delete-subject').dataset.id));
            if (target.closest('.assign-teachers')) {
                const subjectId = target.closest('.assign-teachers').dataset.id;
                document.getElementById('modal-subject-name').textContent = subjects[subjectId].name;
                document.getElementById('modal-subject-id').value = subjectId;
                const listContainer = document.getElementById('modal-teacher-list');
                listContainer.innerHTML = Object.keys(teachers).length ? Object.entries(teachers).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, teacher]) => `<label class="flex items-center p-1.5 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="teacher" value="${id}" ${subjects[subjectId].teacherIds?.includes(id) ? 'checked' : ''} class="mr-2 h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><span>${teacher.name}</span></label>`).join('') : '<p class="text-sm text-gray-500">No teachers to assign.</p>';
                toggleModal('teacher-assignment-modal', true);
            }
        });
        
        document.getElementById('schedule-view').addEventListener('click', async e => {
            const addBtn = e.target.closest('.add-entry-btn');
            const deleteBtn = e.target.closest('.delete-entry-btn');
            if (addBtn) {
                document.getElementById('add-entry-slot-id').value = addBtn.dataset.slotId;
                toggleModal('add-entry-modal', true);
            }
            if (deleteBtn) {
                openConfirmationModal('Delete Entry?', 'Are you sure you want to delete this schedule entry?', 'Delete', async () => {
                     await deleteDoc(doc(db, getPath('schedule'), deleteBtn.dataset.docId));
                }, true);
            }
        });

        document.getElementById('class-selector').addEventListener('change', e => { selectedClassId = e.target.value; renderScheduleForClass(); });
        document.getElementById('tab-schedule').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('tab-management').addEventListener('click', () => switchTab('management'));
        document.getElementById('tab-versions').addEventListener('click', () => switchTab('versions'));
        document.getElementById('tab-summary').addEventListener('click', () => switchTab('summary'));

        document.getElementById('teacher-assignment-form').addEventListener('submit', async e => { e.preventDefault(); const subjectId = document.getElementById('modal-subject-id').value; const teacherIds = Array.from(e.target.querySelectorAll('input:checked')).map(el => el.value); await updateDoc(doc(db, getPath('subjects'), subjectId), { teacherIds }); toggleModal('teacher-assignment-modal', false); });
        document.getElementById('add-entry-form').addEventListener('submit', async e => { e.preventDefault(); const slotId = document.getElementById('add-entry-slot-id').value; const subjectId = document.getElementById('add-entry-subject-id').value; const locationId = document.getElementById('add-entry-location-id').value; await addScheduleEntry(slotId, subjectId, locationId); toggleModal('add-entry-modal', false); e.target.reset(); });
        
        document.addEventListener('click', e => {
            if (e.target.id === 'cancel-add-entry-btn') toggleModal('add-entry-modal', false);
            if (e.target.id === 'cancel-teacher-assignment-btn') toggleModal('teacher-assignment-modal', false);
            if (e.target.id === 'clash-confirmation-cancel-btn') toggleModal('clash-confirmation-modal', false);
            if (e.target.id === 'confirmation-cancel-btn') toggleModal('confirmation-modal', false);
        });
    }

    function initModals() {
        const subjectOptions = `<option value="">-- Select Subject --</option>` + Object.entries(subjects).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, sub]) => `<option value="${id}">${sub.name}</option>`).join('');
        const locationOptions = `<option value="">-- Select Location (Optional) --</option>` + Object.entries(locations).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, loc]) => `<option value="${id}">${loc.name}</option>`).join('');

        document.getElementById('modal-container').innerHTML = `
            <div id="teacher-assignment-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Assign Teachers to <span id="modal-subject-name" class="font-bold"></span></h3><form id="teacher-assignment-form"><input type="hidden" id="modal-subject-id"><div id="modal-teacher-list" class="space-y-1 max-h-64 overflow-y-auto mb-4 border p-3 rounded-md bg-gray-50"></div><div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-teacher-assignment-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save</button></div></form></div></div>
            <div id="add-entry-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Add Schedule Entry</h3><form id="add-entry-form"><input type="hidden" id="add-entry-slot-id"><div class="space-y-4"><select id="add-entry-subject-id" class="w-full p-2 border rounded-md" required>${subjectOptions}</select><select id="add-entry-location-id" class="w-full p-2 border rounded-md">${locationOptions}</select></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-add-entry-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Entry</button></div></form></div></div>
            <div id="clash-confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg modal transform scale-95 opacity-0"><h3 class="text-lg font-medium text-red-700">Scheduling Clash Detected!</h3><p class="text-sm text-gray-600 mt-2 whitespace-pre-wrap" id="clash-confirmation-message"></p><p class="text-sm font-semibold mt-4">Do you want to proceed anyway?</p><div class="mt-5 flex justify-end gap-3"><button type="button" id="clash-confirmation-cancel-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="button" id="clash-confirmation-proceed-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">Proceed Anyway</button></div></div></div>
            <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 id="confirmation-title" class="text-lg font-semibold mb-2">Confirmation</h3><p id="confirmation-message" class="text-sm text-gray-600 mb-4"></p><div class="flex justify-end gap-3 mt-4"><button type="button" id="confirmation-cancel-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="button" id="confirmation-confirm-btn" class="px-4 py-2 text-sm rounded-md text-white">Confirm</button></div></div></div>
            <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 opacity-0 translate-y-4"></div>`;
    }

    function setupDataListeners() {
        const collectionsToWatch = ['classes', 'teachers', 'subjects', 'schedule', 'locations', 'versions'];
        collectionsToWatch.forEach(name => {
            onSnapshot(collection(db, getPath(name)), snapshot => {
                const dataObject = {};
                snapshot.forEach(doc => dataObject[doc.id] = {...doc.data(), id: doc.id});
                if (name === 'classes') classes = dataObject;
                if (name === 'teachers') teachers = dataObject;
                if (name === 'subjects') subjects = dataObject;
                if (name === 'schedule') schedule = dataObject;
                if (name === 'locations') locations = dataObject;
                if (name === 'versions') versions = dataObject;

                if (['subjects', 'locations'].includes(name)) initModals();
                renderAll();
            }, err => console.error(`Error fetching ${name}:`, err));
        });
    }
    
    function main() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app); auth = getAuth(app);
            initModals(); attachEventListeners();
            onAuthStateChanged(auth, user => {
                if (user) { userId = user.uid; setupDataListeners(); } 
                else { signInAnonymously(auth); }
            });
        } catch (error) {
             console.error("Firebase initialization failed:", error);
             document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-700 rounded-lg">
                <h2 class="text-xl font-bold">Error: Database Connection Failed</h2>
                <p class="mt-2">There was an issue initializing the connection to the Firebase database. Please check the console for more details.</p>
             </div>`;
        }
    }

    main();
</script>
</body>
</html>

