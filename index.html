<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Scheduler with Versions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; font-weight: 600; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        select:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .summary-clash { background-color: #fee2e2 !important; color: #b91c1c; font-weight: bold; }
        .summary-clash-override { background-color: #fef9c3 !important; color: #a16207; border: 1px solid #fde047; }
    </style>
</head>
<body class="p-2 sm:p-4">
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg">
    <header class="mb-6 border-b pb-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">New School Schedule Planner</h1>
        <p class="text-sm text-gray-500 mt-1">A new, independent database in your Firebase project.</p>
    </header>

    <!-- Tab Navigation -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="flex flex-wrap space-x-2 sm:space-x-4">
            <button id="tab-schedule" class="tab-btn px-3 py-2 font-medium text-sm rounded-md active">Schedule</button>
            <button id="tab-management" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Management</button>
            <button id="tab-versions" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Schedule Versions</button>
            <button id="tab-summary" class="tab-btn px-3 py-2 font-medium text-sm rounded-md">Summary</button>
        </nav>
    </div>

    <!-- Tab Content -->
    <div id="tab-content-schedule" class="tab-panel">
        <div class="mb-4">
            <label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Select a Class to View/Edit Schedule:</label>
            <select id="class-selector" class="w-full max-w-xs p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
        </div>
        <div id="schedule-view" class="overflow-x-auto">
            <p id="schedule-placeholder" class="text-gray-500 py-8 text-center">Please select a class to view its schedule.</p>
        </div>
    </div>

    <div id="tab-content-management" class="tab-panel hidden">
         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">1. Manage Classes</h3>
                <form id="add-class-form" class="flex gap-2 mb-3"><input type="text" id="class-name" placeholder="e.g., 5 Sains 1" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="class-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">2. Manage Teachers</h3>
                <form id="add-teacher-form" class="flex gap-2 mb-3"><input type="text" id="teacher-name" placeholder="Teacher's name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="teacher-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
             <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">3. Manage Locations</h3>
                <form id="add-location-form" class="flex gap-2 mb-3"><input type="text" id="location-name" placeholder="e.g., Lab A, Hall B" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="location-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">4. Manage & Assign Subjects</h3>
                <form id="add-subject-form" class="flex gap-2 mb-3"><input type="text" id="subject-name" placeholder="New subject name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                <div id="subject-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
        </div>
        <div class="mt-6 border-t pt-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">5. Manage Time Slots</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-700">Add New Time Slot</h4>
                    <form id="add-timeslot-form" class="space-y-3">
                        <div class="flex gap-2 items-center">
                            <input type="time" id="timeslot-start" class="w-full p-2 text-sm border rounded-md" required>
                            <span>-</span>
                            <input type="time" id="timeslot-end" class="w-full p-2 text-sm border rounded-md" required>
                        </div>
                        <div class="flex items-center">
                            <input id="timeslot-is-break" type="checkbox" class="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <label for="timeslot-is-break" class="ml-2 block text-sm text-gray-900">Mark as a break time</label>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add Time Slot</button>
                    </form>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-700">Current Time Slots</h4>
                    <div id="timeslot-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tab-content-versions" class="tab-panel hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Manage Schedule Versions</h2>
        <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3 text-gray-800">Create New Version</h3>
            <form id="add-version-form" class="flex items-center gap-2 mb-4">
                <input type="text" id="version-name" placeholder="e.g., Final Term 1" class="flex-grow p-2 text-sm border rounded-md" required>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Save Current Schedule
                </button>
            </form>
            <h3 class="text-lg font-semibold mb-3 text-gray-800">Saved Versions</h3>
            <div id="version-list" class="space-y-2">
                <p class="text-sm text-gray-500">No versions saved yet.</p>
            </div>
        </div>
    </div>

    <div id="tab-content-summary" class="tab-panel hidden">
         <h2 class="text-xl font-semibold mb-4 text-gray-800">Teacher Schedule Summary</h2>
         <div id="summary-grid" class="overflow-x-auto"></div>
    </div>
</div>

<!-- Modals -->
<div id="modal-container"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setDoc, updateDoc, query, where, getDocs, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };
    
    let db, auth, userId;
    let teachers = {}, subjects = {}, schedule = {}, classes = {}, locations = {}, versions = {}, timeslots = {};
    let selectedClassId = null;

    const DAYS = ["ISNIN", "SELASA", "RABU", "KHAMIS", "JUMAAT"];

    const getPath = (collectionName) => `scheduler_v2_${collectionName}`;

    function getSortedTimeSlots() {
        if (!timeslots || Object.keys(timeslots).length === 0) return [];
        return Object.values(timeslots).sort((a, b) => a.start.localeCompare(b.start));
    }

    function renderAll() {
        renderClasses();
        renderTeachers();
        renderLocations();
        renderSubjects();
        renderVersions();
        renderTimeSlots();
        renderClassSelector();
        renderScheduleForClass();
        renderSummaryGrid();
    }

    // --- Data Rendering Functions ---
    function renderClasses() {
        const classListDiv = document.getElementById('class-list');
        classListDiv.innerHTML = Object.keys(classes).length ? Object.entries(classes).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, cls]) => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${cls.name}</span>
                <div class="flex gap-2">
                    <button data-id="${id}" data-name="${cls.name}" data-collection="classes" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${id}" class="delete-class text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No classes found.</p>`;
    }
    
    function renderTeachers() {
        const teacherListDiv = document.getElementById('teacher-list');
        const teacherArray = Object.values(teachers);
        teacherListDiv.innerHTML = teacherArray.length ? teacherArray.sort((a,b) => a.name.localeCompare(b.name)).map(teacher => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${teacher.name}</span>
                 <div class="flex gap-2">
                    <button data-id="${teacher.id}" data-name="${teacher.name}" data-collection="teachers" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${teacher.id}" class="delete-teacher text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No teachers added yet.</p>`;
    }

    function renderLocations() {
        const locationListDiv = document.getElementById('location-list');
        const locationArray = Object.values(locations);
        locationListDiv.innerHTML = locationArray.length ? locationArray.sort((a, b) => a.name.localeCompare(b.name)).map(location => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <span>${location.name}</span>
                 <div class="flex gap-2">
                    <button data-id="${location.id}" data-name="${location.name}" data-collection="locations" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${location.id}" class="delete-location text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No locations added yet.</p>`;
    }

    function renderSubjects() {
        const subjectListDiv = document.getElementById('subject-list');
        subjectListDiv.innerHTML = Object.keys(subjects).length ? Object.entries(subjects).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, subject]) => {
            const teacherNames = subject.teacherIds?.map(tid => teachers[tid]?.name).filter(Boolean).join(', ') || 'None assigned';
            return `<div class="p-3 bg-white rounded-md shadow-sm">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-800">${subject.name}</span>
                    <div class="flex gap-2">
                        <button data-id="${id}" data-name="${subject.name}" data-collection="subjects" class="edit-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                        <button data-id="${id}" class="assign-teachers bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs">ASSIGN</button>
                        <button data-id="${id}" class="delete-subject text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Teachers: ${teacherNames}</p>
            </div>`;
        }).join('') : `<p class="text-sm text-gray-500">No subjects created yet.</p>`;
    }

    function renderTimeSlots() {
        const listDiv = document.getElementById('timeslot-list');
        const sortedTimeSlots = getSortedTimeSlots();
        listDiv.innerHTML = sortedTimeSlots.length ? sortedTimeSlots.map(slot => `
            <div class="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
                <div>
                    <span class="font-semibold">${slot.start} - ${slot.end}</span>
                    ${slot.isBreak ? '<span class="ml-2 text-xs font-semibold text-green-700 bg-green-100 px-2 py-0.5 rounded-full">Break</span>' : ''}
                </div>
                <div class="flex gap-2">
                    <button data-id="${slot.id}" class="edit-timeslot text-blue-500 hover:text-blue-700 text-xs font-semibold">EDIT</button>
                    <button data-id="${slot.id}" class="delete-timeslot text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No time slots defined.</p>`;
    }
    
    function renderVersions() {
        const versionListDiv = document.getElementById('version-list');
        versionListDiv.innerHTML = Object.keys(versions).length ? Object.entries(versions).sort(([, a], [, b]) => b.createdAt - a.createdAt).map(([id, version]) => `
            <div class="flex justify-between items-center p-3 bg-white rounded-md shadow-sm">
                <div>
                    <span class="font-semibold text-gray-800">${version.name}</span>
                    <p class="text-xs text-gray-500">Saved on: ${new Date(version.createdAt).toLocaleString()}</p>
                </div>
                <div class="flex gap-2">
                    <button data-id="${id}" class="load-version bg-green-100 text-green-700 px-3 py-1.5 rounded text-xs font-semibold hover:bg-green-200">LOAD</button>
                    <button data-id="${id}" class="delete-version text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                </div>
            </div>`).join('') : `<p class="text-sm text-gray-500">No versions saved yet.</p>`;
    }

    function renderClassSelector() {
        const selector = document.getElementById('class-selector');
        const hasClasses = Object.keys(classes).length > 0;
        selector.disabled = !hasClasses;
        const currentSelected = selector.value;
        selector.innerHTML = !hasClasses ? `<option>Please add a class first</option>` : `<option value="">-- Select a Class --</option>` + Object.entries(classes).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, cls]) => `<option value="${id}">${cls.name}</option>`).join('');
        selector.value = currentSelected;
    }

    function renderScheduleForClass() {
        const scheduleView = document.getElementById('schedule-view');
        if (!selectedClassId) { scheduleView.innerHTML = '<p id="schedule-placeholder" class="text-gray-500 py-8 text-center">Please select a class to view its schedule.</p>'; return; }
        
        const sortedTimeSlots = getSortedTimeSlots();
        if (sortedTimeSlots.length === 0) {
            scheduleView.innerHTML = '<p class="text-gray-500 py-8 text-center">Please define time slots in the Management tab first.</p>';
            return;
        }

        const locationOptions = `<option value="">-- Lokasi --</option>` + Object.entries(locations).sort(([, a], [, b]) => a.name.localeCompare(b.name)).map(([id, loc]) => `<option value="${id}">${loc.name}</option>`).join('');
        const classSchedule = Object.values(schedule).filter(entry => entry.classId === selectedClassId);

        const tableBody = DAYS.map(day => `<tr><td class="px-2 py-2 text-sm border font-bold text-gray-700 bg-gray-50 sticky left-0 z-10">${day}</td>${sortedTimeSlots.map(slot => {
            const time = `${slot.start}-${slot.end}`;
            if (slot.isBreak) return `<td class="p-1 border align-middle text-center bg-green-50 text-green-700 font-semibold text-xs">${time}<br>Rehat</td>`;
            const slotId = `${day}_${time}`;
            const entry = classSchedule.find(e => e.slotId === slotId);
            const subjectNames = entry?.subjectIds?.map(sid => subjects[sid]?.name).filter(Boolean).join(', ') || '<span class="text-gray-400">Not set</span>';

            return `<td class="p-1 border align-top min-w-[180px]"><div class="flex flex-col gap-1">
                <div class="p-1.5 text-xs bg-gray-50 rounded border border-dashed h-12 overflow-y-auto">${subjectNames}</div>
                <button data-slot-id="${slotId}" class="select-subjects-btn w-full p-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">Select Subjects</button>
                <select data-slot-id="${slotId}" data-type="location" class="schedule-slot w-full p-1 text-xs border-gray-300 rounded-md" ${!Object.keys(locations).length ? 'disabled' : ''}>${locationOptions}</select>
            </div></td>`;
        }).join('')}</tr>`).join('');

        const timeHeaders = sortedTimeSlots.map(slot => `<th class="px-2 py-2 text-sm font-medium text-gray-600 border whitespace-nowrap">${slot.start}-${slot.end}</th>`).join('');

        scheduleView.innerHTML = `<table class="min-w-full border-collapse"><thead><tr class="bg-gray-100"><th class="px-2 py-2 text-sm font-semibold text-gray-600 border sticky left-0 bg-gray-100 z-10">Class/Time</th>${timeHeaders}</tr></thead><tbody>${tableBody}</tbody></table>`;
        
        classSchedule.forEach(entry => {
            const locationSelect = scheduleView.querySelector(`select[data-slot-id='${entry.slotId}'][data-type='location']`);
            if (locationSelect) locationSelect.value = entry.locationId || '';
        });
    }

    function renderSummaryGrid() {
        const summaryDiv = document.getElementById('summary-grid');
        const sortedTimeSlots = getSortedTimeSlots();

        if (!Object.keys(teachers).length) { summaryDiv.innerHTML = `<p class="text-gray-500 py-8 text-center">No teachers to display.</p>`; return; }
        if (sortedTimeSlots.length === 0) { summaryDiv.innerHTML = `<p class="text-gray-500 py-8 text-center">No time slots defined.</p>`; return; }

        const teacherSchedules = {};
        Object.keys(teachers).forEach(tid => {
            teacherSchedules[tid] = {};
            DAYS.forEach(day => {
                teacherSchedules[tid][day] = {};
                sortedTimeSlots.forEach(slot => {
                    teacherSchedules[tid][day][`${slot.start}-${slot.end}`] = [];
                });
            });
        });

        Object.values(schedule).forEach(entry => {
            const className = classes[entry.classId]?.name || '???';
            const locationName = locations[entry.locationId]?.name || '';
            const subjectIds = entry.subjectIds || [];

            subjectIds.forEach(subjectId => {
                const subject = subjects[subjectId];
                if (subject?.teacherIds) {
                    subject.teacherIds.forEach(tid => {
                        if (teacherSchedules[tid]?.[entry.day]?.[entry.time]) {
                            const text = `${subject.name} @ ${className} ${locationName ? `(${locationName})` : ''}`;
                            teacherSchedules[tid][entry.day][entry.time].push({ text, proceededWithClash: entry.proceededWithClash });
                        }
                    });
                }
            });
        });
        
        const timeHeaders = sortedTimeSlots.map(slot => `<th class="p-2 border font-semibold whitespace-nowrap">${slot.start}-${slot.end}</th>`).join('');
        const dayHeaders = DAYS.map(day => `<th colspan="${sortedTimeSlots.length}" class="p-2 border font-semibold text-center">${day}</th>`).join('');
        
        const summaryHtml = `
            <p class="text-xs text-gray-500 mb-2">Organic clashes (multiple assignments in one slot) are highlighted in <span class="text-red-600 font-semibold">red</span>. Overridden clashes are highlighted in <span class="text-yellow-600 font-semibold">yellow</span>.</p>
            <table class="min-w-full border-collapse text-xs">
                <thead>
                    <tr class="bg-gray-100">
                        <th rowspan="2" class="p-2 border font-semibold sticky left-0 bg-gray-100 z-20">Teacher</th>
                        ${dayHeaders}
                    </tr>
                    <tr class="bg-gray-100">
                        ${DAYS.map(() => timeHeaders).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(teachers).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([tid, teacher]) => `
                        <tr class="even:bg-gray-50">
                            <td class="p-2 border font-bold sticky left-0 z-10" style="background-color: inherit;">${teacher.name}</td>
                            ${DAYS.map(day => 
                                sortedTimeSlots.map(slot => {
                                    const time = `${slot.start}-${slot.end}`;
                                    if (slot.isBreak) return `<td class="p-1 border bg-green-50"></td>`;
                                    
                                    const assignments = teacherSchedules[tid]?.[day]?.[time] || [];
                                    const hasOverride = assignments.some(a => a.proceededWithClash);
                                    const isOrganicClash = assignments.length > 1;
                                    
                                    let cellClass = '';
                                    if(hasOverride) cellClass = 'summary-clash-override';
                                    else if (isOrganicClash) cellClass = 'summary-clash';

                                    const content = assignments.map(a => a.text).join('<br>');
                                    return `<td class="p-2 border align-middle text-center ${cellClass}" title="${day} ${time}">${content}</td>`;
                                }).join('')
                            ).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        summaryDiv.innerHTML = summaryHtml;
    }

    // --- Core Logic Functions ---
    async function handleLocationChange(e) {
        const selectEl = e.target;
        const { slotId } = selectEl.dataset;
        const newLocationId = selectEl.value;
        const [day, time] = slotId.split('_');
        
        const existingEntry = Object.entries(schedule).find(([, entry]) => entry.slotId === slotId && entry.classId === selectedClassId);
        const existingDocId = existingEntry ? existingEntry[0] : null;
        const existingData = existingDocId ? schedule[existingDocId] : {};
        
        let clashFound = false;
        let clashDetails = '';

        if (newLocationId) {
            const q = query(collection(db, getPath('schedule')), where("day", "==", day), where("time", "==", time), where("locationId", "==", newLocationId));
            const querySnapshot = await getDocs(q);
            for (const docSnap of querySnapshot.docs) {
                const entry = docSnap.data();
                if (entry.classId !== selectedClassId) {
                    clashFound = true;
                    clashDetails = `Location Clash: Location ${locations[newLocationId]?.name} is already booked for class ${classes[entry.classId]?.name} at this time.`;
                    break;
                }
            }
        }

        if (clashFound) {
            document.getElementById('clash-alert-message').textContent = clashDetails;
            toggleModal('clash-alert-modal', true);
            selectEl.value = existingData.locationId || '';
            return;
        }

        const schedulePath = getPath('schedule');
        const subjectIds = existingData.subjectIds || [];
        
        if (subjectIds.length > 0 || newLocationId) {
            const docRef = existingDocId ? doc(db, schedulePath, existingDocId) : doc(collection(db, schedulePath));
            await setDoc(docRef, { 
                ...existingData,
                day, time, slotId, 
                classId: selectedClassId, 
                locationId: newLocationId || null 
            }, { merge: true });
        } else if (existingDocId) {
            await deleteDoc(doc(db, schedulePath, existingDocId));
        }
    }

    async function handleSubjectSelectionSave(e) {
        e.preventDefault();
        const slotId = document.getElementById('modal-slot-id').value;
        const selectedSubjectIds = Array.from(e.target.querySelectorAll('input:checked')).map(el => el.value);
        const [day, time] = slotId.split('_');

        let clashFound = false;
        let clashDetails = [];
        const newTeachers = selectedSubjectIds.flatMap(sid => subjects[sid]?.teacherIds || []).filter((v, i, a) => a.indexOf(v) === i);

        if (newTeachers.length > 0) {
            const q = query(collection(db, getPath('schedule')), where("day", "==", day), where("time", "==", time));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(docSnap => {
                const entry = docSnap.data();
                if (entry.classId === selectedClassId) return;

                const scheduledSubjectIds = entry.subjectIds || [];
                const scheduledTeachers = scheduledSubjectIds.flatMap(sid => subjects[sid]?.teacherIds || []).filter(Boolean);
                const intersection = newTeachers.filter(tid => scheduledTeachers.includes(tid));

                if (intersection.length > 0) {
                    clashFound = true;
                    const teacherNames = intersection.map(tid => teachers[tid]?.name).join(', ');
                    const clashClass = classes[entry.classId]?.name;
                    clashDetails.push(`Teacher Clash: ${teacherNames} already scheduled for another class (${clashClass}).`);
                }
            });
        }
        
        if (clashFound) {
            openConfirmationModal(
                "Scheduling Clash Detected!",
                `Details:\n- ${[...new Set(clashDetails)].join('\n- ')}\n\nDo you want to proceed with this assignment anyway?`,
                "Proceed Anyway",
                () => {
                    saveScheduleEntry(slotId, selectedSubjectIds, true);
                },
                true
            );
        } else {
            await saveScheduleEntry(slotId, selectedSubjectIds, false);
        }

        toggleModal('subject-selection-modal', false);
    }

    async function saveScheduleEntry(slotId, subjectIds, proceededWithClash) {
        const [day, time] = slotId.split('_');
        const existingEntry = Object.entries(schedule).find(([, entry]) => entry.slotId === slotId && entry.classId === selectedClassId);
        const existingDocId = existingEntry ? existingEntry[0] : null;
        const schedulePath = getPath('schedule');
        const locationId = existingEntry ? schedule[existingDocId].locationId : null;

        if (subjectIds.length > 0 || locationId) {
            const docRef = existingDocId ? doc(db, schedulePath, existingDocId) : doc(collection(db, schedulePath));
            await setDoc(docRef, {
                day, time, slotId,
                classId: selectedClassId,
                subjectIds: subjectIds || [],
                locationId: locationId || null,
                proceededWithClash: proceededWithClash || false
            }, { merge: true });
        } else if (existingDocId) {
            await deleteDoc(doc(db, schedulePath, existingDocId));
        }
    }
    
    async function saveVersion(name) {
        if (!name) return;
        const versionData = { name, createdAt: Date.now(), data: { classes, teachers, subjects, locations, schedule, timeslots } };
        await addDoc(collection(db, getPath('versions')), versionData);
    }

    async function loadVersion(versionId) {
        const version = versions[versionId];
        if (!version) return;
        
        openConfirmationModal(
            `Load Schedule: "${version.name}"?`,
            "This will overwrite all current classes, teachers, subjects, locations, time slots and the schedule. This action cannot be undone.",
            "Load Version",
            async () => {
                await autoLoadVersionData(version.data, version.name, false);
                showToast(`Schedule version "${version.name}" loaded successfully!`);
            }
        );
    }

    async function autoLoadVersionData(versionData, versionName, isAutoLoad = true) {
        if (!versionData) return;

        const { classes: vClasses, teachers: vTeachers, subjects: vSubjects, locations: vLocations, schedule: vSchedule, timeslots: vTimeslots } = versionData;
        const collectionsToClear = ['classes', 'teachers', 'subjects', 'locations', 'schedule', 'timeslots'];
        const batch = writeBatch(db);

        for (const coll of collectionsToClear) {
            const snapshot = await getDocs(collection(db, getPath(coll)));
            snapshot.forEach(doc => batch.delete(doc.ref));
        }

        const addDataToBatch = (coll, data) => {
            if (data) {
                for (const [id, itemData] of Object.entries(data)) {
                    if (typeof itemData !== 'object' || itemData === null) continue;
                    const { id: docId, ...restOfData } = itemData;
                    batch.set(doc(db, getPath(coll), id), restOfData);
                }
            }
        };

        addDataToBatch('classes', vClasses);
        addDataToBatch('teachers', vTeachers);
        addDataToBatch('subjects', vSubjects);
        addDataToBatch('locations', vLocations);
        addDataToBatch('schedule', vSchedule);
        addDataToBatch('timeslots', vTimeslots || {});

        await batch.commit();
        if (isAutoLoad) {
            showToast(`Automatically loaded schedule: "${versionName}"`);
        }
    }
    
    function deleteVersion(versionId) {
        const version = versions[versionId];
        if (!version) return;
        openConfirmationModal(
            `Delete Schedule: "${version.name}"?`,
            "Are you sure you want to permanently delete this schedule version? This action cannot be undone.",
            "Delete",
            async () => {
                await deleteDoc(doc(db, getPath('versions'), versionId));
                showToast("Version deleted.");
            },
            true
        );
    }

    // --- UI & Utility Functions ---
    function toggleModal(modalId, show) { const modal = document.getElementById(modalId); if (!modal) return; const modalContent = modal.querySelector('.modal'); if (show) { modal.classList.remove('hidden'); setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 20); } else { modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); } }
    
    function openConfirmationModal(title, message, confirmText, onConfirm, isDestructive = false) {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        const confirmBtn = document.getElementById('confirmation-confirm-btn');
        confirmBtn.textContent = confirmText;
        confirmBtn.className = `px-4 py-2 text-sm rounded-md text-white ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'}`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.addEventListener('click', () => {
            onConfirm();
            toggleModal('confirmation-modal', false);
        });

        toggleModal('confirmation-modal', true);
    }

    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0', 'translate-y-4');
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => toast.classList.add('hidden'), 500);
        }, 3000);
    }

    function switchTab(targetTabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-content-${targetTabId}`).classList.remove('hidden');
        document.getElementById(`tab-${targetTabId}`).classList.add('active');
    }

    function attachEventListeners() {
        document.getElementById('add-class-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('class-name').value.trim(); if(name) await addDoc(collection(db, getPath('classes')), { name }); e.target.reset(); });
        document.getElementById('add-teacher-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('teacher-name').value.trim(); if(name) await addDoc(collection(db, getPath('teachers')), { name }); e.target.reset(); });
        document.getElementById('add-location-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('location-name').value.trim(); if(name) await addDoc(collection(db, getPath('locations')), { name }); e.target.reset(); });
        document.getElementById('add-subject-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('subject-name').value.trim(); if(name) await addDoc(collection(db, getPath('subjects')), { name, teacherIds: [] }); e.target.reset(); });
        document.getElementById('add-version-form').addEventListener('submit', async e => { e.preventDefault(); const name = document.getElementById('version-name').value.trim(); if(name) { await saveVersion(name); showToast('Schedule version saved!'); e.target.reset(); } });
        document.getElementById('add-timeslot-form').addEventListener('submit', async e => { e.preventDefault(); const start = document.getElementById('timeslot-start').value; const end = document.getElementById('timeslot-end').value; const isBreak = document.getElementById('timeslot-is-break').checked; if (start && end && start < end) { await addDoc(collection(db, getPath('timeslots')), { start, end, isBreak }); e.target.reset(); } else { showToast("Error: End time must be after start time."); }});

        document.getElementById('class-list').addEventListener('click', async e => { if (e.target.classList.contains('delete-class')) await deleteDoc(doc(db, getPath('classes'), e.target.dataset.id)); });
        document.getElementById('teacher-list').addEventListener('click', async e => { if (e.target.classList.contains('delete-teacher')) await deleteDoc(doc(db, getPath('teachers'), e.target.dataset.id)); });
        document.getElementById('location-list').addEventListener('click', async e => { if (e.target.classList.contains('delete-location')) await deleteDoc(doc(db, getPath('locations'), e.target.dataset.id)); });
        document.getElementById('timeslot-list').addEventListener('click', e => { if (e.target.classList.contains('delete-timeslot')) deleteDoc(doc(db, getPath('timeslots'), e.target.dataset.id)); if (e.target.classList.contains('edit-timeslot')) openEditTimeSlotModal(e.target.dataset.id);});
        
        document.getElementById('version-list').addEventListener('click', e => { if (e.target.classList.contains('load-version')) loadVersion(e.target.dataset.id); if (e.target.classList.contains('delete-version')) deleteVersion(e.target.dataset.id); });
        
        document.getElementById('subject-list').addEventListener('click', e => {
            if (e.target.classList.contains('delete-subject')) deleteDoc(doc(db, getPath('subjects'), e.target.dataset.id));
            if (e.target.classList.contains('assign-teachers')) {
                const subjectId = e.target.dataset.id; const subject = subjects[subjectId]; document.getElementById('modal-subject-name').textContent = subject.name; document.getElementById('modal-subject-id').value = subjectId;
                const listContainer = document.getElementById('modal-teacher-list');
                listContainer.innerHTML = Object.keys(teachers).length ? Object.entries(teachers).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, teacher]) => `<label class="flex items-center p-1.5 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="teacher" value="${id}" ${subject.teacherIds?.includes(id) ? 'checked' : ''} class="mr-2 h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><span>${teacher.name}</span></label>`).join('') : '<p class="text-sm text-gray-500">No teachers found to assign.</p>';
                toggleModal('teacher-assignment-modal', true);
            }
        });

        document.getElementById('tab-content-management').addEventListener('click', e => { if (e.target.classList.contains('edit-btn')) { openEditModal(e.target.dataset.id, e.target.dataset.name, e.target.dataset.collection); } });
        document.getElementById('class-selector').addEventListener('change', e => { selectedClassId = e.target.value; renderScheduleForClass(); });
        document.getElementById('schedule-view').addEventListener('change', e => { if (e.target.classList.contains('schedule-slot')) handleLocationChange(e); });
        document.getElementById('schedule-view').addEventListener('click', e => { if (e.target.classList.contains('select-subjects-btn')) openSubjectSelectionModal(e.target.dataset.slotId); });
        
        document.getElementById('subject-selection-form').addEventListener('submit', handleSubjectSelectionSave);
        
        // Tab Navigation
        document.getElementById('tab-schedule').addEventListener('click', () => switchTab('schedule')); 
        document.getElementById('tab-management').addEventListener('click', () => switchTab('management'));
        document.getElementById('tab-versions').addEventListener('click', () => switchTab('versions'));
        document.getElementById('tab-summary').addEventListener('click', () => switchTab('summary'));

        // Modal Buttons
        document.getElementById('teacher-assignment-form').addEventListener('submit', async e => { e.preventDefault(); const subjectId = document.getElementById('modal-subject-id').value; const teacherIds = Array.from(e.target.querySelectorAll('input:checked')).map(el => el.value); await updateDoc(doc(db, getPath('subjects'), subjectId), { teacherIds }); toggleModal('teacher-assignment-modal', false); });
        document.getElementById('edit-timeslot-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('edit-timeslot-id').value; const start = document.getElementById('edit-timeslot-start').value; const end = document.getElementById('edit-timeslot-end').value; const isBreak = document.getElementById('edit-timeslot-is-break').checked; if (id && start && end && start < end) { await updateDoc(doc(db, getPath('timeslots'), id), { start, end, isBreak }); toggleModal('timeslot-edit-modal', false); } else { showToast("Error: End time must be after start time."); }});
        document.getElementById('cancel-edit-timeslot-btn').addEventListener('click', () => toggleModal('timeslot-edit-modal', false));
        document.getElementById('cancel-modal-btn').addEventListener('click', () => toggleModal('teacher-assignment-modal', false)); 
        document.getElementById('close-clash-alert-btn').addEventListener('click', () => toggleModal('clash-alert-modal', false));
        document.getElementById('edit-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('edit-id').value; const collection = document.getElementById('edit-collection').value; const newName = document.getElementById('edit-name-input').value.trim(); if (id && collection && newName) { await updateDoc(doc(db, getPath(collection), id), { name: newName }); toggleModal('edit-modal', false); } });
        document.getElementById('cancel-edit-btn').addEventListener('click', () => toggleModal('edit-modal', false));
        document.getElementById('confirmation-cancel-btn').addEventListener('click', () => toggleModal('confirmation-modal', false));
        document.getElementById('cancel-subject-selection-btn').addEventListener('click', () => toggleModal('subject-selection-modal', false));
    }
    
    function openSubjectSelectionModal(slotId) {
        const [day, time] = slotId.split('_');
        document.getElementById('subject-modal-title').textContent = `Select Subjects for ${day} at ${time}`;
        document.getElementById('modal-slot-id').value = slotId;
        const existingEntry = Object.values(schedule).find(entry => entry.slotId === slotId && entry.classId === selectedClassId);
        const selectedIds = existingEntry?.subjectIds || [];
        const listContainer = document.getElementById('modal-subject-list');
        listContainer.innerHTML = Object.keys(subjects).length ? Object.entries(subjects).sort(([,a],[,b]) => a.name.localeCompare(b.name)).map(([id, subject]) => `<label class="flex items-center p-1.5 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="subject" value="${id}" ${selectedIds.includes(id) ? 'checked' : ''} class="mr-2 h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><span>${subject.name}</span></label>`).join('') : '<p class="text-sm text-gray-500">No subjects found.</p>';
        toggleModal('subject-selection-modal', true);
    }

    function openEditModal(id, name, collection) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-collection').value = collection;
        document.getElementById('edit-name-input').value = name;
        document.getElementById('edit-modal-title').textContent = `Edit ${collection.slice(0, -1)}`;
        toggleModal('edit-modal', true);
    }
    
    function openEditTimeSlotModal(id) {
        const slot = timeslots[id];
        if (!slot) return;
        document.getElementById('edit-timeslot-id').value = id;
        document.getElementById('edit-timeslot-start').value = slot.start;
        document.getElementById('edit-timeslot-end').value = slot.end;
        document.getElementById('edit-timeslot-is-break').checked = slot.isBreak;
        toggleModal('timeslot-edit-modal', true);
    }

    function initModals() {
        document.getElementById('modal-container').innerHTML = `
            <div id="teacher-assignment-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Assign Teachers to <span id="modal-subject-name" class="font-bold"></span></h3><form id="teacher-assignment-form"><input type="hidden" id="modal-subject-id"><div id="modal-teacher-list" class="space-y-1 max-h-64 overflow-y-auto mb-4 border p-3 rounded-md bg-gray-50"></div><div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-modal-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save</button></div></form></div></div>
            <div id="clash-alert-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg modal transform scale-95 opacity-0"><h3 class="text-lg font-medium text-red-700">Scheduling Clash Detected!</h3><p class="text-sm text-gray-600 mt-2" id="clash-alert-message"></p><div class="mt-5 text-right"><button type="button" id="close-clash-alert-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">OK</button></div></div></div>
            <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 id="edit-modal-title" class="text-lg font-semibold mb-4">Edit Name</h3><form id="edit-form"><input type="hidden" id="edit-id"><input type="hidden" id="edit-collection"><input type="text" id="edit-name-input" class="w-full p-2 border rounded-md" required><div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-edit-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button></div></form></div></div>
            <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0 whitespace-pre-wrap"><h3 id="confirmation-title" class="text-lg font-semibold mb-2">Confirmation</h3><p id="confirmation-message" class="text-sm text-gray-600 mb-4"></p><div class="flex justify-end gap-3 mt-4"><button type="button" id="confirmation-cancel-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="button" id="confirmation-confirm-btn" class="px-4 py-2 text-sm rounded-md text-white">Confirm</button></div></div></div>
            <div id="subject-selection-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4" id="subject-modal-title">Select Subjects</h3><form id="subject-selection-form"><input type="hidden" id="modal-slot-id"><div id="modal-subject-list" class="space-y-1 max-h-80 overflow-y-auto mb-4 border p-3 rounded-md bg-gray-50"></div><div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-subject-selection-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Subjects</button></div></form></div></div>
            <div id="timeslot-edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4">Edit Time Slot</h3><form id="edit-timeslot-form"><input type="hidden" id="edit-timeslot-id"><div class="space-y-3"><div class="flex gap-2 items-center"><input type="time" id="edit-timeslot-start" class="w-full p-2 text-sm border rounded-md" required><span>-</span><input type="time" id="edit-timeslot-end" class="w-full p-2 text-sm border rounded-md" required></div><div class="flex items-center"><input id="edit-timeslot-is-break" type="checkbox" class="h-4 w-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"><label for="edit-timeslot-is-break" class="ml-2 block text-sm text-gray-900">Mark as a break time</label></div></div><div class="flex justify-end gap-3 mt-4"><button type="button" id="cancel-edit-timeslot-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button></div></form></div></div>
            <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300 opacity-0 translate-y-4"></div>`; 
    }

    function setupDataListeners() {
        const collectionsToWatch = ['classes', 'teachers', 'subjects', 'schedule', 'locations', 'versions', 'timeslots'];
        collectionsToWatch.forEach(name => {
            onSnapshot(collection(db, getPath(name)), snapshot => {
                const dataObject = {};
                snapshot.forEach(doc => dataObject[doc.id] = {...doc.data(), id: doc.id});
                if (name === 'classes') classes = dataObject;
                if (name === 'teachers') teachers = dataObject;
                if (name === 'subjects') subjects = dataObject;
                if (name === 'schedule') schedule = dataObject;
                if (name === 'locations') locations = dataObject;
                if (name === 'versions') versions = dataObject;
                if (name === 'timeslots') timeslots = dataObject;
                renderAll();
            }, err => console.error(`Error fetching ${name}:`, err));
        });
    }

    async function initialAutoLoad() {
        const versionsRef = collection(db, getPath('versions'));
        const q = query(versionsRef, orderBy("createdAt", "desc"), limit(1));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            const latestVersionDoc = querySnapshot.docs[0];
            const latestVersion = latestVersionDoc.data();
            console.log("Found latest version to auto-load:", latestVersion.name);
            await autoLoadVersionData(latestVersion.data, latestVersion.name);
        } else {
            console.log("No saved versions found to auto-load.");
        }
    }
    
    async function main() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app); auth = getAuth(app);
            initModals(); attachEventListeners();
            onAuthStateChanged(auth, async (user) => {
                if (user) { 
                    userId = user.uid; 
                    await initialAutoLoad();
                    setupDataListeners(); 
                } 
                else { 
                    signInAnonymously(auth); 
                }
            });
        } catch (error) { console.error("Firebase initialization failed:", error); document.body.innerHTML = `<div class="p-8 text-center text-red-600">Failed to initialize Firebase. Check console.</div>`; }
    }

    main();
</script>
</body>
</html>


