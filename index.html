<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadual Anjal (Enhanced)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --background-color: #f0f2f5;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --header-bg: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .main-container {
            width: 100%;
            max-width: 1400px;
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }
        h2, h3 {
            color: var(--text-color);
            text-align: center;
        }
        #scheduleTitle {
            font-size: 2em;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        #userIdDisplay {
            text-align: center;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 20px;
            min-height: 1.2em;
        }
        .bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
        }
        .top-action-btn, .bar button {
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: #f8f9fa;
            color: var(--text-color);
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .top-action-btn:hover, .bar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #adb5bd;
        }
        #controlsToggler, #manualSaveBtn, #downloadPdfBtn, #clearScheduledNamesBtn {
             background-color: var(--primary-color);
             color: white;
             border-color: var(--primary-dark);
        }
        #downloadPdfBtn { background-color: #28a745; border-color: #1e7e34;}
        #clearScheduledNamesBtn { background-color: #6f42c1; border-color: #5a2a9e;}
        
        #collapsibleButtonBars {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        #collapsibleButtonBars.open {
            max-height: 500px; /* Adjust as needed */
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            min-width: 90px;
            position: relative;
        }
        th {
            background-color: var(--header-bg);
            font-weight: 600;
        }
        .date-header-cell {
             background-color: #cce0ff !important;
        }
        td.selected {
            outline: 3px solid var(--primary-color);
            background-color: #d1e7fd;
        }
        .table-tabs {
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            display: flex; flex-wrap: wrap; gap: 5px;
        }
        .table-tabs button {
            background-color: transparent; border: none;
            padding: 10px 15px; cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .table-tabs button.active {
            font-weight: bold;
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 25px; border-radius: 10px; width: 90%;
            max-width: 600px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; margin-bottom: 20px;
            cursor: move;
        }
        .modal-close-btn {
            font-size: 1.5rem; background: none; border: none; cursor: pointer;
        }
        .manager-tabs {
            display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;
        }
        .manager-tabs button {
             background: #f1f1f1; border: 1px solid var(--border-color);
             border-bottom: none; padding: 10px 15px;
             border-radius: 6px 6px 0 0; margin-right: 5px;
        }
        .manager-tabs button.active {
            background: var(--surface-color); font-weight: bold;
            border-bottom: 1px solid var(--surface-color);
        }
        .input-group { display: flex; margin-bottom: 15px; }
        .input-group input { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; }
        .input-group button { border-radius: 0 6px 6px 0; }
        .item-list .item, .subject-group-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #f1f1f1;
        }
        .item span { cursor: pointer; }
        .item span.highlighted { background-color: #cfe2ff; font-weight: bold; }
        .delete-item-btn, .delete-group-btn {
            background: #dc3545; color: white; border: none;
            padding: 5px 10px; border-radius: 5px;
        }
        .subject-group-item { flex-direction: column; align-items: stretch; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;}
        .group-header { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .group-teachers-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; }
        .save-group-changes-btn { background-color: #28a745; color: white; border: none; padding: 8px; border-radius: 5px; align-self: flex-end; }
        .highlight-conflict { background-color: #f8d7da !important; color: #721c24 !important; }
        .custom-message-box {
            display: none; position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%); background-color: #333; color: white;
            padding: 15px 25px; border-radius: 8px; z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        .custom-message-box.success { background-color: #28a745; }
        .custom-message-box.error { background-color: #dc3545; }
        #autocompleteSuggestions {
            display: none; position: absolute; border: 1px solid #ccc;
            background-color: white; z-index: 1001; max-height: 150px;
            overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .suggestion-item { padding: 8px; cursor: pointer; }
        .suggestion-item:hover, .suggestion-item.active-suggestion { background-color: #e9ecef; }
        #generalLoadingIndicator {
             display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(255,255,255,0.7); align-items: center; justify-content: center; z-index: 9999;
        }
        .spinner {
            border: 5px solid rgba(0,0,0,0.1); width: 40px; height: 40px;
            border-radius: 50%; border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="main-container">
    <h2 contenteditable="true" id="scheduleTitle">Jadual Anjal (Enhanced)</h2>
    <div id="userIdDisplay">User ID: Loading...</div>

    <div class="bar">
        <button id="controlsToggler" class="top-action-btn">Show Controls</button>
        <button id="manualSaveBtn" class="top-action-btn">Save Page</button>
        <button id="downloadPdfBtn" class="top-action-btn">PDF</button>
        <button id="clearScheduledNamesBtn" class="top-action-btn">Clear Names (All Tables)</button>
    </div>

    <div id="collapsibleButtonBars">
        <div class="bar">
            <button id="excelBtnTrigger">Export Excel</button>
            <button id="saveSharedScheduleBtn">Save Shared</button>
            <button id="loadSharedScheduleBtn">Load Shared</button>
        </div>
        <div class="bar">
            <button id="addTableBtn">Add Table</button>
            <button id="nameListBtn">Manage Teachers</button>
            <button id="subjectListBtn">Manage Subjects</button>
            <button id="subjectGroupsBtn">Manage Groups</button>
        </div>
    </div>
    
    <div class="bar table-tabs" id="tableTabs"></div>
    <div id="tablesContainer">
        <!-- Initial table will be generated by script -->
    </div>

    <h3>Teacher/Subject Attendance Summary</h3>
    <div id="summaryTableContainer">
        <table id="summaryTable"></table>
    </div>
</div>

<!-- Manager Modal for Teachers & Subjects -->
<div id="managerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="managerModalTitle">Manager</h3>
            <button id="closeManagerModalBtn" class="modal-close-btn">&times;</button>
        </div>
        <div class="manager-tabs">
            <button id="managerPagiTab" data-tab="pagi" class="active">Pagi</button>
            <button id="managerPetangTab" data-tab="petang">Petang</button>
            <button id="managerSubjectsTab" data-tab="subjects">Subjects</button>
        </div>
        <div class="input-group">
            <input id="managerNewItemInput" placeholder="Add new name/subject...">
            <button id="managerAddItemBtn">Add</button>
        </div>
        <input type="text" id="managerSearchInput" placeholder="Search..." style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 6px; border: 1px solid var(--border-color);">
        <div id="managerItemList" class="item-list"></div>
        <div id="loadingIndicatorManagerModal" class="spinner" style="display:none; margin: 20px auto;"></div>
    </div>
</div>

<!-- Subject Groups Modal -->
<div id="subjectGroupsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Subject Group Manager</h3>
            <button id="closeSubjectGroupsModalBtn" class="modal-close-btn">&times;</button>
        </div>
        <div class="input-group">
            <input id="newGroupName" placeholder="Create new group name...">
            <button id="createGroupBtn">Create</button>
        </div>
        <div id="subjectGroupsList"></div>
        <div id="loadingIndicatorGroupsModal" class="spinner" style="display:none; margin: 20px auto;"></div>
    </div>
</div>

<div id="customMessageBox" class="custom-message-box"></div>
<div id="generalLoadingIndicator"><div class="spinner"></div></div>
<div id="pdfContent" style="display: none;"></div>

<script type="module">
    // --- Firebase Module Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, getDoc, deleteDoc, updateDoc, query, serverTimestamp, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Initialization ---
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config.trim() !== '') {
        try {
            firebaseConfig = JSON.parse(__firebase_config);
            console.log("Using injected Firebase config (__firebase_config).");
        } catch (e) {
            console.error("Error parsing injected __firebase_config. Falling back. Error:", e);
            firebaseConfig = userProvidedFirebaseConfig;
        }
    } else {
        firebaseConfig = userProvidedFirebaseConfig;
        console.log("Using Firebase config defined in the script.");
    }
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.appId || 'default-shared-scheduler-app');
    if (typeof __app_id === 'undefined') {
        console.warn("Firebase Auth: __app_id is not defined. Using App ID from Firebase config or default.");
    }

    let fbApp, fbAuth, fbDb;
    let fbUserId = null;
    let fbIsAuthReady = false;
    let unsubscribePagiShared, unsubscribePetangShared, unsubscribeSubjects, unsubscribeGroups;

    try {
        fbApp = initializeApp(firebaseConfig);
        fbAuth = getAuth(fbApp);
        fbDb = getFirestore(fbApp);
    } catch (e) {
        console.error("CRITICAL Error initializing Firebase:", e);
        const userIdDisplayInitError = document.getElementById('userIdDisplay');
        if(userIdDisplayInitError) userIdDisplayInitError.textContent = "User ID: Firebase Init Error!";
    }

    // --- Global Variables & Constants ---
    const SCHEDULE_TITLE_KEY = `shared_jadual_title_${appId}`;
    const LAST_ACTIVE_SCHEDULE_ID_KEY = `last_active_schedule_id_${appId}`;
    
    let activeTableId = 'tbl_1';
    let tableCount = 1;
    let selectionMode = false;
    let selectedCells = [];
    let lastClickedCell = null;
    let selectedItemForInsertion = { type: null, name: null };
    let currentManagerTab = 'pagi'; // Can be 'pagi', 'petang', or 'subjects'
    
    // In-memory caches for Firestore data
    let namesPagiShared = [];
    let namesPetangShared = [];
    let subjectsShared = []; // Array of {id, name}
    let subjectGroupsShared = []; // Array of {id, name, subject, teachers}

    let isDraggingModal = false;
    let modalDragOffsetX, modalDragOffsetY;
    let autocompleteSuggestionsDiv = null;
    let activeCellForAutocomplete = null;
    let currentAutocompleteIndex = -1;
    
    let currentWorkingScheduleDocId = null;
    let autoSaveIntervalId = null;
    const AUTO_SAVE_INTERVAL = 60000; // 1 minute
    let isAutoSaving = false;
    let lastSavedState = null;
    let isInitialStateSet = false;

    // --- DOM Element References ---
    let scheduleTitleElement, tablesContainer, tableTabs, customMessageBox,
        userIdDisplayElement, generalLoadingIndicatorElement, pdfContentElement;

    // --- UTILITY FUNCTIONS ---
    function showMessage(message, type = 'info', duration = 3000) {
        if (!customMessageBox) customMessageBox = document.getElementById('customMessageBox');
        if (!customMessageBox) return;
        customMessageBox.textContent = message;
        customMessageBox.className = `custom-message-box ${type}`;
        customMessageBox.style.display = 'block';
        setTimeout(() => { if (customMessageBox) customMessageBox.style.display = 'none'; }, duration);
    }

    function customPrompt(message, defaultValue = "") { return prompt(message, defaultValue); }

    function customConfirm(message) {
        return new Promise((resolve) => {
            const confirmModalId = 'customConfirmModal';
            let existingModal = document.getElementById(confirmModalId);
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = confirmModalId;
            modal.style.cssText = `display: flex; position: fixed; z-index: 2001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;`;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `background-color: #fff; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 90%;`;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.marginBottom = '20px';
            
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.style.cssText = `padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; background-color: #28a745; color: white; border: none;`;
            
            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.style.cssText = `padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; background-color: #dc3545; color: white; border: none;`;

            const closeModal = (value) => { modal.remove(); resolve(value); };
            yesButton.onclick = () => closeModal(true);
            noButton.onclick = () => closeModal(false);

            modalContent.appendChild(messageP);
            modalContent.appendChild(yesButton);
            modalContent.appendChild(noButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        });
    }
    
    function showGeneralLoading(isLoading) {
        if (generalLoadingIndicatorElement) generalLoadingIndicatorElement.style.display = isLoading ? 'flex' : 'none';
    }

    function toggleButtonBarsVisibility() {
        const collapsibleBars = document.getElementById('collapsibleButtonBars');
        const toggler = document.getElementById('controlsToggler');
        if (!collapsibleBars || !toggler) return;
        const isOpen = collapsibleBars.classList.toggle('open');
        toggler.setAttribute('aria-expanded', isOpen.toString());
        toggler.textContent = isOpen ? 'Hide Controls' : 'Show Controls';
    }
    
    function showModalLoading(modalId, isLoading) {
        const indicator = document.getElementById(`loadingIndicator${modalId}`);
        if (indicator) indicator.style.display = isLoading ? 'flex' : 'none';
    }
    
    function ensureDateHeaderRowExists(tableElement) {
        if (!tableElement || !tableElement.tHead) return;
        let numCols = tableElement.tHead.rows[0]?.cells.length || 1;
        
        let dateRow = tableElement.tHead.querySelector('tr.date-header-row');
        if (!dateRow) {
            dateRow = tableElement.tHead.insertRow(0);
            dateRow.className = 'date-header-row';
            for (let i = 0; i < numCols; i++) {
                const th = document.createElement('th');
                th.className = 'date-header-cell';
                th.contentEditable = 'true';
                dateRow.appendChild(th);
            }
        }
    }
    
    function deselectAllTableCells() {
        selectedCells.forEach(c => c.classList.remove('selected'));
        selectedCells = [];
    }

    function captureCurrentState() {
        if (!tablesContainer || !scheduleTitleElement) return null;
        const state = {
            html: tablesContainer.innerHTML,
            tableMeta: {},
            activeTableId: activeTableId,
            scheduleTitle: scheduleTitleElement.textContent || ''
        };
        tablesContainer.querySelectorAll('table').forEach(table => {
            state.tableMeta[table.id] = { name: table.dataset.tableName || table.id };
        });
        return JSON.stringify(state);
    }

    function hasStateChanged(currentStateStringified) {
        if (!isInitialStateSet || !lastSavedState) return true;
        return currentStateStringified !== lastSavedState;
    }

    function _updateLocalStateAfterSave(docId, scheduleName, isAutoDraft, operationType) {
        lastSavedState = captureCurrentState();
        currentWorkingScheduleDocId = docId;
        if (docId) sessionStorage.setItem(LAST_ACTIVE_SCHEDULE_ID_KEY, docId);
        else sessionStorage.removeItem(LAST_ACTIVE_SCHEDULE_ID_KEY);
        
        let message = '';
        if (operationType === "explicit-save") message = `Shared schedule "${scheduleName}" saved!`;
        else if (operationType === "manual-save") message = `Page "${scheduleName}" saved!`;
        else if (operationType === "load") message = `Schedule "${scheduleName}" loaded!`;
        else if (operationType === "restore-from-backup") message = `Backup "${scheduleName}" loaded. Save to make changes permanent.`;
        if(message) showMessage(message, 'success', 5000);
    }

    // --- SUMMARY TABLE LOGIC ---

    function getTextForSummary(cellText) {
        if (typeof cellText !== 'string') return { names: [], subjects: [] };
        
        const mainContent = cellText.split(' // ')[0];
        const words = mainContent.split(/\s+/).filter(word => !word.startsWith('*') && word.trim() !== '');

        const allKnownTeachers = [...namesPagiShared, ...namesPetangShared];
        const allKnownSubjects = subjectsShared.map(s => s.name);

        let names = new Set();
        let subjects = new Set();
        let groupsFound = new Set();

        words.forEach(word => {
            const group = subjectGroupsShared.find(g => g.name === word);
            if (group) {
                groupsFound.add(word);
                group.teachers.forEach(teacher => names.add(teacher));
                if (group.subject) subjects.add(group.subject);
            } else if (allKnownTeachers.includes(word)) {
                names.add(word);
            } else if (allKnownSubjects.includes(word)) {
                subjects.add(word);
            }
        });

        return { names: Array.from(names), subjects: Array.from(subjects), groups: Array.from(groupsFound) };
    }

    function parseTimeToMinutes(timeStr) {
        if (typeof timeStr !== 'string') return Infinity;
        const match = timeStr.match(/^(\d{1,2})[:.](\d{2})/);
        if (match) return parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
        return Infinity;
    }

    function buildSummaryTableSkeleton(allNamesInSummary) {
        const summaryTable = document.getElementById('summaryTable');
        if (!summaryTable) return;
        summaryTable.innerHTML = ''; 

        const sortedNames = [...new Set(allNamesInSummary)].sort();
        
        let allHeaders = new Set();
        tablesContainer.querySelectorAll('table').forEach(table => {
            const headerRow = table.tHead.rows[1]; // Assumes date row is always first
            if (headerRow) {
                Array.from(headerRow.cells).slice(1).forEach(th => allHeaders.add(th.textContent.trim()));
            }
        });

        const sortedHeaders = Array.from(allHeaders).sort((a, b) => parseTimeToMinutes(a) - parseTimeToMinutes(b));
        const finalHeaders = ['Teacher/Subject', ...sortedHeaders];

        const thead = summaryTable.createTHead();
        const headerRow = thead.insertRow();
        finalHeaders.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        
        const tbody = summaryTable.createTBody();
        if (sortedNames.length === 0) {
            const tr = tbody.insertRow();
            const td = tr.insertCell();
            td.textContent = "No teachers or groups scheduled.";
            td.colSpan = finalHeaders.length || 1;
            td.style.textAlign = 'center';
        } else {
            sortedNames.forEach(name => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = name;
                for (let i = 1; i < finalHeaders.length; i++) {
                    tr.insertCell();
                }
            });
        }
    }
    
    function updateSummaryTableData(allEntries) {
        const summaryTable = document.getElementById('summaryTable');
        if (!summaryTable?.tHead?.rows[0]) return;

        const headers = Array.from(summaryTable.tHead.rows[0].cells).map(th => th.textContent.trim());
        const teacherRows = Array.from(summaryTable.tBodies[0].rows);

        teacherRows.forEach(row => {
            for (let i = 1; i < row.cells.length; i++) {
                row.cells[i].textContent = '';
                row.cells[i].classList.remove('highlight-conflict');
            }
        });

        allEntries.forEach(entry => {
            const row = teacherRows.find(r => r.cells[0].textContent === entry.name);
            if (!row) return;

            const colIndex = headers.indexOf(entry.time);
            if (colIndex > 0) {
                const cell = row.cells[colIndex];
                const subjectInfo = entry.subjects.length > 0 ? entry.subjects.join(', ') : (entry.groups.join(', ') || 'Task');
                const newContent = `${entry.classId} (${subjectInfo})`;

                if (cell.textContent) {
                    cell.textContent += ` | ${newContent}`;
                    cell.classList.add('highlight-conflict');
                } else {
                    cell.textContent = newContent;
                }
            }
        });
    }

    function rebuildAndRenderSummary() {
        let allEntries = [];
        let allNamesInSummary = new Set();

        tablesContainer.querySelectorAll('table').forEach(table => {
            const headerRow = table.tHead?.rows[1];
            if (!headerRow) return;
            const headers = Array.from(headerRow.cells).map(th => th.textContent.trim());

            table.tBodies[0]?.querySelectorAll('tr').forEach(dataRow => {
                const classId = dataRow.cells[0]?.textContent.trim();
                if (!classId) return;

                Array.from(dataRow.cells).slice(1).forEach((cell, index) => {
                    const cellContent = cell.querySelector('.merged-cell-overlay')?.textContent || cell.textContent;
                    const { names, subjects, groups } = getTextForSummary(cellContent);
                    const time = headers[index + 1];

                    if (names.length > 0) {
                        names.forEach(name => {
                            allNamesInSummary.add(name);
                            allEntries.push({ name, time, classId, subjects, groups });
                        });
                    }
                });
            });
        });
        
        buildSummaryTableSkeleton(Array.from(allNamesInSummary));
        updateSummaryTableData(allEntries);
    }
    
    // --- FIRESTORE INTERACTION FUNCTIONS ---
    async function saveListToFirestore(listType, itemsArray) {
        if (!fbDb || !fbIsAuthReady) { showMessage("Firebase not ready.", "error"); return; }
        showModalLoading('ManagerModal', true);
        const uniqueSortedItems = [...new Set(itemsArray.map(n => String(n||'').trim()).filter(n => n))].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
        
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedLists", listType);
        try {
            await setDoc(docRef, { items: uniqueSortedItems, lastUpdatedBy: fbUserId || "anonymous", updatedAt: serverTimestamp() });
            showMessage(`Shared ${listType} list updated.`, "success");
        } catch (error) {
            console.error(`Error saving shared list to ${listType}:`, error);
            showMessage(`Failed to save ${listType} list. Error: ${error.message}`, "error");
        } finally {
            showModalLoading('ManagerModal', false);
        }
    }

    async function addItemToFirestoreList(item) {
        const trimmedItem = String(item || '').trim();
        if (!trimmedItem) { showMessage("Item cannot be empty.", "info"); return; }
        
        let currentList;
        if (currentManagerTab === 'pagi') currentList = namesPagiShared;
        else if (currentManagerTab === 'petang') currentList = namesPetangShared;
        else if (currentManagerTab === 'subjects') currentList = subjectsShared.map(s => s.name);
        else return;

        if (currentList.map(i => String(i).toLowerCase()).includes(trimmedItem.toLowerCase())) {
            showMessage(`"${trimmedItem}" already exists.`, "info");
            return;
        }

        const updatedList = [...currentList, trimmedItem];
        await saveListToFirestore(currentManagerTab, updatedList);
        
        const newItemInput = document.getElementById('managerNewItemInput');
        if (newItemInput) {
            newItemInput.value = '';
            newItemInput.focus();
        }
    }

    async function deleteItemFromFirestoreList(itemToDelete) {
        const itemStr = String(itemToDelete || '');
        if (!await customConfirm(`Delete "${itemStr}" from the shared list? This will also remove it from all schedule tables.`)) return;

        let listType = '';
        let currentList;
        if (namesPagiShared.includes(itemStr)) { listType = 'pagi'; currentList = namesPagiShared; }
        else if (namesPetangShared.includes(itemStr)) { listType = 'petang'; currentList = namesPetangShared; }
        else if (subjectsShared.some(s => s.name === itemStr)) { listType = 'subjects'; currentList = subjectsShared.map(s => s.name); }
        else return;

        const updatedList = currentList.filter(item => String(item || '') !== itemStr);
        await saveListToFirestore(listType, updatedList);

        tablesContainer.querySelectorAll('tbody td, tbody th, .merged-cell-overlay').forEach(cell => {
            const cellText = cell.textContent.trim();
            const parts = cellText.split(' // ');
            let mainContent = parts[0];
            const remarkContent = parts.length > 1 ? ` // ${parts.slice(1).join(' // ')}` : '';
            const newMainContent = mainContent.split(/\s+/).filter(word => word !== itemStr).join(' ').trim();
            cell.textContent = (newMainContent + remarkContent).trim();
        });

        rebuildAndRenderSummary();
        if (selectedItemForInsertion.name === itemStr) clearItemSelection();
    }
    
    function listenToSharedList(listType, callback) {
        if (!fbDb || !fbIsAuthReady) return () => {};
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedLists", listType);
        return onSnapshot(docRef, (docSnap) => {
            const items = docSnap.exists() ? (docSnap.data().items || []) : [];
            const sanitizedItems = items.map(item => String(item || '').trim()).filter(Boolean);
            callback(sanitizedItems);
            if (listType === currentManagerTab) {
                renderManagerList(document.getElementById('managerSearchInput')?.value || '');
            }
            rebuildAndRenderSummary();
        }, (error) => {
            console.error(`Error listening to ${listType}:`, error);
        });
    }

    function listenToSubjectGroups() {
        if (!fbDb || !fbIsAuthReady) return () => {};
        const collRef = collection(fbDb, "artifacts", appId, "public/data/subjectGroups");
        return onSnapshot(query(collRef, orderBy("name")), (snapshot) => {
            subjectGroupsShared = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSubjectGroupsList();
            rebuildAndRenderSummary();
        }, (error) => {
            console.error("Error listening to subject groups:", error);
        });
    }

    async function createSubjectGroup(groupName) {
        const trimmedName = groupName.trim();
        if (!trimmedName) { showMessage("Group name cannot be empty.", "error"); return; }
        if (subjectGroupsShared.some(g => g.name === trimmedName)) { showMessage(`Group "${trimmedName}" already exists.`, "error"); return; }

        showModalLoading('GroupsModal', true);
        try {
            await addDoc(collection(fbDb, "artifacts", appId, "public/data/subjectGroups"), {
                name: trimmedName, subject: "", teachers: []
            });
            showMessage(`Group "${trimmedName}" created.`, "success");
            const newGroupNameInput = document.getElementById('newGroupName');
            if(newGroupNameInput) newGroupNameInput.value = '';
        } catch (error) {
            console.error("Error creating group:", error);
            showMessage("Failed to create group.", "error");
        } finally {
            showModalLoading('GroupsModal', false);
        }
    }

    async function updateSubjectGroup(groupId, newSubject, newTeachers) {
        showModalLoading('GroupsModal', true);
        try {
            const docRef = doc(fbDb, "artifacts", appId, "public/data/subjectGroups", groupId);
            await updateDoc(docRef, { subject: newSubject, teachers: newTeachers });
            showMessage("Group updated.", "success");
        } catch (error) {
            console.error("Error updating group:", error);
            showMessage("Failed to update group.", "error");
        } finally {
            showModalLoading('GroupsModal', false);
        }
    }

    async function deleteSubjectGroup(groupId, groupName) {
        if (!await customConfirm(`Are you sure you want to delete the group "${groupName}"?`)) return;
        
        showModalLoading('GroupsModal', true);
        try {
            await deleteDoc(doc(fbDb, "artifacts", appId, "public/data/subjectGroups", groupId));
            showMessage(`Group "${groupName}" deleted.`, "success");
        } catch (error) {
            console.error("Error deleting group:", error);
            showMessage("Failed to delete group.", "error");
        } finally {
            showModalLoading('GroupsModal', false);
        }
    }

    // --- SCHEDULE & BACKUP FIRESTORE FUNCTIONS (simplified for brevity) ---
    async function saveSharedScheduleToFirestore() {
        // ... (This logic can be reused from your original script)
    }

    async function autoSaveCurrentSchedule() {
        // ... (This logic can be reused from your original script)
    }

    // --- UI & MODAL MANAGEMENT ---
    function openManagerModal(tabToOpen) {
        handleManagerTabSwitch(tabToOpen);
        const modal = document.getElementById('managerModal');
        if (modal) modal.style.display = 'flex';
    }

    function handleManagerTabSwitch(tab) {
        currentManagerTab = tab;
        const modalTitle = document.getElementById('managerModalTitle');
        const tabs = document.querySelectorAll('.manager-tabs button');
        const searchInput = document.getElementById('managerSearchInput');
        const newItemInput = document.getElementById('managerNewItemInput');

        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
        
        if (tab === 'pagi') modalTitle.textContent = 'Teacher Manager (Pagi)';
        else if (tab === 'petang') modalTitle.textContent = 'Teacher Manager (Petang)';
        else if (tab === 'subjects') modalTitle.textContent = 'Subject Manager';

        if (searchInput) searchInput.value = '';
        if (newItemInput) newItemInput.focus();
        renderManagerList();
    }
    
    function renderManagerList(filterText = '') {
        const itemListContainer = document.getElementById('managerItemList');
        if (!itemListContainer) return;
        
        let itemsToRender;
        if (currentManagerTab === 'pagi') itemsToRender = namesPagiShared;
        else if (currentManagerTab === 'petang') itemsToRender = namesPetangShared;
        else if (currentManagerTab === 'subjects') itemsToRender = subjectsShared.map(s=>s.name);
        else return;

        const normalizedFilter = filterText.toLowerCase().trim();
        const filteredItems = itemsToRender.filter(item => String(item).toLowerCase().includes(normalizedFilter));
        
        itemListContainer.innerHTML = '';
        if (filteredItems.length === 0) {
            itemListContainer.innerHTML = `<p>No items found.</p>`;
            return;
        }

        filteredItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            const safeItem = String(item).replace(/"/g, '&quot;');
            itemDiv.innerHTML = `
                <span data-name="${safeItem}" title="Select '${safeItem}'">${item}</span>
                <button class="delete-item-btn" data-name-delete="${safeItem}" title="Delete '${safeItem}'">Delete</button>
            `;
            itemListContainer.appendChild(itemDiv);
        });
        highlightSelectedItemInList();
    }

    function renderSubjectGroupsList() {
        const container = document.getElementById('subjectGroupsList');
        if (!container) return;
        container.innerHTML = '';

        if (subjectGroupsShared.length === 0) {
            container.innerHTML = '<p>No subject groups created yet.</p>';
            return;
        }

        subjectGroupsShared.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'subject-group-item';
            
            let subjectOptions = '<option value="">-- Select Subject --</option>';
            subjectsShared.map(s => s.name).forEach(s => {
                subjectOptions += `<option value="${s}" ${group.subject === s ? 'selected' : ''}>${s}</option>`;
            });
            
            let teacherCheckboxes = '<h4>Teachers</h4>';
            const allTeachers = [...new Set([...namesPagiShared, ...namesPetangShared])].sort();
            allTeachers.forEach(teacher => {
                const isChecked = group.teachers.includes(teacher);
                teacherCheckboxes += `<label><input type="checkbox" value="${teacher}" ${isChecked ? 'checked' : ''}>${teacher}</label>`;
            });

            groupDiv.innerHTML = `
                <div class="group-header"><h4>${group.name}</h4><button class="delete-group-btn" data-group-id="${group.id}" data-group-name="${group.name}">Delete Group</button></div>
                <label>Subject:</label><select class="group-subject-select" data-group-id="${group.id}">${subjectOptions}</select>
                <div class="group-teachers-list">${teacherCheckboxes}</div>
                <button class="save-group-changes-btn" data-group-id="${group.id}">Save Changes</button>
            `;
            container.appendChild(groupDiv);
        });
    }

    // --- SELECTION & AUTOCOMPLETE ---
    function selectItemForCellInsertion(type, name) {
        selectedItemForInsertion = { type, name: String(name || '') };
        highlightSelectedItemInList();
        showMessage(`Selected "${name}". Click cell to insert.`, 'info', 4000);
    }

    function clearItemSelection() {
        selectedItemForInsertion = { type: null, name: null };
        highlightSelectedItemInList();
    }
    
    function highlightSelectedItemInList() {
        const listContainer = document.getElementById('managerItemList');
        if (!listContainer) return;
        listContainer.querySelectorAll('.item span').forEach(span => {
            span.classList.toggle('highlighted', span.dataset.name === selectedItemForInsertion.name);
        });
    }

    function showCellAutocompleteSuggestions(cell, inputText) {
        if (!autocompleteSuggestionsDiv) return;
        const textForMatching = inputText.split(' // ')[0].toLowerCase().trim();
        if (!textForMatching) { hideCellAutocompleteSuggestions(); return; }

        const allTeachers = [...namesPagiShared, ...namesPetangShared];
        const allSubjects = subjectsShared.map(s => s.name);
        const allGroups = subjectGroupsShared.map(g => g.name);

        const allSuggestions = [...new Set([
            ...allGroups.filter(n => n.toLowerCase().startsWith(textForMatching)),
            ...allSubjects.filter(n => n.toLowerCase().startsWith(textForMatching)),
            ...allTeachers.filter(n => n.toLowerCase().startsWith(textForMatching))
        ])];

        if (allSuggestions.length > 0) {
            activeCellForAutocomplete = cell;
            autocompleteSuggestionsDiv.innerHTML = '';
            allSuggestions.slice(0, 10).forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.addEventListener('mousedown', (e) => { e.preventDefault(); selectCellAutocompleteSuggestion(suggestion); });
                autocompleteSuggestionsDiv.appendChild(item);
            });
            const cellRect = cell.getBoundingClientRect();
            autocompleteSuggestionsDiv.style.left = `${cellRect.left + window.scrollX}px`;
            autocompleteSuggestionsDiv.style.top = `${cellRect.bottom + window.scrollY}px`;
            autocompleteSuggestionsDiv.style.display = 'block';
            currentAutocompleteIndex = -1;
        } else {
            hideCellAutocompleteSuggestions();
        }
    }

    function hideCellAutocompleteSuggestions() {
        if (autocompleteSuggestionsDiv) autocompleteSuggestionsDiv.style.display = 'none';
        activeCellForAutocomplete = null;
        currentAutocompleteIndex = -1;
    }

    function selectCellAutocompleteSuggestion(suggestion) {
        if (!activeCellForAutocomplete) return;
        const target = activeCellForAutocomplete.querySelector('.merged-cell-overlay') || activeCellForAutocomplete;
        
        const currentText = target.textContent;
        const remarkPart = currentText.includes(' // ') ? currentText.substring(currentText.indexOf(' // ')) : '';
        
        target.textContent = suggestion + remarkPart;
        
        hideCellAutocompleteSuggestions();
        rebuildAndRenderSummary();
        
        target.focus();
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(target);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
    }
    
    // --- TABLE MANIPULATION ---
    function addTabButton(id, label) {
        if (!tableTabs) return;
        const button = document.createElement('button');
        button.textContent = label;
        button.dataset.tableId = id;
        button.onclick = () => switchTable(id);
        tableTabs.appendChild(button);
    }

    function switchTable(id) {
        if (!document.getElementById(id)) return;
        activeTableId = id;
        tablesContainer.querySelectorAll('table').forEach(t => t.classList.toggle('active', t.id === id));
        tableTabs.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.tableId === id));
        deselectAllTableCells();
    }

    function addNewTable(isInitial = false) {
        const label = isInitial ? "Friday, 26 September 2025" : customPrompt('Enter new table name:', `Schedule ${tableCount + 1}`);
        if (!label && !isInitial) return;
        tableCount++;
        const newTable = document.createElement('table');
        newTable.id = `tbl_${Date.now()}`;
        newTable.dataset.tableName = label;
        const thead = newTable.createTHead();
        
        const dateRow = thead.insertRow();
        dateRow.className = 'date-header-row';
        const dateCell = document.createElement('th');
        dateCell.className = 'date-header-cell';
        dateCell.colSpan = 5;
        dateCell.contentEditable = 'true';
        dateCell.textContent = label;
        dateRow.appendChild(dateCell);

        const headerRow = thead.insertRow();
        ['Class', '08:00', '09:00', '10:00', '11:00'].forEach(text => {
            const th = document.createElement('th');
            th.contentEditable = 'true';
            th.textContent = text;
            headerRow.appendChild(th);
        });
        const tbody = newTable.createTBody();
        ['5S1', '5S2'].forEach(className => {
            const tr = tbody.insertRow();
            const classCell = tr.insertCell();
            classCell.contentEditable = true;
            classCell.textContent = className;
            for(let i=0; i<4; i++) {
                const td = tr.insertCell();
                td.contentEditable = 'true';
            }
        });

        tablesContainer.appendChild(newTable);
        addTabButton(newTable.id, label);
        switchTable(newTable.id);
    }
    
    // --- INITIALIZATION ---
    function initializeEventListeners() {
        document.getElementById('controlsToggler')?.addEventListener('click', toggleButtonBarsVisibility);
        document.getElementById('manualSaveBtn')?.addEventListener('click', () => { /* Add manual save logic */ });
        document.getElementById('downloadPdfBtn')?.addEventListener('click', generateSchedulePdf);
        document.getElementById('excelBtnTrigger')?.addEventListener('click', exportActiveTableToExcel);
        document.getElementById('saveSharedScheduleBtn')?.addEventListener('click', saveSharedScheduleToFirestore);
        document.getElementById('addTableBtn')?.addEventListener('click', () => addNewTable());
        document.getElementById('nameListBtn')?.addEventListener('click', () => openManagerModal('pagi'));
        document.getElementById('subjectListBtn')?.addEventListener('click', () => openManagerModal('subjects'));
        document.getElementById('subjectGroupsBtn')?.addEventListener('click', () => document.getElementById('subjectGroupsModal').style.display = 'flex');

        document.getElementById('closeManagerModalBtn')?.addEventListener('click', () => document.getElementById('managerModal').style.display = 'none');
        document.getElementById('managerPagiTab')?.addEventListener('click', () => handleManagerTabSwitch('pagi'));
        document.getElementById('managerPetangTab')?.addEventListener('click', () => handleManagerTabSwitch('petang'));
        document.getElementById('managerSubjectsTab')?.addEventListener('click', () => handleManagerTabSwitch('subjects'));
        document.getElementById('managerAddItemBtn')?.addEventListener('click', () => {
            const input = document.getElementById('managerNewItemInput');
            if (input) addItemToFirestoreList(input.value);
        });
        document.getElementById('managerItemList')?.addEventListener('click', e => {
            const span = e.target.closest('.item span[data-name]');
            const button = e.target.closest('.delete-item-btn[data-name-delete]');
            if (span) selectItemForCellInsertion(currentManagerTab, span.dataset.name);
            else if (button) deleteItemFromFirestoreList(button.dataset.nameDelete);
        });
        
        document.getElementById('closeSubjectGroupsModalBtn')?.addEventListener('click', () => document.getElementById('subjectGroupsModal').style.display = 'none');
        document.getElementById('createGroupBtn')?.addEventListener('click', () => {
            const input = document.getElementById('newGroupName');
            if (input) createSubjectGroup(input.value);
        });
        document.getElementById('subjectGroupsList')?.addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-group-btn');
            const saveBtn = e.target.closest('.save-group-changes-btn');
            if (deleteBtn) deleteSubjectGroup(deleteBtn.dataset.groupId, deleteBtn.dataset.groupName);
            if (saveBtn) {
                const groupId = saveBtn.dataset.groupId;
                const groupItem = saveBtn.closest('.subject-group-item');
                const subject = groupItem.querySelector('.group-subject-select').value;
                const teachers = Array.from(groupItem.querySelectorAll('.group-teachers-list input:checked')).map(cb => cb.value);
                updateSubjectGroup(groupId, subject, teachers);
            }
        });

        tablesContainer.addEventListener('click', (e) => {
            const cell = e.target.closest('td, th');
            if (!cell) return;
            lastClickedCell = cell;
            if (selectedItemForInsertion.name && (cell.tagName === 'TD' || cell.closest('tbody'))) {
                const target = cell.querySelector('.merged-cell-overlay') || cell;
                const currentText = target.textContent;
                const remarkPart = currentText.includes(' // ') ? currentText.substring(currentText.indexOf(' // ')) : '';
                target.textContent = selectedItemForInsertion.name + " " + remarkPart;
                rebuildAndRenderSummary();
                clearItemSelection();
            }
        });

        tablesContainer.addEventListener('input', e => {
            const cell = e.target.closest('td, th, .merged-cell-overlay');
            if(cell && cell.isContentEditable) {
                showCellAutocompleteSuggestions(cell, cell.textContent);
            }
        });
        
        tablesContainer.addEventListener('blur', () => {
             setTimeout(hideCellAutocompleteSuggestions, 150);
             setTimeout(rebuildAndRenderSummary, 0);
        }, true);
        
        document.addEventListener('keydown', e => {
            if (autocompleteSuggestionsDiv?.style.display !== 'block') return;
            const items = autocompleteSuggestionsDiv.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentAutocompleteIndex = (currentAutocompleteIndex + 1) % items.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentAutocompleteIndex = (currentAutocompleteIndex - 1 + items.length) % items.length;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentAutocompleteIndex > -1) {
                    selectCellAutocompleteSuggestion(items[currentAutocompleteIndex].textContent);
                }
                hideCellAutocompleteSuggestions();
            } else if (e.key === 'Escape') {
                hideCellAutocompleteSuggestions();
            }
            items.forEach((item, index) => item.classList.toggle('active-suggestion', index === currentAutocompleteIndex));
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        scheduleTitleElement = document.getElementById('scheduleTitle');
        tablesContainer = document.getElementById('tablesContainer');
        tableTabs = document.getElementById('tableTabs');
        customMessageBox = document.getElementById('customMessageBox');
        userIdDisplayElement = document.getElementById('userIdDisplay');
        generalLoadingIndicatorElement = document.getElementById('generalLoadingIndicator');
        pdfContentElement = document.getElementById('pdfContent');
        autocompleteSuggestionsDiv = document.createElement('div');
        autocompleteSuggestionsDiv.id = 'autocompleteSuggestions';
        document.body.appendChild(autocompleteSuggestionsDiv);

        addNewTable(true); // Create the initial table on load
        initializeEventListeners();

        if (fbAuth) {
            onAuthStateChanged(fbAuth, async (user) => {
                if (user) {
                    fbUserId = user.uid;
                    fbIsAuthReady = true;
                    if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: ${fbUserId}`;

                    unsubscribePagiShared?.();
                    unsubscribePetangShared?.();
                    unsubscribeSubjects?.();
                    unsubscribeGroups?.();

                    unsubscribePagiShared = listenToSharedList('pagi', (items) => namesPagiShared = items);
                    unsubscribePetangShared = listenToSharedList('petang', (items) => namesPetangShared = items);
                    unsubscribeSubjects = listenToSharedList('subjects', (items) => subjectsShared = items.map(name => ({id: name, name})));
                    unsubscribeGroups = listenToSubjectGroups();

                } else {
                    fbIsAuthReady = false;
                    fbUserId = null;
                    if(userIdDisplayElement) userIdDisplayElement.textContent = "Authenticating...";
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(fbAuth, __initial_auth_token);
                        } else {
                            await signInAnonymously(fbAuth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        if(userIdDisplayElement) userIdDisplayElement.textContent = `Auth Error`;
                    }
                }
            });
        }
    });
</script>
</body>
</html>

