<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.1, maximum-scale=5.0">
  <title>Jadual Anjal ‚Äî Fixed Safe Version</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <style>
    :root{
      --pri:#007bff; --pri-600:#0056b3; --bg:#f0f2f5; --card:#fff;
      --text:#1c1e21; --muted:#6c757d; --line:#dee2e6; --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    }
    body{margin:0;padding:0;background:var(--bg);font-family:Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px}
    h2{margin:0 0 8px}
    #userIdDisplay{font-size:.9em;color:#555;margin:4px 0 16px;min-height:1.2em;word-break:break-all}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:stretch;justify-content:center;margin:8px 0}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid transparent;cursor:pointer;white-space:nowrap;
         display:inline-flex;align-items:center;justify-content:center;gap:8px;font-weight:500;min-height:40px;flex:1 1 150px}
    .btn-pri{color:#fff;background-image:linear-gradient(90deg,var(--pri),var(--pri-600))}
    .btn-sec{background:#f8f9fa;border-color:#ced4da;color:#212529}
    .btn-ok{color:#fff;background-image:linear-gradient(90deg,#17a2b8,#117a8b)}
    .btn-pdf{color:#fff;background-image:linear-gradient(90deg,#28a745,#1e7e34)}
    .btn-warn{background:#fd7e14;color:#fff}
    .btn-ghost{background:transparent;color:var(--pri);border:1px dashed var(--pri)}
    .tabs{display:flex;gap:6px;border-bottom:2px solid var(--pri);margin:8px 0}
    .tabs button{background:transparent;border:none;border-bottom:3px solid transparent;border-radius:6px 6px 0 0;color:var(--pri-600);padding:8px 12px}
    .tabs button.active{background:var(--pri);color:#fff;border-color:var(--pri-600)}
    table{width:100%;border-collapse:collapse;margin:14px 0;background:#fff;table-layout:auto}
    th,td{border:1px solid var(--line);padding:8px 10px;text-align:center;min-width:90px;font-size:.9em;position:relative}
    thead th{background:#f8f9fa;font-weight:600}
    .leftCol{background:#e6f7ff;font-weight:700}
    .selected{outline:3px solid var(--pri);background:#d1e7fd}
    .chip{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid #0001}
    .chip.warn{background:#fff3cd}
    .toast{display:none;position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#333;color:#fff;
           padding:10px 16px;border-radius:8px;z-index:3000}
    .toast.show{display:block}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2500;align-items:center;justify-content:center}
    .modal .content{width:min(800px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:12px;padding:16px}
    .blink-dot{width:14px;height:14px;border-radius:50%;background:#28a745;display:inline-block;animation:blinker 1s linear infinite}
    @keyframes blinker { 50%{opacity:.3} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 id="scheduleTitle" contenteditable="true">Jadual Anjal</h2>
      <div id="userIdDisplay">User ID: <span id="userIdText">Loading‚Ä¶</span> <span class="blink-dot"></span></div>
      <div class="bar">
        <button id="toggleControls" class="btn btn-pri">Show Controls</button>
        <button id="btnSavePage" class="btn btn-ok">Save Page</button>
        <button id="btnPDF" class="btn btn-pdf">PDF</button>
        <button id="btnClearNamesAll" class="btn btn-warn">Clear Names (All)</button>
        <button id="btnSearchTimetable" class="btn btn-pri">üîç Search Timetable</button>
        <button id="btnManageSubjects" class="btn btn-ghost">üìö Manage Subjects & Groups</button>
      </div>
      <table id="tbl_1">
        <thead>
          <tr><th>Class</th><th>08:00</th><th>09:00</th></tr>
        </thead>
        <tbody>
          <tr><td class="leftCol">5S1</td><td></td><td>JAMES</td></tr>
          <tr><td class="leftCol">5S2</td><td>*SpecialAssembly</td><td></td></tr>
        </tbody>
      </table>
      <h3>Teacher/Subject Attendance Summary</h3>
      <table id="summaryTable"></table>
    </div>
  </div>
  <div id="toast" class="toast">Saved.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const fallbackConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };
    let firebaseConfig;
    if (typeof window.__firebase_config === "string" && window.__firebase_config.trim()) {
      try { firebaseConfig = JSON.parse(window.__firebase_config); }
      catch(e){ firebaseConfig = fallbackConfig; }
    } else { firebaseConfig = fallbackConfig; }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userIdText = document.getElementById("userIdText");
    async function ensureAuth(){
      return new Promise((resolve) => {
        onAuthStateChanged(auth, async (u) => {
          if (u){ userIdText.textContent = u.uid; resolve(u); }
          else { await signInAnonymously(auth); }
        });
      });
    }
    ensureAuth();
  </script>
</body>
</html>
