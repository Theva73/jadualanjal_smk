<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Timetable Viewer (from Firestore)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            white-space: nowrap;
        }
        tbody td, tbody th {
            height: 6rem; /* 96px */
            padding: 0.25rem;
            vertical-align: middle;
            font-size: 0.75rem;
        }
        .long-break-cell {
            background-color: #FEF3C7 !important; /* Amber 100 */
            color: #92400E; /* Amber 800 */
            font-weight: 700;
        }
        .schedule-cell {
            background-color: #e0f2fe;
            color: #0c4a6e;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.25rem;
            line-height: 1.2;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        .rehat-slot {
             background-color: #FEF9C3 !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">

            <div class="mb-6 text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Teacher Schedule Viewer</h1>
                <p id="loading-status" class="text-gray-600">Loading schedules from database...</p>
            </div>
            
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label for="teacher-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Teacher</label>
                <select id="teacher-select" class="block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <option value="">-- Loading --</option>
                </select>
            </div>

            <div class="overflow-x-auto">
                <table id="schedule-table" class="w-full min-w-[1400px] border-collapse border border-gray-300 text-center text-xs sm:text-sm">
                    <thead>
                        <tr>
                            <th class="p-2 border border-gray-300" rowspan="2"></th>
                            <th class="p-2 border border-gray-300 font-semibold">1</th>
                            <th class="p-2 border border-gray-300 font-semibold">2</th>
                            <th class="p-2 border border-gray-300 font-semibold">3</th>
                            <th class="p-2 border border-gray-300 font-semibold">4</th>
                            <th class="p-2 border border-gray-300 font-semibold">5</th>
                            <th class="p-2 border border-gray-300 font-semibold">6</th>
                            <th class="p-2 border border-gray-300 font-semibold">6*</th>
                            <th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th>
                            <th class="p-2 border border-gray-300 font-semibold">7</th>
                            <th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th>
                            <th class="p-2 border border-gray-300 font-semibold">7*</th>
                            <th class="p-2 border border-gray-300 font-semibold">8</th>
                            <th class="p-2 border border-gray-300 font-semibold">9</th>
                            <th class="p-2 border border-gray-300 font-semibold">10</th>
                            <th class="p-2 border border-gray-300 font-semibold">11</th>
                            <th class="p-2 border border-gray-300 font-semibold">12</th>
                            <th class="p-2 border border-gray-300 font-semibold">13</th>
                            <th class="p-2 border border-gray-300 font-semibold">14</th>
                            <th class="p-2 border border-gray-300 font-semibold">15</th>
                            <th class="p-2 border border-gray-300 font-semibold">16</th>
                        </tr>
                        <tr>
                            <td class="p-1 border border-gray-300 font-medium">7:00<br>7:15</td>
                            <td class="p-1 border border-gray-300 font-medium">7:15<br>7:45</td>
                            <td class="p-1 border border-gray-300 font-medium">7:45<br>8:15</td>
                            <td class="p-1 border border-gray-300 font-medium">8:15<br>8:45</td>
                            <td class="p-1 border border-gray-300 font-medium">8:45<br>9:15</td>
                            <td class="p-1 border border-gray-300 font-medium">9:15<br>9:45</td>
                            <td class="p-1 border border-gray-300 font-medium">9:45<br>10:15</td>
                            <td class="p-1 border border-gray-300 font-medium bg-amber-100">9:45<br>10:00</td>
                            <td class="p-1 border border-gray-300 font-medium">10:00<br>10:15</td>
                            <td class="p-1 border border-gray-300 font-medium bg-amber-100">10:15<br>10:30</td>
                            <td class="p-1 border border-gray-300 font-medium">10:00<br>10:30</td>
                            <td class="p-1 border border-gray-300 font-medium">10:30<br>11:00</td>
                            <td class="p-1 border border-gray-300 font-medium">11:00<br>11:30</td>
                            <td class="p-1 border border-gray-300 font-medium">11:30<br>12:00</td>
                            <td class="p-1 border border-gray-300 font-medium">12:00<br>12:30</td>
                            <td class="p-1 border border-gray-300 font-medium">12:30<br>1:00</td>
                            <td class="p-1 border border-gray-300 font-medium">1:00<br>1:30</td>
                            <td class="p-1 border border-gray-300 font-medium">1:30<br>2:00</td>
                            <td class="p-1 border border-gray-300 font-medium">2:00<br>2:30</td>
                            <td class="p-1 border border-gray-300 font-medium">2:30<br>3:00</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-day="Mo">
                            <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Mo</th>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                            <td class="rehat-slot"></td><td></td><td class="rehat-slot"></td><td></td>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        </tr>
                        <tr data-day="Tu">
                            <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Tu</th>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                            <td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T1, T2 & T4</div></td>
                            <td></td>
                            <td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T3 & T5</div></td>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        </tr>
                        <tr data-day="We">
                            <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">We</th>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        </tr>
                        <tr data-day="Th">
                            <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Th</th>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        </tr>
                        <tr data-day="Fr">
                            <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Fr</th>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                            <td class="rehat-slot"></td><td></td><td class="rehat-slot"></td><td></td>
                            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between mt-4 text-xs text-gray-500">
                <p>Bermula pada 29 September 2025</p>
                <p>aSc Timetables</p>
            </div>
        </div>
    </div>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your web app's Firebase configuration from your SDK file
    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let teacherSchedules = {};
    const teacherSelect = document.getElementById('teacher-select');
    const loadingStatus = document.getElementById('loading-status');

    // Sign in the user anonymously and fetch data
    onAuthStateChanged(auth, user => {
        if (user) {
            const schedulesCollection = collection(db, "schedules");
            onSnapshot(schedulesCollection, (querySnapshot) => {
                teacherSchedules = {}; // Clear previous data
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use the 'name' field from the document as the key
                    if (data.name) {
                       teacherSchedules[data.name] = data;
                    }
                });
                
                setupUI();

            }, (error) => {
                console.error("Error fetching schedules: ", error);
                loadingStatus.textContent = "Error loading schedules from the database.";
                teacherSelect.innerHTML = '<option value="">-- Error --</option>';
            });

        } else {
            signInAnonymously(auth).catch((error) => {
                console.error("Anonymous sign-in failed:", error);
                loadingStatus.textContent = "Authentication failed. Cannot load data.";
            });
        }
    });
    
    function setupUI() {
        teacherSelect.innerHTML = '<option value="">-- Select a Teacher --</option>'; // Reset
        
        const teachersWithSchedules = Object.keys(teacherSchedules).sort();

        if (teachersWithSchedules.length === 0) {
            loadingStatus.innerHTML = "No schedules found in the database. <br>Please use the 'firestore_data_uploader_fixed.html' file to upload them.";
            teacherSelect.innerHTML = '<option value="">-- No Teachers Found --</option>';
            teacherSelect.disabled = true;
            return;
        }

        teachersWithSchedules.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            teacherSelect.appendChild(option);
        });

        teacherSelect.disabled = false;
        loadingStatus.textContent = `Loaded ${teachersWithSchedules.length} schedules successfully from the database.`;

        teacherSelect.addEventListener('change', () => {
            const teacherName = teacherSelect.value;
            resetTable();
            if (teacherName && teacherSchedules[teacherName]) {
                displaySchedule(teacherSchedules[teacherName]);
            }
        });
    }


    function resetTable() {
        document.querySelectorAll('#schedule-table tbody td').forEach(cell => {
            cell.innerHTML = '';
            cell.style.display = ''; 
            cell.removeAttribute('colspan');
            cell.classList.remove('schedule-cell');
        });
    }
    
    function displaySchedule(scheduleData) {
        const periodToColumn = { 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, "6*": 7, 7: 9, "7*": 11, 8: 12, 9: 13, 10: 14, 11: 15, 12: 16, 13: 17, 14: 18, 15: 19, 16: 20 };

        // Days of the week to iterate through
        const days = ["Mo", "Tu", "We", "Th", "Fr"];

        days.forEach(day => {
            const row = document.querySelector(`tr[data-day="${day}"]`);
            if (!row) return;

            const daySchedule = scheduleData[day];
            if (!Array.isArray(daySchedule)) return; // Safety check
            
            const cells = Array.from(row.querySelectorAll('td'));

            daySchedule.forEach(item => {
                const colIdx = periodToColumn[item.period];
                if (colIdx === undefined) return;

                let cellIndex;
                 if (['Tu', 'We', 'Th'].includes(day)) {
                    if (colIdx >= 11) { cellIndex = colIdx - 3; } 
                    else if (colIdx >= 8) { cellIndex = colIdx - 2; }
                    else { cellIndex = colIdx - 1; }
                } else {
                     if (colIdx >= 11) { cellIndex = colIdx - 2; }
                     else if (colIdx >= 8) { cellIndex = colIdx - 1; }
                     else { cellIndex = colIdx - 1; }
                }

                const targetCell = cells[cellIndex];
                if (!targetCell || targetCell.classList.contains('rehat-slot') || targetCell.classList.contains('long-break-cell')) {
                    return; 
                }

                targetCell.innerHTML = `<div class="schedule-cell"><span>${item.text.replace(/[\s/]+/g, '<br>')}</span></div>`;
                
                if (item.span && item.span > 1) {
                    targetCell.setAttribute('colspan', item.span);
                    for (let i = 1; i < item.span; i++) {
                        const nextCell = cells[cellIndex + i];
                        if (nextCell) {
                            nextCell.style.display = 'none';
                        }
                    }
                }
            });
        });
    }
</script>

</body>
</html>

