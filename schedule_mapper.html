<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Schedule Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); white-space: nowrap; }
        
        .sticky-day { position: -webkit-sticky; position: sticky; left: 0; z-index: 10; }
        .day-row { border-bottom: 2px solid #cbd5e1; }
        .day-row:last-child { border-bottom: 1px solid #d1d5db; }

        tbody td, tbody th { height: 6rem; padding: 0.25rem; vertical-align: middle; font-size: 0.75rem; }
        
        .schedule-cell { background-color: #e0f2fe; color: #0c4a6e; border-radius: 0.5rem; padding: 0.35rem; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; cursor: pointer; border: 1px solid #bae6fd; transition: background-color 0.2s; gap: 2px; }
        .schedule-cell:hover { background-color: #c0eaff; }
        .schedule-item { word-break: break-word; max-width: 100%; }

        .empty-cell { cursor: pointer; height: 100%; width: 100%; position: relative; }
        .empty-cell:hover .add-icon { opacity: 1; }
        .add-icon, .paste-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.2s; }
        .add-icon { opacity: 0.15; }
        .paste-btn { opacity: 0.6; background-color: #dbeafe; color: #1e40af; border-radius: 9999px; padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
        .paste-btn:hover { opacity: 1; background-color: #bfdbfe;}

        .long-break-cell { background-color: #FEF3C7 !important; color: #92400E; font-weight: 700; }
        .rehat-slot { background-color: #FEF9C3 !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown-checkbox-menu { display: none; }
        .dropdown-checkbox-menu.show { display: block; }
        .dropdown-checkbox-menu label { display: block; padding: 0.5rem; cursor: pointer; border-radius: 4px; }
        .dropdown-checkbox-menu label:hover { background-color: #f3f4f6; }
        .dropdown-checkbox-menu input { margin-right: 0.5rem; }
        #paste-mode-indicator { transition: opacity 0.3s, transform 0.3s; }
        #uploader-status { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <header class="mb-4 text-center border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Advanced Schedule Editor</h1>
                <div id="loading-status" class="text-gray-600">Connecting to database...</div>
            </header>

            <div class="mb-6 border-b">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-schedule-btn" class="tab-btn active px-3 py-2 font-semibold text-sm rounded-t-md">Schedule</button>
                    <button id="tab-management-btn" class="tab-btn px-3 py-2 font-semibold text-sm rounded-t-md">Management</button>
                </nav>
            </div>

            <div id="tab-schedule-content">
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-end gap-4">
                        <div class="flex-grow">
                            <label for="teacher-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Teacher</label>
                            <select id="teacher-select" class="block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                                <option value="">-- Loading --</option>
                            </select>
                        </div>
                        <button id="open-uploader-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center hover:bg-teal-600 transition-colors whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            <span>Uploader</span>
                        </button>
                        <div id="paste-mode-indicator" class="hidden opacity-0 transform translate-y-2">
                            <button id="cancel-paste-btn" class="bg-yellow-500 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Cancel Paste
                            </button>
                        </div>
                    </div>
                </div>
                <div id="schedule-container" class="overflow-x-auto">
                    <div id="loader" class="loader"></div>
                    <table id="schedule-table" class="hidden w-full min-w-[1400px] border-collapse border border-gray-300 text-center text-xs sm:text-sm">
                        <!-- Table Head -->
                        <thead>
                            <tr class="divide-x divide-gray-300">
                                <th class="p-2 border border-gray-300 sticky-day bg-white" rowspan="2">Day</th>
                                <th class="p-2 border border-gray-300 font-semibold"></th>
                                <th class="p-2 border border-gray-300 font-semibold">1</th>
                                <th class="p-2 border border-gray-300 font-semibold">2</th>
                                <th class="p-2 border border-gray-300 font-semibold">3</th>
                                <th class="p-2 border border-gray-300 font-semibold">4</th>
                                <th class="p-2 border border-gray-300 font-semibold">5</th>
                                <th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th>
                                <th class="p-2 border border-gray-300 font-semibold">6</th>
                                <th class="p-2 border border-gray-300 font-semibold">6*</th>
                                <th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th>
                                <th class="p-2 border border-gray-300 font-semibold">7</th>
                                <th class="p-2 border border-gray-300 font-semibold">8</th>
                                <th class="p-2 border border-gray-300 font-semibold">9</th>
                                <th class="p-2 border border-gray-300 font-semibold">10</th>
                                <th class="p-2 border border-gray-300 font-semibold">11</th>
                                <th class="p-2 border border-gray-300 font-semibold">12</th>
                                <th class="p-2 border border-gray-300 font-semibold">13</th>
                                <th class="p-2 border border-gray-300 font-semibold">14</th>
                                <th class="p-2 border border-gray-300 font-semibold">15</th>
                                <th class="p-2 border border-gray-300 font-semibold">16</th>
                            </tr>
                            <tr class="divide-x divide-gray-300">
                                <td class="p-1 border border-gray-300 font-medium">7:00<br>7:15</td>
                                <td class="p-1 border border-gray-300 font-medium">7:15<br>7:45</td>
                                <td class="p-1 border border-gray-300 font-medium">7:45<br>8:15</td>
                                <td class="p-1 border border-gray-300 font-medium">8:15<br>8:45</td>
                                <td class="p-1 border border-gray-300 font-medium">8:45<br>9:15</td>
                                <td class="p-1 border border-gray-300 font-medium">9:15<br>9:45</td>
                                <td class="p-1 border border-gray-300 font-medium bg-amber-100">9:45<br>10:00</td>
                                <td class="p-1 border border-gray-300 font-medium">9:45<br>10:15</td>
                                <td class="p-1 border border-gray-300 font-medium">10:00<br>10:30</td>
                                <td class="p-1 border border-gray-300 font-medium bg-amber-100">10:15<br>10:30</td>
                                <td class="p-1 border border-gray-300 font-medium">10:30<br>11:00</td>
                                <td class="p-1 border border-gray-300 font-medium">11:00<br>11:30</td>
                                <td class="p-1 border border-gray-300 font-medium">11:30<br>12:00</td>
                                <td class="p-1 border border-gray-300 font-medium">12:00<br>12:30</td>
                                <td class="p-1 border border-gray-300 font-medium">12:30<br>1:00</td>
                                <td class="p-1 border border-gray-300 font-medium">1:00<br>1:30</td>
                                <td class="p-1 border border-gray-300 font-medium">1:30<br>2:00</td>
                                <td class="p-1 border border-gray-300 font-medium">2:00<br>2:30</td>
                                <td class="p-1 border border-gray-300 font-medium">2:30<br>3:00</td>
                                <td class="p-1 border border-gray-300 font-medium">3:00<br>3:30</td>
                            </tr>
                        </thead>
                        <tbody id="schedule-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="tab-management-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Subjects</h3>
                        <form id="add-subject-form" class="flex gap-2 mb-3"><input type="text" id="subject-name-input" placeholder="New subject name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                        <div id="subject-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Classes</h3>
                        <form id="add-class-form" class="flex gap-2 mb-3"><input type="text" id="class-name-input" placeholder="New class name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                        <div id="class-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Locations</h3>
                        <form id="add-location-form" class="flex gap-2 mb-3"><input type="text" id="location-name-input" placeholder="New location name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                        <div id="location-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="mt-8 p-4 bg-red-50 rounded-lg border border-red-200">
                    <h3 class="text-lg font-semibold mb-3 text-red-800">Danger Zone</h3>
                    <p class="text-sm text-red-700 mb-4">Clearing a teacher's schedule is permanent and cannot be undone.</p>
                    <button id="clear-schedule-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">Clear Selected Teacher's Schedule</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95 opacity-0">
            <h3 class="text-lg font-semibold mb-4" id="modal-title">Edit Entry</h3>
            <form id="edit-form">
                <input type="hidden" id="modal-teacher-id"><input type="hidden" id="modal-original-day"><input type="hidden" id="modal-entry-index">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div><label for="modal-day-select" class="text-sm font-medium">Day</label><select id="modal-day-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
                     <div><label for="modal-period-select" class="text-sm font-medium">Time Slot</label><select id="modal-period-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
                </div>
                <div class="space-y-4">
                    <div class="relative"><label class="text-sm font-medium">Subjects</label><button type="button" id="subjects-dropdown-btn" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-left bg-white">Select Subjects</button><div id="subjects-dropdown-menu" class="dropdown-checkbox-menu absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div></div>
                    <div class="relative"><label class="text-sm font-medium">Classes</label><button type="button" id="classes-dropdown-btn" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-left bg-white">Select Classes</button><div id="classes-dropdown-menu" class="dropdown-checkbox-menu absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div></div>
                    <div><label for="modal-location-select" class="text-sm font-medium">Location</label><select id="modal-location-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div>
                </div>
                <div id="double-slot-container" class="mt-4"><label class="flex items-center"><input type="checkbox" id="add-double-slot" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><span class="ml-2 text-sm text-gray-700">Add Double Slot (fills next time slot too)</span></label></div>
                <div class="flex justify-between items-center flex-wrap gap-3 mt-6">
                    <div class="flex gap-2 flex-wrap"><button type="button" id="delete-entry-btn" class="px-4 py-2 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">Delete</button><button type="button" id="copy-entry-btn" class="px-4 py-2 text-sm rounded-md bg-yellow-500 text-white hover:bg-yellow-600">Copy Slot</button><button type="button" id="extend-entry-btn" class="px-4 py-2 text-sm rounded-md bg-sky-500 text-white hover:bg-sky-600">Extend Slot</button></div>
                    <div class="flex gap-3"><button type="button" id="cancel-edit-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button></div>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 modal"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95 opacity-0"><h3 id="confirm-title" class="text-lg font-semibold mb-2 text-gray-800">Confirm Action</h3><p id="confirm-message" class="text-gray-600 mb-6">Are you sure?</p><div class="flex justify-end items-center gap-3"><button type="button" id="cancel-confirm-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="button" id="confirm-action-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">Confirm</button></div></div></div>
    <div id="uploader-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4 modal"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 opacity-0"><div class="flex justify-between items-center p-4 border-b"><h3 class="text-lg font-semibold text-gray-800">Intelligent Schedule Uploader</h3><button id="close-uploader-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold p-2 leading-none">&times;</button></div><div class="p-6 space-y-4"><p class="text-sm text-gray-600">Select your JSON file. This tool will automatically map schedule details to their IDs before uploading.</p><div><label for="json-file-input" class="block text-sm font-medium text-gray-700 mb-1">Schedule JSON File</label><input type="file" id="json-file-input" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/></div><button id="upload-to-firestore-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">Upload to Firestore</button><div class="bg-gray-100 p-3 rounded-lg mt-4 max-h-48 overflow-y-auto"><pre id="uploader-status" class="text-xs text-gray-700">Ready to upload.</pre></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, writeBatch, query, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let db, auth, loadingTimeout;
    let schedules = {}, subjects = {}, classes = {}, locations = {};
    let selectedTeacherId = null;
    let copiedSlot = null;
    let pendingConfirmationAction = null;
    
    const PERIOD_MAP = { "P": "P (7:00-7:15)", "1": "1 (7:15-7:45)", "2": "2 (7:45-8:15)", "3": "3 (8:15-8:45)", "4": "4 (8:45-9:15)", "5": "5 (9:15-9:45)", "R1": "REHAT (9:45-10:00)", "6": "6 (9:45-10:15)", "6*": "6* (10:00-10:30)", "R2": "REHAT (10:15-10:30)", "7": "7 (10:30-11:00)", "8": "8 (11:00-11:30)", "9": "9 (11:30-12:00)", "10": "10 (12:00-12:30)", "11": "11 (12:30-1:00)", "12": "12 (1:00-1:30)", "13": "13 (1:30-2:00)", "14": "14 (2:00-2:30)", "15": "15 (2:30-3:00)","16": "16 (3:00-3:30)" };
    const DAYS = ["Mo", "Tu", "We", "Th", "Fr"];
    const PERIOD_ORDER = ["P", "1", "2", "3", "4", "5", "R1", "6", "6*", "R2", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16"];

    function main() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();
            loadingTimeout = setTimeout(() => { if (document.getElementById('loader').style.display !== 'none') { handleLoadingError('Error: Could not connect to the database.'); } }, 10000);
            onAuthStateChanged(auth, user => { if (user) { setupDataListeners(); } else { signInAnonymously(auth).catch(err => { console.error("Auth failed", err); handleLoadingError('Authentication Failed.'); }); } });
        } catch (error) { console.error("Firebase Init Failed:", error); handleLoadingError('Firebase Initialization Failed.'); }
    }

    function handleLoadingError(message) { clearTimeout(loadingTimeout); document.getElementById('loader').style.display = 'none'; document.getElementById('loading-status').innerHTML = `<strong class="text-red-600">${message}</strong>`; document.getElementById('teacher-select').innerHTML = '<option>Connection Failed</option>'; document.getElementById('schedule-table').classList.add('hidden'); }

    function setupDataListeners() {
        onSnapshot(collection(db, "schedules"), snapshot => { clearTimeout(loadingTimeout); schedules = {}; snapshot.forEach(doc => schedules[doc.id] = { id: doc.id, ...doc.data() }); updateTeacherDropdown(); if(selectedTeacherId) { renderScheduleForTeacher(selectedTeacherId); } else { buildStaticTable(); } document.getElementById('loader').style.display = 'none'; document.getElementById('schedule-table').classList.remove('hidden'); }, err => handleLoadingError("Error fetching schedule data."));
        onSnapshot(collection(db, "subjects"), s => { subjects = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])); renderManagementList('subject', subjects, document.getElementById('subject-list')); }, err => handleLoadingError("Error fetching subjects."));
        onSnapshot(collection(db, "classes"), s => { classes = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])); renderManagementList('class', classes, document.getElementById('class-list')); }, err => handleLoadingError("Error fetching classes."));
        onSnapshot(collection(db, "locations"), s => { locations = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])); renderManagementList('location', locations, document.getElementById('location-list')); }, err => handleLoadingError("Error fetching locations."));
    }
    
    function setupEventListeners() {
        document.getElementById('tab-schedule-btn').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('tab-management-btn').addEventListener('click', () => switchTab('management'));
        document.getElementById('teacher-select').addEventListener('change', (e) => renderScheduleForTeacher(e.target.value));
        document.getElementById('schedule-tbody').addEventListener('click', (e) => { const targetCell = e.target.closest('td'); if (!targetCell || !selectedTeacherId) return; const day = targetCell.closest('tr').dataset.day; const period = getPeriodFromCell(day, targetCell); if (!period) return; if (e.target.closest('.paste-btn')) handlePasteClick(day, period); else if (!targetCell.classList.contains('long-break-cell')) openEditModal(day, period, e.target.closest('.schedule-cell')?.dataset.index); });
        document.getElementById('edit-form').addEventListener('submit', handleSave);
        document.getElementById('cancel-edit-btn').addEventListener('click', () => toggleModal('edit-modal', false));
        document.getElementById('delete-entry-btn').addEventListener('click', handleDeleteClick);
        document.getElementById('copy-entry-btn').addEventListener('click', handleCopyClick);
        document.getElementById('extend-entry-btn').addEventListener('click', handleExtendClick);
        document.getElementById('cancel-paste-btn').addEventListener('click', () => { copiedSlot = null; updatePasteButtonsVisibility(false); });
        document.getElementById('add-subject-form').addEventListener('submit', e => handleAddManagementItem(e, 'subject'));
        document.getElementById('add-class-form').addEventListener('submit', e => handleAddManagementItem(e, 'class'));
        document.getElementById('add-location-form').addEventListener('submit', e => handleAddManagementItem(e, 'location'));
        document.getElementById('subject-list').addEventListener('click', handleDeleteManagementClick);
        document.getElementById('class-list').addEventListener('click', handleDeleteManagementClick);
        document.getElementById('location-list').addEventListener('click', handleDeleteManagementClick);
        document.getElementById('subjects-dropdown-btn').addEventListener('click', () => toggleDropdown('subjects'));
        document.getElementById('classes-dropdown-btn').addEventListener('click', () => toggleDropdown('classes'));
        document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) { document.getElementById('subjects-dropdown-menu').classList.remove('show'); document.getElementById('classes-dropdown-menu').classList.remove('show'); } });
        document.getElementById('subjects-dropdown-menu').addEventListener('change', () => updateDropdownButtonText('subjects'));
        document.getElementById('classes-dropdown-menu').addEventListener('change', () => updateDropdownButtonText('classes'));
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => { pendingConfirmationAction = null; toggleModal('confirm-modal', false); });
        document.getElementById('clear-schedule-btn').addEventListener('click', handleClearScheduleClick);
        document.getElementById('confirm-action-btn').addEventListener('click', handleConfirmAction);
        document.getElementById('open-uploader-btn').addEventListener('click', () => toggleModal('uploader-modal', true));
        document.getElementById('close-uploader-btn').addEventListener('click', () => toggleModal('uploader-modal', false));
        document.getElementById('upload-to-firestore-btn').addEventListener('click', handleFileUpload);
    }

    // --- NEW UPLOADER LOGIC ---
    async function handleFileUpload() {
        const fileInput = document.getElementById('json-file-input');
        const statusEl = document.getElementById('uploader-status');
        const uploadBtn = document.getElementById('upload-to-firestore-btn');

        if (fileInput.files.length === 0) {
            statusEl.textContent = 'Please select a JSON file first.';
            return;
        }

        const file = fileInput.files[0];
        statusEl.textContent = `Reading file: ${file.name}...`;
        uploadBtn.disabled = true;

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const importedSchedules = JSON.parse(event.target.result);
                
                const existingTeachers = {};
                for (const teacherId in schedules) {
                    const teacher = schedules[teacherId];
                    existingTeachers[teacher.name.toUpperCase().trim()] = { id: teacher.id, data: teacher };
                }

                statusEl.textContent = `Found ${Object.keys(existingTeachers).length} existing teachers.\nPreparing updates with improved matching...`;
                
                const batch = writeBatch(db);
                let updatedCount = 0;
                let notFound = [];
                let successfulMatches = [];

                for (const teacherName in importedSchedules) {
                    const importedUpperCaseName = teacherName.toUpperCase().trim();
                    const dbTeacherKey = Object.keys(existingTeachers).find(name => importedUpperCaseName.startsWith(name) || name.startsWith(importedUpperCaseName));
                    const teacherInfo = dbTeacherKey ? existingTeachers[dbTeacherKey] : null;

                    if (teacherInfo) {
                        const teacherRef = doc(db, "schedules", teacherInfo.id);
                        const newScheduleData = importedSchedules[teacherName];
                        const finalSchedule = {};
                        
                        for(const day in newScheduleData){
                            if(DAYS.includes(day)) {
                                finalSchedule[day] = newScheduleData[day].map(entry => {
                                    const details = entry.details || "";
                                    const subjectIds = Object.values(subjects).filter(s => details.includes(s.name)).map(s => s.id);
                                    const classIds = Object.values(classes).filter(c => details.includes(c.name)).map(c => c.id);
                                    const location = Object.values(locations).find(l => details.toUpperCase().includes(l.name.toUpperCase()));
                                    return {
                                        period: entry.period,
                                        subjectIds,
                                        classIds,
                                        locationId: location ? location.id : null
                                    };
                                });
                            }
                        }

                        batch.update(teacherRef, finalSchedule);
                        updatedCount++;
                        successfulMatches.push(`'${teacherName}' matched with '${teacherInfo.data.name}'`);
                    } else {
                        notFound.push(teacherName);
                    }
                }

                await batch.commit();

                let message = `✅ Success! ${updatedCount} schedules were updated.\n`;
                if (successfulMatches.length > 0) {
                    message += `\nSuccessful Matches:\n- ${successfulMatches.join('\n- ')}`;
                }
                if (notFound.length > 0) {
                    message += `\n\n⚠️ Could not find these ${notFound.length} teachers:\n- ${notFound.join('\n- ')}`;
                }
                statusEl.textContent = message;
                fileInput.value = '';

            } catch (error) {
                console.error("Upload failed:", error);
                statusEl.textContent = `❌ Error: ${error.message}`;
            } finally {
                uploadBtn.disabled = false;
            }
        };

        reader.onerror = () => {
            statusEl.textContent = '❌ Error: Failed to read the file.';
            uploadBtn.disabled = false;
        };

        reader.readAsText(file);
    }
    
    // --- Other functions from previous version ---
    async function handleConfirmAction() { if (!pendingConfirmationAction) return; const { action, payload } = pendingConfirmationAction; const confirmBtn = document.getElementById('confirm-action-btn'); confirmBtn.disabled = true; confirmBtn.textContent = 'Deleting...'; try { if (action === 'deleteManagementItem') { const { type: itemType, id: itemId } = payload; const batch = writeBatch(db); const schedulesSnapshot = await getDocs(collection(db, "schedules")); schedulesSnapshot.forEach(scheduleDoc => { const scheduleData = scheduleDoc.data(); let scheduleModified = false; const updatedScheduleData = {}; DAYS.forEach(day => { if (Array.isArray(scheduleData[day])) { const newDaySchedule = scheduleData[day].map(entry => { const newEntry = { ...entry }; let entryModified = false; if (itemType === 'subject' && newEntry.subjectIds?.includes(itemId)) { newEntry.subjectIds = newEntry.subjectIds.filter(id => id !== itemId); entryModified = true; } else if (itemType === 'class' && newEntry.classIds?.includes(itemId)) { newEntry.classIds = newEntry.classIds.filter(id => id !== itemId); entryModified = true; } else if (itemType === 'location' && newEntry.locationId === itemId) { newEntry.locationId = null; entryModified = true; } if(entryModified) scheduleModified = true; return newEntry; }); updatedScheduleData[day] = newDaySchedule; } }); if (scheduleModified) { batch.update(scheduleDoc.ref, updatedScheduleData); } }); await batch.commit(); const collectionName = itemType === 'class' ? 'classes' : `${itemType}s`; await deleteDoc(doc(db, collectionName, itemId)); } else if (action === 'clearSchedule') { await updateDoc(doc(db, "schedules", payload.teacherId), { Mo: [], Tu: [], We: [], Th: [], Fr: [] }); } else if (action === 'deleteScheduleEntry') { const daySchedule = [...schedules[payload.teacherId][payload.day]]; daySchedule.splice(payload.index, 1); await updateDoc(doc(db, "schedules", payload.teacherId), { [payload.day]: daySchedule.length > 0 ? daySchedule : [] }); toggleModal('edit-modal', false); } } catch (error) { console.error("Confirmation action failed:", error); alert("An error occurred. Please check the console."); } finally { pendingConfirmationAction = null; confirmBtn.disabled = false; toggleModal('confirm-modal', false); } }
    function handleDeleteManagementClick(e) { const btn = e.target.closest('.delete-management-item'); if (!btn) return; const { id, type } = btn.dataset; pendingConfirmationAction = { action: 'deleteManagementItem', payload: { id, type } }; document.getElementById('confirm-title').textContent = 'Confirm Deletion'; document.getElementById('confirm-message').textContent = `Are you sure you want to delete this ${type}? This will remove it from ALL schedules. This action cannot be undone.`; const confirmBtn = document.getElementById('confirm-action-btn'); confirmBtn.textContent = 'Yes, Delete'; confirmBtn.className = 'bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700'; toggleModal('confirm-modal', true); }
    async function handleAddManagementItem(e, type) { e.preventDefault(); const input = e.target.querySelector('input'); const name = input.value.trim(); if (!name) return; try { const collectionName = type === 'class' ? 'classes' : `${type}s`; await addDoc(collection(db, collectionName), { name }); input.value = ''; } catch(error) { console.error(`Error adding ${type}:`, error); } }
    const periodToCellIndex = { "P": 1, "1": 2, "2": 3, "3": 4, "4": 5, "5": 6, "R1": 7, "6": 8, "6*": 9, "R2": 10, "7": 11, "8": 12, "9": 13, "10": 14, "11": 15, "12": 16, "13": 17, "14": 18, "15": 19, "16": 20 };
    function renderManagementList(type, data, container) { container.innerHTML = ''; const sortedData = Object.values(data).sort((a,b) => a.name.localeCompare(b.name)); if (sortedData.length === 0) { container.innerHTML = `<p class="text-sm text-gray-500">No ${type}s found.</p>`; return; } sortedData.forEach(item => { const div = document.createElement('div'); div.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm text-sm'; div.innerHTML = `<span>${item.name}</span><button data-id="${item.id}" data-type="${type}" class="delete-management-item text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>`; container.appendChild(div); }); }
    function updateTeacherDropdown() { const sortedTeachers = Object.values(schedules).sort((a, b) => a.name.localeCompare(b.name)); const currentVal = document.getElementById('teacher-select').value; document.getElementById('teacher-select').innerHTML = '<option value="">-- Select a Teacher --</option>'; sortedTeachers.forEach(teacher => { const option = document.createElement('option'); option.value = teacher.id; option.textContent = teacher.name; document.getElementById('teacher-select').appendChild(option); }); document.getElementById('teacher-select').disabled = false; if (Object.keys(schedules).length > 0) { document.getElementById('loading-status').textContent = `Loaded ${sortedTeachers.length} schedules.`; } if (currentVal && schedules[currentVal]) { document.getElementById('teacher-select').value = currentVal; } }
    function renderScheduleForTeacher(teacherId) { selectedTeacherId = teacherId; const teacherData = schedules[teacherId]; buildStaticTable(); if (!teacherData) return; DAYS.forEach(day => { const daySchedule = (teacherData[day] || []).sort((a, b) => PERIOD_ORDER.indexOf(a.period) - PERIOD_ORDER.indexOf(b.period)); const row = document.getElementById('schedule-tbody').querySelector(`tr[data-day="${day}"]`); if (!row) return; let i = 0; while (i < daySchedule.length) { let item = daySchedule[i]; if (item.period === 'P') { i++; continue; } let isDouble = false; if (i + 1 < daySchedule.length) { let nextItem = daySchedule[i + 1]; const currentPeriodIndex = PERIOD_ORDER.indexOf(item.period); const nextPeriodIndex = PERIOD_ORDER.indexOf(nextItem.period); if (nextPeriodIndex === currentPeriodIndex + 1 && JSON.stringify((item.subjectIds||[]).sort()) === JSON.stringify((nextItem.subjectIds||[]).sort()) && JSON.stringify((item.classIds||[]).sort()) === JSON.stringify((nextItem.classIds||[]).sort()) && item.locationId === nextItem.locationId) { isDouble = true; } } const cellIndex = periodToCellIndex[item.period]; if (cellIndex === undefined) { i++; continue; } const targetCell = getCellFromDisplayIndex(row, day, cellIndex); if(targetCell) { const subjectNames = (item.subjectIds || []).map(id => subjects[id]?.name).filter(Boolean); const classNames = (item.classIds || []).map(id => classes[id]?.name).filter(Boolean); const locationName = locations[item.locationId]?.name; let content = ''; if (subjectNames.length > 0) content += `<div class="font-bold text-sky-900 text-xs leading-tight schedule-item">${subjectNames.join(' ')}</div>`; if (classNames.length > 0) content += `<div class="text-gray-800 text-[11px] leading-tight schedule-item">${classNames.join(' ')}</div>`; if (locationName) content += `<div class="font-semibold text-purple-800 text-[11px] leading-tight tracking-tighter schedule-item">${locationName}</div>`; if(content) { targetCell.innerHTML = `<div class="schedule-cell" data-index="${i}">${content}</div>`; if (isDouble) { targetCell.colSpan = 2; const nextCellIndex = periodToCellIndex[daySchedule[i+1].period]; const nextCell = getCellFromDisplayIndex(row, day, nextCellIndex); if(nextCell) nextCell.style.display = 'none'; } } } i += isDouble ? 2 : 1; } }); }
    function buildStaticTable() { const monFriRow = `<td></td><td></td><td></td><td></td><td></td><td></td><td class="rehat-slot"></td><td></td><td></td><td class="rehat-slot"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`; document.getElementById('schedule-tbody').innerHTML = `
            <tr data-day="Mo" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Mo</th>${monFriRow}</tr>
            <tr data-day="Tu" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Tu</th><td></td><td></td><td></td><td></td><td></td><td></td><td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T1, T2 & T4</div></td><td></td><td></td><td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T3 & T5</div></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr data-day="We" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">We</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr data-day="Th" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Th</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr data-day="Fr" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Fr</th>${monFriRow}</tr>`; const addIconSvg = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>`; const pasteIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8 2a1 1 0 00-1 1v1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2h-2V3a1 1 0 10-2 0v1H8V3a1 1 0 00-1-1zM5 8h10v8H5V8z"></path></svg>`; document.getElementById('schedule-tbody').querySelectorAll('td').forEach(cell => { cell.innerHTML = `<div class="empty-cell flex items-center justify-center h-full"><div class="add-icon">${addIconSvg}</div><button class="paste-btn hidden">${pasteIconSvg}</button></div>`; cell.style.display = ''; cell.colSpan = 1; }); updatePasteButtonsVisibility(copiedSlot !== null); }
    const displayIndexToActualCellIndexMap = { We: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 8:7, 9:8, 11:9, 12:10, 13:11, 14:12, 15:13, 16:14, 17:15, 18:16, 19:17, 20:18}, Th: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 8:7, 9:8, 11:9, 12:10, 13:11, 14:12, 15:13, 16:14, 17:15, 18:16, 19:17, 20:18}, }; displayIndexToActualCellIndexMap.Tu = displayIndexToActualCellIndexMap.We;
    function getCellFromDisplayIndex(row, day, displayIndex) { if (day === "Mo" || day === "Fr") return row.children[displayIndex] || null; const actualIndex = displayIndexToActualCellIndexMap[day]?.[displayIndex]; return actualIndex ? row.children[actualIndex] : null; }
    function getPeriodFromCell(day, cell) { const actualCellIndex = Array.from(cell.parentNode.children).indexOf(cell); let displayIndex = actualCellIndex; if (day !== "Mo" && day !== "Fr") { const dayMap = displayIndexToActualCellIndexMap[day]; for (const dIndex in dayMap) { if (dayMap[dIndex] === actualCellIndex) { displayIndex = parseInt(dIndex); break; } } } for (const period in periodToCellIndex) if (periodToCellIndex[period] === displayIndex) return period; return null; }
    function handleDeleteClick() { const teacherId = document.getElementById('modal-teacher-id').value; const day = document.getElementById('modal-original-day').value; const index = parseInt(document.getElementById('modal-entry-index').value); pendingConfirmationAction = { action: 'deleteScheduleEntry', payload: { teacherId, day, index } }; document.getElementById('confirm-title').textContent = 'Confirm Deletion'; document.getElementById('confirm-message').textContent = 'Are you sure you want to delete this schedule entry?'; const confirmBtn = document.getElementById('confirm-action-btn'); confirmBtn.textContent = 'Yes, Delete'; confirmBtn.className = 'bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700'; toggleModal('confirm-modal', true); }
    function handleClearScheduleClick() { if (!selectedTeacherId) { alert("Please select a teacher first."); return; } const teacherName = schedules[selectedTeacherId]?.name || 'the selected teacher'; pendingConfirmationAction = { action: 'clearSchedule', payload: { teacherId: selectedTeacherId } }; document.getElementById('confirm-title').textContent = 'Confirm Clear Schedule'; document.getElementById('confirm-message').textContent = `Are you sure you want to permanently delete all schedule entries for ${teacherName}?`; const confirmBtn = document.getElementById('confirm-action-btn'); confirmBtn.textContent = 'Yes, Clear Schedule'; confirmBtn.className = 'bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700'; toggleModal('confirm-modal', true); }
    function openEditModal(day, period, entryIndex) { const isNew = entryIndex === undefined; const teacher = schedules[selectedTeacherId]; const entry = isNew ? null : teacher[day]?.[entryIndex]; document.getElementById('double-slot-container').style.display = isNew ? 'block' : 'none'; document.getElementById('add-double-slot').checked = false; document.getElementById('extend-entry-btn').style.display = isNew ? 'none' : 'inline-block'; document.getElementById('modal-title').textContent = isNew ? `Add Entry for ${day}` : `Edit Entry`; document.getElementById('modal-teacher-id').value = selectedTeacherId; document.getElementById('modal-original-day').value = day; document.getElementById('delete-entry-btn').classList.toggle('hidden', isNew); document.getElementById('copy-entry-btn').classList.toggle('hidden', isNew); if(!isNew) document.getElementById('modal-entry-index').value = entryIndex; else document.getElementById('modal-entry-index').value = ''; populateDayPeriodDropdowns(day, period); populateCheckboxDropdown('subjects', entry?.subjectIds || []); populateCheckboxDropdown('classes', entry?.classIds || []); populateLocationDropdown(entry?.locationId || ''); toggleModal('edit-modal', true); }
    function populateDayPeriodDropdowns(selectedDay, selectedPeriod) { const daySelect = document.getElementById('modal-day-select'); const periodSelect = document.getElementById('modal-period-select'); daySelect.innerHTML = ''; periodSelect.innerHTML = ''; DAYS.forEach(day => { const option = document.createElement('option'); option.value = day; option.textContent = day; if (day === selectedDay) option.selected = true; daySelect.appendChild(option); }); for(const periodKey in PERIOD_MAP) { if (periodKey === 'P') continue; const option = document.createElement('option'); option.value = periodKey; option.textContent = PERIOD_MAP[periodKey]; if (periodKey == selectedPeriod) option.selected = true; periodSelect.appendChild(option); } }
    function populateCheckboxDropdown(type, selectedIds) { const container = document.getElementById(`${type}-dropdown-menu`); const data = type === 'subjects' ? subjects : classes; container.innerHTML = ''; Object.values(data).sort((a,b) => a.name.localeCompare(b.name)).forEach(item => { const isChecked = selectedIds.includes(item.id); container.innerHTML += `<label><input type="checkbox" value="${item.id}" ${isChecked ? 'checked' : ''}> ${item.name}</label>`; }); updateDropdownButtonText(type); }
    function populateLocationDropdown(selectedId) { const select = document.getElementById('modal-location-select'); select.innerHTML = '<option value="">-- No Location --</option>'; Object.values(locations).sort((a,b) => a.name.localeCompare(b.name)).forEach(loc => { const option = document.createElement('option'); option.value = loc.id; option.textContent = loc.name; if(loc.id === selectedId) option.selected = true; select.appendChild(option); }); }
    function updateDropdownButtonText(type) { const container = document.getElementById(`${type}-dropdown-menu`); const btn = document.getElementById(`${type}-dropdown-btn`); const selectedElements = Array.from(container.querySelectorAll('input:checked')); const data = type === 'subjects' ? subjects : classes; const selectedNames = selectedElements.map(el => data[el.value]?.name).filter(Boolean); btn.textContent = selectedNames.length ? selectedNames.join(', ') : `Select ${type.charAt(0).toUpperCase() + type.slice(1)}`; }
    function toggleDropdown(type) { const otherType = type === 'subjects' ? 'classes' : 'subjects'; document.getElementById(`${otherType}-dropdown-menu`).classList.remove('show'); document.getElementById(`${type}-dropdown-menu`).classList.toggle('show'); }
    async function handleSave(e) { e.preventDefault(); const teacherId = document.getElementById('modal-teacher-id').value; const originalDay = document.getElementById('modal-original-day').value; const indexStr = document.getElementById('modal-entry-index').value; const isNew = !indexStr; const addDouble = document.getElementById('add-double-slot').checked; const newDay = document.getElementById('modal-day-select').value; const newPeriod = document.getElementById('modal-period-select').value; const subjectIds = Array.from(document.querySelectorAll('#subjects-dropdown-menu input:checked')).map(el => el.value); const classIds = Array.from(document.querySelectorAll('#classes-dropdown-menu input:checked')).map(el => el.value); const locationId = document.getElementById('modal-location-select').value; const newEntryData = { subjectIds, classIds, locationId: locationId || null }; const newEntry = { period: newPeriod, ...newEntryData }; const teacherSchedule = schedules[teacherId]; const updateData = {}; if (isNew) { const daySchedule = teacherSchedule[newDay] ? [...teacherSchedule[newDay]] : []; daySchedule.push(newEntry); if (addDouble) { const currentPeriodIndex = PERIOD_ORDER.indexOf(newPeriod); if (currentPeriodIndex > -1 && currentPeriodIndex + 1 < PERIOD_ORDER.length) { const nextPeriod = PERIOD_ORDER[currentPeriodIndex + 1]; if(nextPeriod !== 'R1' && nextPeriod !== 'R2') { daySchedule.push({ period: nextPeriod, ...newEntryData }); } } } updateData[newDay] = daySchedule; } else { const dayHasChanged = newDay !== originalDay; const originalDaySchedule = [...teacherSchedule[originalDay]]; if (dayHasChanged) { originalDaySchedule.splice(parseInt(indexStr), 1); updateData[originalDay] = originalDaySchedule.length > 0 ? originalDaySchedule : []; const newDaySchedule = teacherSchedule[newDay] ? [...teacherSchedule[newDay]] : []; newDaySchedule.push(newEntry); updateData[newDay] = newDaySchedule; } else { originalDaySchedule[parseInt(indexStr)] = newEntry; updateData[originalDay] = originalDaySchedule; } } try { await updateDoc(doc(db, "schedules", teacherId), updateData); toggleModal('edit-modal', false); } catch (error) { console.error("Save failed:", error); } }
    function handleCopyClick() { const subjectIds = Array.from(document.querySelectorAll('#subjects-dropdown-menu input:checked')).map(el => el.value); const classIds = Array.from(document.querySelectorAll('#classes-dropdown-menu input:checked')).map(el => el.value); const locationId = document.getElementById('modal-location-select').value; copiedSlot = { subjectIds, classIds, locationId }; toggleModal('edit-modal', false); updatePasteButtonsVisibility(true); }
    async function handleExtendClick() { const teacherId = document.getElementById('modal-teacher-id').value; const day = document.getElementById('modal-day-select').value; const currentPeriod = document.getElementById('modal-period-select').value; const currentPeriodIndex = PERIOD_ORDER.indexOf(currentPeriod); if (currentPeriodIndex === -1 || currentPeriodIndex + 1 >= PERIOD_ORDER.length) { alert("Cannot extend the last slot of the day."); return; } const nextPeriod = PERIOD_ORDER[currentPeriodIndex + 1]; if (nextPeriod === 'R1' || nextPeriod === 'R2') { alert("Cannot extend into a break time."); return; } const daySchedule = schedules[teacherId][day] || []; const isNextSlotOccupied = daySchedule.some(entry => entry.period === nextPeriod); if (isNextSlotOccupied) { alert("Cannot extend slot, the next time slot is already occupied."); return; } const subjectIds = Array.from(document.querySelectorAll('#subjects-dropdown-menu input:checked')).map(el => el.value); const classIds = Array.from(document.querySelectorAll('#classes-dropdown-menu input:checked')).map(el => el.value); const locationId = document.getElementById('modal-location-select').value; const newEntry = { period: nextPeriod, subjectIds, classIds, locationId: locationId || null }; const newDaySchedule = [...daySchedule, newEntry]; try { await updateDoc(doc(db, "schedules", teacherId), { [day]: newDaySchedule }); toggleModal('edit-modal', false); } catch(error) { console.error("Failed to extend slot:", error); alert("An error occurred. Could not extend the slot."); } }
    async function handlePasteClick(day, period) { if (!copiedSlot) return; const teacherId = selectedTeacherId; const newEntry = { period, ...copiedSlot }; const teacherSchedule = schedules[teacherId]; const daySchedule = teacherSchedule[day] ? [...teacherSchedule[day]] : []; daySchedule.push(newEntry); const updateData = { [day]: daySchedule }; try { await updateDoc(doc(db, "schedules", teacherId), updateData); } catch (error) { console.error("Paste failed:", error); } }
    function updatePasteButtonsVisibility(show) { const pasteIndicator = document.getElementById('paste-mode-indicator'); document.querySelectorAll('.add-icon').forEach(icon => icon.classList.toggle('hidden', show)); document.querySelectorAll('.paste-btn').forEach(btn => btn.classList.toggle('hidden', !show)); if(show){ pasteIndicator.classList.remove('hidden'); setTimeout(() => { pasteIndicator.classList.remove('opacity-0', 'translate-y-2'); }, 10); } else { pasteIndicator.classList.add('opacity-0', 'translate-y-2'); setTimeout(() => { pasteIndicator.classList.add('hidden'); }, 300); } }
    function toggleModal(id, show) { const modal = document.getElementById(id); const modalContent = modal.querySelector('.transform'); if (show) { modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10); setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50); } else { modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('opacity-0'), 200); setTimeout(() => modal.classList.add('hidden'), 300); } }
    function switchTab(tabName) { document.querySelectorAll('[id$="-content"]').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${tabName}-content`).classList.remove('hidden'); document.getElementById(`tab-${tabName}-btn`).classList.add('active'); }
    
    main();
</script>
</body>
</html>

