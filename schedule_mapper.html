<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Schedule Editor (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); white-space: nowrap; }
        tbody td, tbody th { height: 6rem; padding: 0.25rem; vertical-align: middle; font-size: 0.75rem; }
        .schedule-cell { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; border-radius: 0.5rem; padding: 0.25rem; line-height: 1.2; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; cursor: pointer; border: 1px solid #bae6fd; transition: background-color 0.2s; }
        .schedule-cell:hover { background-color: #c0eaff; }
        .empty-cell { cursor: pointer; height: 100%; width: 100%; }
        .empty-cell:hover .add-icon { opacity: 1; }
        .add-icon { opacity: 0.15; transition: opacity 0.2s; }
        .long-break-cell { background-color: #FEF3C7 !important; color: #92400E; font-weight: 700; }
        .rehat-slot { background-color: #FEF9C3 !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown-checkbox-menu { display: none; }
        .dropdown-checkbox-menu.show { display: block; }
        .dropdown-checkbox-menu label { display: block; padding: 0.5rem; cursor: pointer; border-radius: 4px; }
        .dropdown-checkbox-menu label:hover { background-color: #f3f4f6; }
        .dropdown-checkbox-menu input { margin-right: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            
            <header class="mb-4 text-center border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Advanced Schedule Editor</h1>
                <div id="loading-status" class="text-gray-600">Connecting to database...</div>
            </header>

            <div class="mb-6 border-b">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-schedule-btn" class="tab-btn active px-3 py-2 font-semibold text-sm rounded-t-md">Schedule</button>
                    <button id="tab-management-btn" class="tab-btn px-3 py-2 font-semibold text-sm rounded-t-md">Management</button>
                    <button id="tab-uploader-btn" class="tab-btn px-3 py-2 font-semibold text-sm rounded-t-md">Data Uploader</button>
                </nav>
            </div>

            <div id="tab-schedule-content">
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <label for="teacher-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Teacher</label>
                    <select id="teacher-select" class="block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">-- Loading --</option>
                    </select>
                </div>

                <div id="schedule-container" class="overflow-x-auto">
                    <div id="loader" class="loader"></div>
                    <table id="schedule-table" class="hidden w-full min-w-[1400px] border-collapse border border-gray-300 text-center text-xs sm:text-sm">
                        <thead>
                            <tr>
                                <th class="p-2 border border-gray-300" rowspan="2"></th>
                                <th class="p-2 border border-gray-300 font-semibold">1</th><th class="p-2 border border-gray-300 font-semibold">2</th><th class="p-2 border border-gray-300 font-semibold">3</th><th class="p-2 border border-gray-300 font-semibold">4</th><th class="p-2 border border-gray-300 font-semibold">5</th><th class="p-2 border border-gray-300 font-semibold">6</th><th class="p-2 border border-gray-300 font-semibold">6*</th><th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th><th class="p-2 border border-gray-300 font-semibold">7</th><th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th><th class="p-2 border border-gray-300 font-semibold">7*</th><th class="p-2 border border-gray-300 font-semibold">8</th><th class="p-2 border border-gray-300 font-semibold">9</th><th class="p-2 border border-gray-300 font-semibold">10</th><th class="p-2 border border-gray-300 font-semibold">11</th><th class="p-2 border border-gray-300 font-semibold">12</th><th class="p-2 border border-gray-300 font-semibold">13</th><th class="p-2 border border-gray-300 font-semibold">14</th><th class="p-2 border border-gray-300 font-semibold">15</th><th class="p-2 border border-gray-300 font-semibold">16</th>
                            </tr>
                            <tr>
                                <td class="p-1 border border-gray-300 font-medium">7:00<br>7:15</td><td class="p-1 border border-gray-300 font-medium">7:15<br>7:45</td><td class="p-1 border border-gray-300 font-medium">7:45<br>8:15</td><td class="p-1 border border-gray-300 font-medium">8:15<br>8:45</td><td class="p-1 border border-gray-300 font-medium">8:45<br>9:15</td><td class="p-1 border border-gray-300 font-medium">9:15<br>9:45</td><td class="p-1 border border-gray-300 font-medium">9:45<br>10:15</td><td class="p-1 border border-gray-300 font-medium bg-amber-100">9:45<br>10:00</td><td class="p-1 border border-gray-300 font-medium">10:00<br>10:15</td><td class="p-1 border border-gray-300 font-medium bg-amber-100">10:15<br>10:30</td><td class="p-1 border border-gray-300 font-medium">10:00<br>10:30</td><td class="p-1 border border-gray-300 font-medium">10:30<br>11:00</td><td class="p-1 border border-gray-300 font-medium">11:00<br>11:30</td><td class="p-1 border border-gray-300 font-medium">11:30<br>12:00</td><td class="p-1 border border-gray-300 font-medium">12:00<br>12:30</td><td class="p-1 border border-gray-300 font-medium">12:30<br>1:00</td><td class="p-1 border border-gray-300 font-medium">1:00<br>1:30</td><td class="p-1 border border-gray-300 font-medium">1:30<br>2:00</td><td class="p-1 border border-gray-300 font-medium">2:00<br>2:30</td><td class="p-1 border border-gray-300 font-medium">2:30<br>3:00</td>
                            </tr>
                        </thead>
                        <tbody id="schedule-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-management-content" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Subjects</h3>
                        <form id="add-subject-form" class="flex gap-2 mb-3"><input type="text" id="subject-name-input" placeholder="New subject name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                        <div id="subject-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Classes</h3>
                        <form id="add-class-form" class="flex gap-2 mb-3"><input type="text" id="class-name-input" placeholder="New class name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                        <div id="class-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Locations</h3>
                        <form id="add-location-form" class="flex gap-2 mb-3"><input type="text" id="location-name-input" placeholder="New location name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form>
                        <div id="location-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                 </div>
            </div>
            
            <div id="tab-uploader-content" class="hidden">
                <div class="w-full max-w-lg mx-auto bg-white p-8 rounded-xl shadow-lg text-center">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">Initial Data Uploader</h1>
                    <p class="text-gray-600 mb-6">Use this tool once to populate Firestore with the initial set of teachers, subjects, classes, and locations. This will clear existing data in the collections.</p>
                    <button id="upload-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Upload Initial Data
                    </button>
                    <div id="upload-status" class="mt-6 text-sm text-gray-700">Ready to begin.</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95 opacity-0">
            <h3 class="text-lg font-semibold mb-4" id="modal-title">Edit Entry</h3>
            <form id="edit-form">
                <input type="hidden" id="modal-teacher-id"><input type="hidden" id="modal-original-day"><input type="hidden" id="modal-entry-index">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                        <label for="modal-day-select" class="text-sm font-medium">Day</label>
                        <select id="modal-day-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                     <div>
                        <label for="modal-period-select" class="text-sm font-medium">Time Slot</label>
                        <select id="modal-period-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="text-sm font-medium">Subjects</label>
                        <button type="button" id="subjects-dropdown-btn" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-left bg-white">Select Subjects</button>
                        <div id="subjects-dropdown-menu" class="dropdown-checkbox-menu absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="relative">
                        <label class="text-sm font-medium">Classes</label>
                        <button type="button" id="classes-dropdown-btn" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-left bg-white">Select Classes</button>
                        <div id="classes-dropdown-menu" class="dropdown-checkbox-menu absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div>
                    </div>
                    <div>
                        <label for="modal-location-select" class="text-sm font-medium">Location</label>
                        <select id="modal-location-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div class="flex justify-between items-center gap-3 mt-6">
                    <button type="button" id="delete-entry-btn" class="px-4 py-2 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">Delete</button>
                    <div class="flex gap-3">
                        <button type="button" id="cancel-edit-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ** FIX START: Added a custom confirmation modal for deletions ** -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95 opacity-0">
            <h3 class="text-lg font-semibold mb-2 text-gray-800">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this entry? This action cannot be undone.</p>
            <!-- Hidden fields to store data for the delete action -->
            <input type="hidden" id="confirm-teacher-id">
            <input type="hidden" id="confirm-day">
            <input type="hidden" id="confirm-index">
            <div class="flex justify-end items-center gap-3">
                <button type="button" id="cancel-confirm-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">Yes, Delete</button>
            </div>
        </div>
    </div>
    <!-- ** FIX END ** -->

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, writeBatch, query, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let db, auth, loadingTimeout;
    let schedules = {}, subjects = {}, classes = {}, locations = {};
    let selectedTeacherId = null;
    
    const PERIOD_MAP = { 1: "1 (7:00-7:15)", 2: "2 (7:15-7:45)", 3: "3 (7:45-8:15)", 4: "4 (8:15-8:45)", 5: "5 (8:45-9:15)", 6: "6 (9:15-9:45)", "6*": "6* (9:45-10:15)", "R1": "REHAT (9:45-10:00)", 7: "7 (10:00-10:15)", "R2": "REHAT (10:15-10:30)", "7*": "7* (10:00-10:30)", 8: "8 (10:30-11:00)", 9: "9 (11:00-11:30)", 10: "10 (11:30-12:00)", 11: "11 (12:00-12:30)", 12: "12 (12:30-1:00)", 13: "13 (1:00-1:30)", 14: "14 (1:30-2:00)", 15: "15 (2:00-2:30)", 16: "16 (2:30-3:00)" };
    const DAYS = ["Mo", "Tu", "We", "Th", "Fr"];

    const loadingStatus = document.getElementById('loading-status');
    const teacherSelect = document.getElementById('teacher-select');
    const scheduleTable = document.getElementById('schedule-table');
    const scheduleTbody = document.getElementById('schedule-tbody');
    const loader = document.getElementById('loader');

    function main() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();
            
            loadingTimeout = setTimeout(() => {
                if (loader.style.display !== 'none') {
                    handleLoadingError('Error: Could not connect to the database. Please check your Firestore security rules.');
                }
            }, 10000);

            onAuthStateChanged(auth, user => {
                if (user) {
                    setupDataListeners();
                } else {
                    signInAnonymously(auth).catch(err => {
                        console.error("Auth failed", err);
                        handleLoadingError('Authentication Failed. Please check Firebase Auth settings.');
                    });
                }
            });
        } catch (error) {
            console.error("Firebase Init Failed:", error);
            handleLoadingError('Firebase Initialization Failed. Check the console for errors.');
        }
    }

    function handleLoadingError(message) {
        clearTimeout(loadingTimeout);
        loader.style.display = 'none';
        loadingStatus.innerHTML = `<strong class="text-red-600">${message}</strong>`;
        teacherSelect.innerHTML = '<option>Connection Failed</option>';
        scheduleTable.classList.add('hidden');
    }

    function setupDataListeners() {
        onSnapshot(collection(db, "schedules"), snapshot => {
            clearTimeout(loadingTimeout);
            schedules = {};
            snapshot.forEach(doc => schedules[doc.id] = { id: doc.id, ...doc.data() });
            updateTeacherDropdown();
            if(selectedTeacherId) {
                renderScheduleForTeacher(selectedTeacherId);
            } else {
                buildStaticTable();
            }
            loader.style.display = 'none';
            scheduleTable.classList.remove('hidden');
        }, err => handleLoadingError("Error fetching data. Try the Data Uploader."));
        onSnapshot(collection(db, "subjects"), s => (subjects = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])), renderManagementList('subject', subjects, document.getElementById('subject-list'))));
        onSnapshot(collection(db, "classes"), s => (classes = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])), renderManagementList('class', classes, document.getElementById('class-list'))));
        onSnapshot(collection(db, "locations"), s => (locations = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])), renderManagementList('location', locations, document.getElementById('location-list'))));
    }

    function updateTeacherDropdown() {
        const sortedTeachers = Object.values(schedules).sort((a, b) => a.name.localeCompare(b.name));
        const currentVal = teacherSelect.value;
        teacherSelect.innerHTML = '<option value="">-- Select a Teacher --</option>';
        sortedTeachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = teacher.name;
            teacherSelect.appendChild(option);
        });
        teacherSelect.disabled = false;
        if (Object.keys(schedules).length > 0) {
            loadingStatus.textContent = `Loaded ${sortedTeachers.length} schedules. Click any cell to edit.`;
        }
        if (currentVal && schedules[currentVal]) {
            teacherSelect.value = currentVal;
        }
    }

    function renderScheduleForTeacher(teacherId) {
        selectedTeacherId = teacherId;
        const teacherData = schedules[teacherId];
        buildStaticTable(); 
        if (!teacherData) return;
        
        const periodToHeaderCol = { 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, "6*": 7, "R1": 8, 7: 9, "R2": 10, "7*": 11, 8: 12, 9: 13, 10: 14, 11: 15, 12: 16, 13: 17, 14: 18, 15: 19, 16: 20 };

        for(const day of DAYS) {
            const daySchedule = teacherData[day] || [];
            const row = scheduleTbody.querySelector(`tr[data-day="${day}"]`);
            if (!row) continue;

            daySchedule.forEach((item, index) => {
                const headerCol = periodToHeaderCol[item.period];
                if (headerCol === undefined) return;
                const targetCell = getCellFromHeaderCol(row, day, headerCol);
                
                if(targetCell) {
                    const subjectNames = (item.subjectIds || []).map(id => subjects[id]?.name).filter(Boolean).join('<br>');
                    const classNames = (item.classIds || []).map(id => classes[id]?.name).filter(Boolean).join('<br>');
                    const locationName = locations[item.locationId]?.name;
                    let content = '';
                    if (subjectNames) content += `<strong class="text-xs">${subjectNames}</strong>`;
                    if (classNames) content += `<span class="text-[10px] mt-1">${classNames}</span>`;
                    if (locationName) content += `<span class="text-[10px] mt-1 text-red-600 font-bold">${locationName}</span>`;
                    if (!content && (item.subjectIds?.length > 0 || item.classIds?.length > 0)) content = '...';
                    if(content) targetCell.innerHTML = `<div class="schedule-cell" data-index="${index}">${content}</div>`;
                }
            });
        }
    }
    
    function buildStaticTable() {
        scheduleTbody.innerHTML = `
            <tr data-day="Mo">
                <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Mo</th>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td class="rehat-slot"></td><td></td><td class="rehat-slot"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            </tr>
            <tr data-day="Tu">
                <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Tu</th>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                <td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T1, T2 & T4</div></td>
                <td></td>
                <td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T3 & T5</div></td>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            </tr>
            <tr data-day="We"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold">We</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr data-day="Th"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Th</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
            <tr data-day="Fr">
                <th class="p-2 border border-gray-300 bg-gray-50 font-semibold">Fr</th>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td class="rehat-slot"></td><td></td><td class="rehat-slot"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            </tr>
        `;
        scheduleTbody.querySelectorAll('td:not([class]), .rehat-slot').forEach(cell => {
             cell.innerHTML = `<div class="empty-cell flex items-center justify-center h-full"><div class="add-icon"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div></div>`;
        });
    }

    const headerToCellIndexMap = {
        Mo: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, 10:10, 11:11, 12:12, 13:13, 14:14, 15:15, 16:16, 17:17, 18:18, 19:19, 20:20},
        Tu: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, 10:10, 11:11, 12:12, 13:13, 14:14, 15:15, 16:16, 17:17, 18:18, 19:19, 20:20},
        We: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 9:8, 11:9, 12:10, 13:11, 14:12, 15:13, 16:14, 17:15, 18:16, 19:17, 20:18},
        Th: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 9:8, 11:9, 12:10, 13:11, 14:12, 15:13, 16:14, 17:15, 18:16, 19:17, 20:18},
        Fr: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9, 10:10, 11:11, 12:12, 13:13, 14:14, 15:15, 16:16, 17:17, 18:18, 19:19, 20:20},
    };
    
    function getCellFromHeaderCol(row, day, headerCol) {
        const cellIndex = headerToCellIndexMap[day]?.[headerCol];
        return cellIndex ? row.children[cellIndex] : null;
    }
    
    function getPeriodFromCell(day, cell) {
        const cellIndex = Array.from(cell.parentNode.children).indexOf(cell);
        const dayMap = headerToCellIndexMap[day];
        for (const headerCol in dayMap) {
            if (dayMap[headerCol] === cellIndex) {
                 const inversePeriodMap = {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:"6*", 8:"R1", 9:7, 10:"R2", 11:"7*", 12:8, 13:9, 14:10, 15:11, 16:12, 17:13, 18:14, 19:15, 20:16 };
                 return inversePeriodMap[headerCol] || null;
            }
        }
        return null;
    }
    
    function setupEventListeners() {
        document.getElementById('tab-schedule-btn').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('tab-management-btn').addEventListener('click', () => switchTab('management'));
        document.getElementById('tab-uploader-btn').addEventListener('click', () => switchTab('uploader'));
        teacherSelect.addEventListener('change', () => renderScheduleForTeacher(teacherSelect.value));
        scheduleTbody.addEventListener('click', (e) => {
            const targetCell = e.target.closest('td');
            if (!targetCell || !selectedTeacherId) return;
            
            const scheduleCell = e.target.closest('.schedule-cell');

            if (targetCell.classList.contains('long-break-cell') && !scheduleCell) {
                return;
            }

            const row = targetCell.closest('tr');
            const day = row.dataset.day;
            let period = getPeriodFromCell(day, targetCell);
            
            const entryIndex = scheduleCell ? scheduleCell.dataset.index : undefined;
            if (period === null && entryIndex !== undefined) {
                 const teacher = schedules[selectedTeacherId];
                 const entry = teacher[day]?.[entryIndex];
                 if (entry) period = entry.period;
            }

            if (period === null) {
                console.error("Could not determine period for the clicked cell.", {day, targetCell});
                return;
            };
            
            openEditModal(day, period, entryIndex);
        });
        document.getElementById('edit-form').addEventListener('submit', handleSave);
        document.getElementById('cancel-edit-btn').addEventListener('click', () => toggleModal('edit-modal', false));
        document.getElementById('delete-entry-btn').addEventListener('click', handleDelete);
        document.getElementById('add-subject-form').addEventListener('submit', e => handleAddManagementItem(e, 'subject'));
        document.getElementById('add-class-form').addEventListener('submit', e => handleAddManagementItem(e, 'class'));
        document.getElementById('add-location-form').addEventListener('submit', e => handleAddManagementItem(e, 'location'));
        document.getElementById('subject-list').addEventListener('click', e => handleDeleteManagementItem(e));
        document.getElementById('class-list').addEventListener('click', e => handleDeleteManagementItem(e));
        document.getElementById('location-list').addEventListener('click', e => handleDeleteManagementItem(e));
        document.getElementById('upload-btn').addEventListener('click', handleInitialUpload);
        document.getElementById('subjects-dropdown-btn').addEventListener('click', () => toggleDropdown('subjects'));
        document.getElementById('classes-dropdown-btn').addEventListener('click', () => toggleDropdown('classes'));
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.getElementById('subjects-dropdown-menu').classList.remove('show');
                document.getElementById('classes-dropdown-menu').classList.remove('show');
            }
        });
        document.getElementById('subjects-dropdown-menu').addEventListener('change', () => updateDropdownButtonText('subjects'));
        document.getElementById('classes-dropdown-menu').addEventListener('change', () => updateDropdownButtonText('classes'));
        // ** FIX START: Added event listeners for the new confirmation modal **
        document.getElementById('confirm-delete-btn').addEventListener('click', executeDelete);
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => toggleModal('confirm-modal', false));
        // ** FIX END **
    }

    function switchTab(tabName) {
        document.querySelectorAll('[id$="-content"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}-content`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}-btn`).classList.add('active');
    }

    function renderManagementList(type, data, container) {
        container.innerHTML = '';
        const sortedData = Object.values(data).sort((a,b) => a.name.localeCompare(b.name));
        if (sortedData.length === 0) { container.innerHTML = `<p class="text-sm text-gray-500">No ${type}s found.</p>`; return; }
        sortedData.forEach(item => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm text-sm';
            div.innerHTML = `<span>${item.name}</span><button data-id="${item.id}" data-type="${type}" class="delete-management-item text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>`;
            container.appendChild(div);
        });
    }
    
    function openEditModal(day, period, entryIndex) {
        const isNew = entryIndex === undefined;
        const teacher = schedules[selectedTeacherId];
        const entry = isNew ? null : teacher[day]?.[entryIndex];
        document.getElementById('modal-title').textContent = isNew ? `Add Entry for ${day}` : `Edit Entry`;
        document.getElementById('modal-teacher-id').value = selectedTeacherId;
        document.getElementById('modal-original-day').value = day;
        document.getElementById('delete-entry-btn').classList.toggle('hidden', isNew);
        if(!isNew) document.getElementById('modal-entry-index').value = entryIndex;
        else document.getElementById('modal-entry-index').value = '';
        populateDayPeriodDropdowns(day, period);
        populateCheckboxDropdown('subjects', entry?.subjectIds || []);
        populateCheckboxDropdown('classes', entry?.classIds || []);
        populateLocationDropdown(entry?.locationId || '');
        toggleModal('edit-modal', true);
    }
    
    function populateDayPeriodDropdowns(selectedDay, selectedPeriod) {
        const daySelect = document.getElementById('modal-day-select');
        const periodSelect = document.getElementById('modal-period-select');
        daySelect.innerHTML = ''; periodSelect.innerHTML = '';
        DAYS.forEach(day => {
            const option = document.createElement('option');
            option.value = day; option.textContent = day;
            if (day === selectedDay) option.selected = true;
            daySelect.appendChild(option);
        });
        for(const periodKey in PERIOD_MAP) {
            const option = document.createElement('option');
            option.value = periodKey; option.textContent = PERIOD_MAP[periodKey];
            if (periodKey == selectedPeriod) option.selected = true;
            periodSelect.appendChild(option);
        }
    }

    function populateCheckboxDropdown(type, selectedIds) {
        const container = document.getElementById(`${type}-dropdown-menu`);
        const data = type === 'subjects' ? subjects : classes;
        container.innerHTML = '';
        Object.values(data).sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
            const isChecked = selectedIds.includes(item.id);
            container.innerHTML += `<label><input type="checkbox" value="${item.id}" ${isChecked ? 'checked' : ''}> ${item.name}</label>`;
        });
        updateDropdownButtonText(type);
    }
    
    function populateLocationDropdown(selectedId) {
        const select = document.getElementById('modal-location-select');
        select.innerHTML = '<option value="">-- No Location --</option>';
        Object.values(locations).sort((a,b) => a.name.localeCompare(b.name)).forEach(loc => {
            const option = document.createElement('option');
            option.value = loc.id; option.textContent = loc.name;
            if(loc.id === selectedId) option.selected = true;
            select.appendChild(option);
        });
    }

    function updateDropdownButtonText(type) {
        const container = document.getElementById(`${type}-dropdown-menu`);
        const btn = document.getElementById(`${type}-dropdown-btn`);
        const selectedElements = Array.from(container.querySelectorAll('input:checked'));
        const data = type === 'subjects' ? subjects : classes;
        const selectedNames = selectedElements.map(el => data[el.value]?.name).filter(Boolean);
        btn.textContent = selectedNames.length ? selectedNames.join(', ') : `Select ${type.charAt(0).toUpperCase() + type.slice(1)}`;
    }

    function toggleDropdown(type) {
        const otherType = type === 'subjects' ? 'classes' : 'subjects';
        document.getElementById(`${otherType}-dropdown-menu`).classList.remove('show');
        document.getElementById(`${type}-dropdown-menu`).classList.toggle('show');
    }

    async function handleSave(e) {
        e.preventDefault();
        const teacherId = document.getElementById('modal-teacher-id').value;
        const originalDay = document.getElementById('modal-original-day').value;
        const indexStr = document.getElementById('modal-entry-index').value;
        const isNew = !indexStr;
        const newDay = document.getElementById('modal-day-select').value;
        const newPeriodStr = document.getElementById('modal-period-select').value;
        const newPeriod = isNaN(parseInt(newPeriodStr)) ? newPeriodStr : parseInt(newPeriodStr);
        const subjectIds = Array.from(document.querySelectorAll('#subjects-dropdown-menu input:checked')).map(el => el.value);
        const classIds = Array.from(document.querySelectorAll('#classes-dropdown-menu input:checked')).map(el => el.value);
        const locationId = document.getElementById('modal-location-select').value;
        const newEntry = { period: newPeriod, subjectIds, classIds, locationId: locationId || null };
        const teacherSchedule = schedules[teacherId];
        const updateData = {};
        const dayHasChanged = newDay !== originalDay;
        
        if (isNew) {
            const daySchedule = teacherSchedule[newDay] ? [...teacherSchedule[newDay]] : [];
            daySchedule.push(newEntry);
            updateData[newDay] = daySchedule;
        } else {
            const originalDaySchedule = [...teacherSchedule[originalDay]];
            if (dayHasChanged) {
                originalDaySchedule.splice(parseInt(indexStr), 1);
                updateData[originalDay] = originalDaySchedule;
                const newDaySchedule = teacherSchedule[newDay] ? [...teacherSchedule[newDay]] : [];
                newDaySchedule.push(newEntry);
                updateData[newDay] = newDaySchedule;
            } else {
                originalDaySchedule[parseInt(indexStr)] = newEntry;
                updateData[originalDay] = originalDaySchedule;
            }
        }
        try {
            await updateDoc(doc(db, "schedules", teacherId), updateData);
            toggleModal('edit-modal', false);
        } catch (error) { console.error("Save failed:", error); }
    }

    // ** FIX START: Replaced confirm() with the custom modal **
    function handleDelete() {
        // 1. Get the data from the edit modal
        const teacherId = document.getElementById('modal-teacher-id').value;
        const day = document.getElementById('modal-original-day').value;
        const index = document.getElementById('modal-entry-index').value;

        // 2. Store this data in the new confirmation modal's hidden fields
        document.getElementById('confirm-teacher-id').value = teacherId;
        document.getElementById('confirm-day').value = day;
        document.getElementById('confirm-index').value = index;

        // 3. Show the confirmation modal
        toggleModal('confirm-modal', true);
    }

    // This new function runs when the user clicks "Yes, Delete"
    async function executeDelete() {
        // 1. Get data back from the confirmation modal's hidden fields
        const teacherId = document.getElementById('confirm-teacher-id').value;
        const day = document.getElementById('confirm-day').value;
        const index = parseInt(document.getElementById('confirm-index').value);

        // 2. Perform the deletion logic
        const daySchedule = [...schedules[teacherId][day]];
        daySchedule.splice(index, 1);
        try {
            await updateDoc(doc(db, "schedules", teacherId), { [day]: daySchedule });
            // 3. Close both modals
            toggleModal('confirm-modal', false);
            toggleModal('edit-modal', false);
        } catch (error) { console.error("Delete failed:", error); }
    }
    // ** FIX END **
    
    async function handleAddManagementItem(e, type) {
        e.preventDefault();
        const input = document.getElementById(`${type}-name-input`);
        const name = input.value.trim();
        if(!name) return;
        try {
            await addDoc(collection(db, `${type}s`), { name });
            input.value = '';
        } catch(error) { console.error(`Error adding ${type}:`, error); }
    }

    async function handleDeleteManagementItem(e) {
        const btn = e.target.closest('.delete-management-item');
        if (!btn) return;
        const { id, type } = btn.dataset;
        // NOTE: This uses confirm() and might fail in the same way.
        // For now, leaving as is since the primary issue was with schedule entries.
        if(confirm(`Are you sure you want to delete this ${type}? This cannot be undone.`)) {
            try {
                await deleteDoc(doc(db, `${type}s`, id));
            } catch(error) { console.error(`Error deleting ${type}:`, error); }
        }
    }

    async function handleInitialUpload() {
        const statusDiv = document.getElementById('upload-status');
        if (!confirm("This will ERASE all current schedules, subjects, classes, and locations. This is for first-time setup. Are you sure?")) return;
        statusDiv.textContent = "Uploading... This may take a moment.";
        
        try {
            const batch = writeBatch(db);
            const collectionsToClear = ["schedules", "subjects", "classes", "locations"];
            for (const coll of collectionsToClear) {
                const snapshot = await getDocs(query(collection(db, coll)));
                snapshot.forEach(doc => batch.delete(doc.ref));
            }
            await batch.commit();

            const newBatch = writeBatch(db);
            const { initialSchedules, initialSubjects, initialClasses, initialLocations } = getInitialData();
            
            const subjectIdMap = {}, classIdMap = {}, locationIdMap = {};
            for (const name of initialSubjects) { const docRef = doc(collection(db, "subjects")); subjectIdMap[name] = docRef.id; newBatch.set(docRef, { name }); }
            for (const name of initialClasses) { const docRef = doc(collection(db, "classes")); classIdMap[name] = docRef.id; newBatch.set(docRef, { name }); }
            for (const name of initialLocations) { const docRef = doc(collection(db, "locations")); locationIdMap[name] = docRef.id; newBatch.set(docRef, { name }); }
            
            for (const teacherName in initialSchedules) {
                const schedule = initialSchedules[teacherName];
                const newScheduleData = { name: teacherName };
                for(const day of DAYS) {
                    const daySchedule = schedule[day];
                    if(Array.isArray(daySchedule)) {
                        newScheduleData[day] = daySchedule.map(entry => ({
                            period: entry.period,
                            subjectIds: (entry.subjects || []).map(s => subjectIdMap[s]).filter(Boolean),
                            classIds: (entry.classes || []).map(c => classIdMap[c]).filter(Boolean),
                            locationId: null 
                        }));
                    } else {
                        newScheduleData[day] = [];
                    }
                }
                const scheduleDocRef = doc(collection(db, "schedules"));
                newBatch.set(scheduleDocRef, newScheduleData);
            }

            await newBatch.commit();
            statusDiv.textContent = "Upload successful! Please switch to the Schedule tab.";
            alert("Initial data uploaded successfully!");

        } catch (error) {
            console.error("Upload failed:", error);
            statusDiv.textContent = `Upload failed: ${error.message}`;
        }
    }
    
    function getInitialData() {
        const rawData = {"EN ABD AZIZ BIN MOHAMED":{"Mo":[{"period":9,"text":"4TS2/4TS1/"}],"Tu":[{"period":10,"text":"4PTS TAW"},{"period":11,"text":"4PTS TAW"}],"We":[{"period":2,"text":"KOKO"},{"period":4,"text":"4TS2"},{"period":6,"text":"4TS2"},{"period":9,"text":"4TS1"},{"period":10,"text":"4PTA"},{"period":11,"text":"4TS1"},{"period":12,"text":"4PTS"}],"Th":[{"period":9,"text":"4TS1/4TS2"},{"period":10,"text":"4TS2"},{"period":11,"text":"4TS1"}],"Fr":[{"period":4,"text":"P"},{"period":6,"text":"4PA W"},{"period":9,"text":"4PA W"}]},"ASIAH BT ALI":{"Mo":[],"Tu":[],"We":[{"period":2,"text":"KOKO"}],"Th":[],"Fr":[]}};
        const initialSchedules = {};
        const subjectSet = new Set();
        const classSet = new Set();
        const KNOWN_SUBJECTS = ["BM", "BI", "MM", "SN", "SJ", "PJ", "PA", "PI", "RBT", "ASK", "FIZ", "KIM", "BIO", "MMT", "PNG", "TAW", "PS", "BC", "BT", "KOKO", "P", "BENG", "GE", "KKQ", "BA", "B.LUKISAN"];
        
        for (const teacherName in rawData) {
            const schedule = rawData[teacherName];
            const newSchedule = {};
            for (const day in schedule) {
                if(Array.isArray(schedule[day])) {
                    newSchedule[day] = schedule[day].map(entry => {
                        const normalizedText = (entry.text || '').replace(/B\.LUKISAN/g, 'B.LUKISAN');
                        const parts = normalizedText.split(/[\s/]+/).filter(Boolean);
                        let entrySubjects = parts.filter(p => KNOWN_SUBJECTS.includes(p.toUpperCase()));
                        let entryClasses = parts.filter(p => !KNOWN_SUBJECTS.includes(p.toUpperCase()));
                        entrySubjects.forEach(s => subjectSet.add(s.toUpperCase()));
                        entryClasses.forEach(c => classSet.add(c));
                        return { period: entry.period, subjects: entrySubjects.map(s => s.toUpperCase()), classes: entryClasses };
                    });
                }
            }
            initialSchedules[teacherName] = newSchedule;
        }

        return {
            initialSchedules,
            initialSubjects: Array.from(subjectSet).sort(),
            initialClasses: Array.from(classSet).sort(),
            initialLocations: ["MAKMAL KOMPUTER 1", "MAKMAL KOMPUTER 2", "BENGKEL RBT", "BILIK LUKISAN"]
        };
    }
    
    function toggleModal(id, show) {
        const modal = document.getElementById(id);
        const modalContent = modal.querySelector('.transform');
        if (show) {
            modal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
        } else {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }

    main();
</script>
</body>
</html>


