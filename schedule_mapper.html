<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Schedule Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); white-space: nowrap; }
        .sticky-day { position: -webkit-sticky; position: sticky; left: 0; z-index: 10; }
        .day-row { border-bottom: 2px solid #cbd5e1; }
        .day-row:last-child { border-bottom: 1px solid #d1d5db; }
        tbody td, tbody th { height: 6rem; padding: 0.25rem; vertical-align: middle; font-size: 0.75rem; }
        .schedule-cell { background-color: #e0f2fe; color: #0c4a6e; border-radius: 0.5rem; padding: 0.25rem; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; cursor: pointer; border: 1px solid #bae6fd; transition: background-color 0.2s; gap: 1px; }
        .schedule-cell:hover { background-color: #c0eaff; }
        .schedule-item { word-break: break-word; max-width: 100%; }
        .empty-cell { cursor: pointer; height: 100%; width: 100%; position: relative; }
        .empty-cell:hover .add-icon { opacity: 1; }
        .add-icon, .paste-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: opacity 0.2s; }
        .add-icon { opacity: 0.15; }
        .paste-btn { opacity: 0.6; background-color: #dbeafe; color: #1e40af; border-radius: 9999px; padding: 0.5rem; display: flex; align-items: center; justify-content: center; }
        .paste-btn:hover { opacity: 1; background-color: #bfdbfe;}
        .long-break-cell { background-color: #FEF3C7 !important; color: #92400E; font-weight: 700; }
        .rehat-slot { background-color: #FEF9C3 !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown-checkbox-menu { display: none; }
        .dropdown-checkbox-menu.show { display: block; }
        .dropdown-checkbox-menu label { display: block; padding: 0.5rem; cursor: pointer; border-radius: 4px; }
        .dropdown-checkbox-menu label:hover { background-color: #f3f4f6; }
        .dropdown-checkbox-menu input { margin-right: 0.5rem; }
        #paste-mode-indicator { transition: opacity 0.3s, transform 0.3s; }
        #uploader-status { white-space: pre-wrap; word-wrap: break-word; }
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* Styles for split cells */
        .schedule-cell-container { display: flex; height: 100%; width: 100%; padding: 0; margin: 0; }
        .schedule-sub-cell { flex: 1; border-right: 1px dotted #99cff2; padding: 0.25rem; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 1px; }
        .schedule-sub-cell:last-child { border-right: none; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <header class="mb-4 text-center border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Advanced Schedule Editor</h1>
                <div id="loading-status" class="text-gray-600">Connecting to database...</div>
            </header>
            <div class="mb-6 border-b">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-schedule-btn" class="tab-btn active px-3 py-2 font-semibold text-sm rounded-t-md">Schedule</button>
                    <button id="tab-management-btn" class="tab-btn px-3 py-2 font-semibold text-sm rounded-t-md">Management</button>
                </nav>
            </div>
            <div id="tab-schedule-content">
                 <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center gap-4">
                         <div class="flex items-center gap-4">
                            <span class="text-sm font-medium text-gray-700">Teacher View</span>
                            <label class="switch">
                                <input type="checkbox" id="view-toggle">
                                <span class="slider"></span>
                            </label>
                            <span class="text-sm font-medium text-gray-700">Class View</span>
                        </div>
                        <button id="open-uploader-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center hover:bg-teal-600 transition-colors whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span>Uploader</span>
                        </button>
                    
                        <button id="cancel-paste-btn" class="hidden bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 transition-colors whitespace-nowrap">
                            Cancel Paste
                        </button>

                    </div>
                     <div id="selector-container" class="mt-4">
                        <!-- Dropdowns will be inserted here by JS -->
                     </div>
                </div>

                <div id="schedule-container" class="overflow-x-auto">
                    <div id="loader" class="loader"></div>
                    <table id="schedule-table" class="hidden w-full min-w-[1400px] border-collapse border border-gray-300 text-center text-xs sm:text-sm">
                        <thead>
                            <tr class="divide-x divide-gray-300">
                                <th class="p-2 border border-gray-300 sticky-day bg-white" rowspan="2">Day</th>
                                <th class="p-2 border border-gray-300 font-semibold"></th><th class="p-2 border border-gray-300 font-semibold">1</th><th class="p-2 border border-gray-300 font-semibold">2</th><th class="p-2 border border-gray-300 font-semibold">3</th><th class="p-2 border border-gray-300 font-semibold">4</th><th class="p-2 border border-gray-300 font-semibold">5</th><th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th><th class="p-2 border border-gray-300 font-semibold">6</th><th class="p-2 border border-gray-300 font-semibold">6*</th><th class="p-2 border border-gray-300 font-semibold bg-amber-200">REHAT</th><th class="p-2 border border-gray-300 font-semibold">7</th><th class="p-2 border border-gray-300 font-semibold">8</th><th class="p-2 border border-gray-300 font-semibold">9</th><th class="p-2 border border-gray-300 font-semibold">10</th><th class="p-2 border border-gray-300 font-semibold">11</th><th class="p-2 border border-gray-300 font-semibold">12</th><th class="p-2 border border-gray-300 font-semibold">13</th><th class="p-2 border border-gray-300 font-semibold">14</th><th class="p-2 border border-gray-300 font-semibold">15</th><th class="p-2 border border-gray-300 font-semibold">16</th>
                            </tr>
                            <tr class="divide-x divide-gray-300">
                                <td class="p-1 border border-gray-300 font-medium">7:00<br>7:15</td><td class="p-1 border border-gray-300 font-medium">7:15<br>7:45</td><td class="p-1 border border-gray-300 font-medium">7:45<br>8:15</td><td class="p-1 border border-gray-300 font-medium">8:15<br>8:45</td><td class="p-1 border border-gray-300 font-medium">8:45<br>9:15</td><td class="p-1 border border-gray-300 font-medium">9:15<br>9:45</td><td class="p-1 border border-gray-300 font-medium bg-amber-100">9:45<br>10:00</td><td class="p-1 border border-gray-300 font-medium">9:45<br>10:15</td><td class="p-1 border border-gray-300 font-medium">10:00<br>10:30</td><td class="p-1 border border-gray-300 font-medium bg-amber-100">10:15<br>10:30</td><td class="p-1 border border-gray-300 font-medium">10:30<br>11:00</td><td class="p-1 border border-gray-300 font-medium">11:00<br>11:30</td><td class="p-1 border border-gray-300 font-medium">11:30<br>12:00</td><td class="p-1 border border-gray-300 font-medium">12:00<br>12:30</td><td class="p-1 border border-gray-300 font-medium">12:30<br>1:00</td><td class="p-1 border border-gray-300 font-medium">1:00<br>1:30</td><td class="p-1 border border-gray-300 font-medium">1:30<br>2:00</td><td class="p-1 border border-gray-300 font-medium">2:00<br>2:30</td><td class="p-1 border border-gray-300 font-medium">2:30<br>3:00</td><td class="p-1 border border-gray-300 font-medium">3:00<br>3:30</td>
                            </tr>
                        </thead>
                        <tbody id="schedule-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div id="tab-management-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Teachers</h3>
                        <form id="add-teacher-form" class="space-y-2 mb-3">
                           <input type="text" id="teacher-name-input" placeholder="New teacher full name" class="w-full p-2 text-sm border rounded-md" required>
                           <input type="text" id="teacher-short-name-input" placeholder="Short name (e.g., EN. FAUZI)" class="w-full p-2 text-sm border rounded-md" required>
                           <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add Teacher</button>
                        </form>
                        <div id="teacher-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Subjects</h3><form id="add-subject-form" class="flex gap-2 mb-3"><input type="text" id="subject-name-input" placeholder="New subject name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form><div id="subject-list" class="space-y-2 max-h-72 overflow-y-auto"></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Classes</h3><form id="add-class-form" class="flex gap-2 mb-3"><input type="text" id="class-name-input" placeholder="New class name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form><div id="class-list" class="space-y-2 max-h-72 overflow-y-auto"></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg lg:col-span-2"><h3 class="text-lg font-semibold mb-3 text-gray-800">Manage Locations</h3><form id="add-location-form" class="flex gap-2 mb-3"><input type="text" id="location-name-input" placeholder="New location name" class="flex-grow p-2 text-sm border rounded-md" required><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Add</button></form><div id="location-list" class="space-y-2 max-h-72 overflow-y-auto"></div></div>
                </div>
                <div class="mt-8 p-4 bg-red-50 rounded-lg border border-red-200"><h3 class="text-lg font-semibold mb-3 text-red-800">Danger Zone</h3><p class="text-sm text-red-700 mb-4">Clearing a teacher's schedule is permanent and cannot be undone.</p><button id="clear-schedule-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">Clear Selected Teacher's Schedule</button></div>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 modal"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95 opacity-0"><h3 class="text-lg font-semibold mb-4" id="modal-title">Edit Entry</h3><form id="edit-form"><input type="hidden" id="modal-original-day"><input type="hidden" id="modal-period"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="modal-day-select" class="text-sm font-medium">Day</label><select id="modal-day-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div><div><label for="modal-period-select" class="text-sm font-medium">Time Slot</label><select id="modal-period-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div></div><div class="border-t border-b py-4 my-4"><h4 class="text-md font-semibold mb-2 text-gray-700">Subjects & Teachers</h4><div id="subject-teacher-pairs-container" class="space-y-2"></div><button type="button" id="add-subject-pair-btn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold">+ Add Subject</button></div><div class="space-y-4"><div class="relative"><label class="text-sm font-medium">Classes</label><button type="button" id="classes-dropdown-btn" class="mt-1 w-full p-2 border border-gray-300 rounded-md text-left bg-white">Select Classes</button><div id="classes-dropdown-menu" class="dropdown-checkbox-menu absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto"></div></div><div><label for="modal-location-select" class="text-sm font-medium">Location</label><select id="modal-location-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select></div></div><div id="double-slot-container" class="mt-4"><label class="flex items-center"><input type="checkbox" id="add-double-slot" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"><span class="ml-2 text-sm text-gray-700">Add Double Slot (fills next time slot too)</span></label></div><div class="flex justify-between items-center flex-wrap gap-3 mt-6"><div id="modal-action-buttons" class="flex gap-2 flex-wrap"><button type="button" id="delete-entry-btn" class="px-4 py-2 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">Delete All</button></div><div class="flex gap-3"><button type="button" id="cancel-edit-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button></div></div></form></div></div>
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 modal"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95 opacity-0"><h3 id="confirm-title" class="text-lg font-semibold mb-2 text-gray-800">Confirm Action</h3><p id="confirm-message" class="text-gray-600 mb-6">Are you sure?</p><div class="flex justify-end items-center gap-3"><button type="button" id="cancel-confirm-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button><button type="button" id="confirm-action-btn" class="bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700">Confirm</button></div></div></div>
    <div id="uploader-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4 modal"><div class="bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 opacity-0"><div class="flex justify-between items-center p-4 border-b"><h3 class="text-lg font-semibold text-gray-800">File Uploader</h3><button id="close-uploader-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold p-2 leading-none">&times;</button></div><div class="p-6 space-y-4"><p class="text-sm text-gray-600">Select a file to upload. Use the appropriate button for your intended action.</p><div><label for="json-file-input" class="block text-sm font-medium text-gray-700 mb-1">JSON or TXT File</label><input type="file" id="json-file-input" accept=".json,.txt" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-100"/></div><div class="space-y-2"><button id="upload-to-firestore-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">Upload Schedule (JSON)</button><button id="update-short-names-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">Pair & Update Short Names (TXT)</button></div><div class="bg-gray-100 p-3 rounded-lg mt-4 max-h-48 overflow-y-auto"><pre id="uploader-status" class="text-xs text-gray-700">Ready to upload.</pre></div></div></div></div>
    <!-- Edit Teacher Modal -->
    <div id="edit-teacher-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95 opacity-0">
            <h3 class="text-lg font-semibold mb-4">Edit Teacher</h3>
            <form id="edit-teacher-form">
                <input type="hidden" id="edit-teacher-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-teacher-name-input" class="text-sm font-medium">Full Name</label>
                        <input type="text" id="edit-teacher-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white" required>
                    </div>
                    <div>
                        <label for="edit-teacher-short-name-input" class="text-sm font-medium">Short Name</label>
                        <input type="text" id="edit-teacher-short-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg bg-white" required>
                    </div>
                </div>
                <div class="flex justify-end items-center gap-3 mt-6">
                    <button type="button" id="cancel-edit-teacher-btn" class="px-4 py-2 text-sm rounded-md bg-gray-200 hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 text-sm rounded-md hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, writeBatch, query, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.appspot.com",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let app, db, auth, loadingTimeout;
    let schedules = {}, subjects = {}, classes = {}, locations = {};
    let selectedTeacherId = null;
    let selectedClassId = null;
    let currentView = 'teacher'; // 'teacher' or 'class'
    let copiedSlot = null;
    let pendingConfirmationAction = null;
    
    const PERIOD_MAP = { "P": "P (7:00-7:15)", "1": "1 (7:15-7:45)", "2": "2 (7:45-8:15)", "3": "3 (8:15-8:45)", "4": "4 (8:45-9:15)", "5": "5 (9:15-9:45)", "R1": "REHAT (9:45-10:00)", "6": "6 (9:45-10:15)", "6*": "6* (10:00-10:30)", "R2": "REHAT (10:15-10:30)", "7": "7 (10:30-11:00)", "8": "8 (11:00-11:30)", "9": "9 (11:30-12:00)", "10": "10 (12:00-12:30)", "11": "11 (12:30-1:00)", "12": "12 (1:00-1:30)", "13": "13 (1:30-2:00)", "14": "14 (2:00-2:30)", "15": "15 (2:30-3:00)","16": "16 (3:00-3:30)" };
    const DAYS = ["Mo", "Tu", "We", "Th", "Fr"];
    const PERIOD_ORDER = ["P", "1", "2", "3", "4", "5", "R1", "6", "6*", "R2", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16"];

    function main() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();
            setupViewToggle();
            loadingTimeout = setTimeout(() => { if (document.getElementById('loader').style.display !== 'none') { handleLoadingError('Error: Could not connect to the database.'); } }, 10000);
            onAuthStateChanged(auth, user => { if (user) { setupDataListeners(); } else { signInAnonymously(auth).catch(err => { console.error("Auth failed", err); handleLoadingError('Authentication Failed.'); }); } });
        } catch (error) { console.error("Startup Failed:", error); handleLoadingError('Startup error. Please check your connection and reload.'); }
    }

    function handleLoadingError(message) { clearTimeout(loadingTimeout); document.getElementById('loader').style.display = 'none'; document.getElementById('loading-status').innerHTML = `<strong class="text-red-600">${message}</strong>`; document.getElementById('selector-container').innerHTML = 'Connection Failed'; document.getElementById('schedule-table').classList.add('hidden'); }

    function setupDataListeners() {
        onSnapshot(collection(db, "schedules"), snapshot => { 
            clearTimeout(loadingTimeout); 
            schedules = {}; 
            snapshot.forEach(doc => schedules[doc.id] = { id: doc.id, ...doc.data() }); 
            renderTeacherList();
            if (currentView === 'teacher') {
                updateTeacherDropdown();
                 if(!schedules[selectedTeacherId]){
                    selectedTeacherId = null;
                    buildStaticTable();
                } else {
                     renderScheduleForTeacher(selectedTeacherId); 
                }
            } else {
                renderScheduleForClass(selectedClassId);
            }
            document.getElementById('loader').style.display = 'none'; 
            document.getElementById('schedule-table').classList.remove('hidden'); 
        }, err => handleLoadingError("Error fetching schedule data."));
        
        onSnapshot(collection(db, "subjects"), s => { 
            subjects = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])); 
            renderManagementList('subject', subjects, document.getElementById('subject-list'));
            if (currentView === 'class') renderScheduleForClass(selectedClassId);
        }, err => handleLoadingError("Error fetching subjects."));

        onSnapshot(collection(db, "classes"), s => { 
            classes = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])); 
            renderManagementList('class', classes, document.getElementById('class-list')); 
            if (currentView === 'class') {
                updateClassDropdown();
                renderScheduleForClass(selectedClassId);
            }
        }, err => handleLoadingError("Error fetching classes."));
        
        onSnapshot(collection(db, "locations"), s => { 
            locations = Object.fromEntries(s.docs.map(d=>[d.id, {id: d.id, ...d.data()}])); 
            renderManagementList('location', locations, document.getElementById('location-list')); 
            if (currentView === 'class') renderScheduleForClass(selectedClassId);
        }, err => handleLoadingError("Error fetching locations."));
    }
    
    function setupEventListeners() {
        document.getElementById('tab-schedule-btn').addEventListener('click', () => switchTab('schedule'));
        document.getElementById('tab-management-btn').addEventListener('click', () => switchTab('management'));
        
        document.getElementById('schedule-tbody').addEventListener('click', (e) => {
            const targetCell = e.target.closest('td');
            if (!targetCell) return;

            const day = targetCell.closest('tr').dataset.day;
            const period = getPeriodFromCell(day, targetCell);
            if (!period) return;

            const isBreakSlot = targetCell.classList.contains('long-break-cell') || targetCell.classList.contains('rehat-slot');
            if(isBreakSlot) return;

            if (e.target.closest('.paste-btn') && currentView === 'teacher' && selectedTeacherId) {
                handlePasteClick(day, period);
                return;
            }

            openEditModal({ day, period });
        });

        document.getElementById('edit-form').addEventListener('submit', handleSave);
        document.getElementById('cancel-edit-btn').addEventListener('click', () => toggleModal('edit-modal', false));
        document.getElementById('delete-entry-btn').addEventListener('click', handleDeleteClick);
        document.getElementById('add-subject-pair-btn').addEventListener('click', () => addSubjectTeacherPairRow());
        
        document.getElementById('add-teacher-form').addEventListener('submit', handleAddTeacher);
        document.getElementById('add-subject-form').addEventListener('submit', e => handleAddManagementItem(e, 'subject'));
        document.getElementById('add-class-form').addEventListener('submit', e => handleAddManagementItem(e, 'class'));
        document.getElementById('add-location-form').addEventListener('submit', e => handleAddManagementItem(e, 'location'));
        
        document.getElementById('teacher-list').addEventListener('click', handleTeacherListClick);
        document.getElementById('subject-list').addEventListener('click', handleDeleteManagementClick);
        document.getElementById('class-list').addEventListener('click', handleDeleteManagementClick);
        document.getElementById('location-list').addEventListener('click', handleDeleteManagementClick);
        
        const _classesBtn = document.getElementById('classes-dropdown-btn'); if (_classesBtn) { _classesBtn.addEventListener('click', () => document.getElementById('classes-dropdown-menu').classList.toggle('show')); }
        document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) { document.getElementById('classes-dropdown-menu').classList.remove('show'); } });
        const _classesMenu = document.getElementById('classes-dropdown-menu'); if (_classesMenu) { _classesMenu.addEventListener('change', () => updateDropdownButtonText('classes')); }
        document.getElementById('cancel-confirm-btn').addEventListener('click', () => { pendingConfirmationAction = null; toggleModal('confirm-modal', false); });
        document.getElementById('clear-schedule-btn').addEventListener('click', handleClearScheduleClick);
        document.getElementById('confirm-action-btn').addEventListener('click', handleConfirmAction);
        document.getElementById('open-uploader-btn').addEventListener('click', () => toggleModal('uploader-modal', true));
        document.getElementById('close-uploader-btn').addEventListener('click', () => toggleModal('uploader-modal', false));
        document.getElementById('upload-to-firestore-btn').addEventListener('click', handleFileUpload);
        document.getElementById('update-short-names-btn').addEventListener('click', handleShortNameUpdate);

        document.getElementById('edit-teacher-form').addEventListener('submit', handleUpdateTeacher);
        document.getElementById('cancel-edit-teacher-btn').addEventListener('click', () => toggleModal('edit-teacher-modal', false));
    }

    function normalizeName(name) { if (!name) return ''; return name.toUpperCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s\s+/g, ' ').trim(); }
    
    async function handleFileUpload() { /* Unchanged */ }
    async function handleShortNameUpdate() { /* Unchanged */ }
    
    async function handleConfirmAction() {
        if (!pendingConfirmationAction) return;
        const { action, payload } = pendingConfirmationAction;
        const confirmBtn = document.getElementById('confirm-action-btn');
        confirmBtn.disabled = true;
        try {
            if (action === 'deleteSlotEntries') {
                confirmBtn.textContent = 'Deleting...';
                const { entriesToDelete } = payload;
                const batch = writeBatch(db);

                const teacherEntriesMap = new Map();
                entriesToDelete.forEach(entry => {
                    if(!teacherEntriesMap.has(entry.teacherId)){
                        teacherEntriesMap.set(entry.teacherId, []);
                    }
                    teacherEntriesMap.get(entry.teacherId).push(entry);
                });

                for(const [teacherId, entries] of teacherEntriesMap.entries()){
                    const teacherDocRef = doc(db, "schedules", teacherId);
                    const day = entries[0].day;
                    let daySchedule = [...(schedules[teacherId][day] || [])];
                    
                    const originalIndices = entries.map(e => e.originalIndex).sort((a,b) => b - a);
                    for(const index of originalIndices){
                        daySchedule.splice(index, 1);
                    }

                    batch.update(teacherDocRef, { [day]: daySchedule });
                }
                await batch.commit();
                toggleModal('edit-modal', false);

            } else if (action === 'deleteManagementItem') { /* Unchanged */
            } else if (action === 'clearSchedule') { /* Unchanged */
            } else if (action === 'deleteTeacher') { /* Unchanged */ }
        } catch (error) { console.error("Confirmation action failed:", error); alert("An error occurred. Please check the console."); } finally { pendingConfirmationAction = null; confirmBtn.disabled = false; toggleModal('confirm-modal', false); }
    }

    async function handleAddTeacher(e) { /* Unchanged */ }
    function handleTeacherListClick(e) { /* Unchanged */ }
    function openEditTeacherModal(btn) { /* Unchanged */ }
    async function handleUpdateTeacher(e) { /* Unchanged */ }
    function handleDeleteTeacherClick(btn) { /* Unchanged */ }
    function handleDeleteManagementClick(e) { /* Unchanged */ }
    async function handleAddManagementItem(e, type) { /* Unchanged */ }
    
    const periodToCellIndex = { "P": 1, "1": 2, "2": 3, "3": 4, "4": 5, "5": 6, "R1": 7, "6": 8, "6*": 9, "R2": 10, "7": 11, "8": 12, "9": 13, "10": 14, "11": 15, "12": 16, "13": 17, "14": 18, "15": 19, "16": 20 };
    
    function renderTeacherList() { /* Unchanged */ }
    function renderManagementList(type, data, container) { /* Unchanged */ }
    function setupViewToggle() { /* Unchanged */ }
    function renderSelectors() { /* Unchanged */ }
    function updateTeacherDropdown() { /* Unchanged */ }
    function updateClassDropdown() { /* Unchanged */ }
    
    function renderScheduleForClass(classId) {
        selectedClassId = classId;
        buildStaticTable();
        if (!classId || Object.keys(schedules).length === 0) return;
    
        const allEntries = [];
        Object.values(schedules).forEach(teacher => {
            DAYS.forEach(day => {
                (teacher[day] || []).forEach((entry, index) => {
                    if (entry.classIds && entry.classIds.includes(classId)) {
                        allEntries.push({ ...entry, day, teacherId: teacher.id, teacherShortName: teacher.shortName || 'N/A', entryIndex: index });
                    }
                });
            });
        });
    
        const groupedByPeriod = {};
        allEntries.forEach(entry => {
            const key = `${entry.day}-${entry.period}`;
            if (!groupedByPeriod[key]) groupedByPeriod[key] = [];
            groupedByPeriod[key].push(entry);
        });
        
        for (const key in groupedByPeriod) {
            const [day, period] = key.split('-');
            const entries = groupedByPeriod[key];
            const row = document.getElementById('schedule-tbody').querySelector(`tr[data-day="${day}"]`);
            if (!row) continue;
            
            const cellIndex = periodToCellIndex[period];
            if (cellIndex === undefined) continue;
    
            const targetCell = getCellFromDisplayIndex(row, day, cellIndex);
            if (!targetCell) continue;

            const container = document.createElement('div');
            container.className = 'schedule-cell-container';

            entries.forEach(entry => {
                (entry.subjectIds || ['-']).forEach(subjectId => {
                    const subCell = document.createElement('div');
                    subCell.className = 'schedule-sub-cell';
                    const subjectName = subjects[subjectId]?.name || '...';
                    subCell.innerHTML = `<div class="font-bold text-sky-900 text-xs leading-tight schedule-item">${subjectName}</div><div class="text-gray-800 text-[11px] leading-tight schedule-item">${entry.teacherShortName}</div>`;
                    container.appendChild(subCell);
                });
            });
            const wrapper = document.createElement('div');
            wrapper.className = 'schedule-cell';
            wrapper.style.padding = '0';
            wrapper.style.overflow = 'hidden';
            wrapper.appendChild(container);
            targetCell.innerHTML = '';
            targetCell.style.padding = '0';
            targetCell.appendChild(wrapper);
        }
    }
    
    function renderScheduleForTeacher(teacherId) {
       selectedTeacherId = teacherId;
        buildStaticTable();
        const teacherData = schedules[teacherId];
        if (!teacherData) return;
        DAYS.forEach(day => {
            const daySchedule = (teacherData[day] || []).sort((a, b) => PERIOD_ORDER.indexOf(a.period) - PERIOD_ORDER.indexOf(b.period));
            const row = document.getElementById('schedule-tbody').querySelector(`tr[data-day="${day}"]`);
            if (!row) return;
            let i = 0;
            while (i < daySchedule.length) {
                let item = daySchedule[i];
                if (item.period === 'P') { i++; continue; }
                let isDouble = false;
                if (i + 1 < daySchedule.length) {
                    let nextItem = daySchedule[i + 1];
                    const currentPeriodIndex = PERIOD_ORDER.indexOf(item.period);
                    const nextPeriodIndex = PERIOD_ORDER.indexOf(nextItem.period);
                    if (nextPeriodIndex === currentPeriodIndex + 1 && JSON.stringify((item.subjectIds || []).sort()) === JSON.stringify((nextItem.subjectIds || []).sort()) && JSON.stringify((item.classIds || []).sort()) === JSON.stringify((nextItem.classIds || []).sort()) && item.locationId === nextItem.locationId) {
                        isDouble = true;
                    }
                }
                const cellIndex = periodToCellIndex[item.period];
                if (cellIndex === undefined) { i++; continue; }
                const targetCell = getCellFromDisplayIndex(row, day, cellIndex);
                if (targetCell) {
                    const subjectIds = item.subjectIds || [];
                    const classNames = (item.classIds || []).map(id => classes[id]?.name).filter(Boolean);
                    const locationName = locations[item.locationId]?.name;

                    if(subjectIds.length > 1) { 
                        const container = document.createElement('div');
                        container.className = 'schedule-cell-container';
                        subjectIds.forEach(subjectId => {
                            const subCell = document.createElement('div');
                            subCell.className = 'schedule-sub-cell';
                            const subjectName = subjects[subjectId]?.name || '...';
                            let content = `<div class="font-bold text-sky-900 text-xs leading-none schedule-item">${subjectName}</div>`;
                            if (classNames.length > 0) content += `<div class="text-gray-800 text-[10px] leading-none schedule-item">${classNames.join(' ')}</div>`;
                            if (locationName) content += `<div class="font-semibold text-purple-800 text-[10px] leading-none tracking-tighter schedule-item">${locationName}</div>`;
                            subCell.innerHTML = content;
                            container.appendChild(subCell);
                        });
                        const wrapper = document.createElement('div');
                        wrapper.className = 'schedule-cell';
                        wrapper.style.padding = '0';
                        wrapper.style.overflow = 'hidden';
                        wrapper.appendChild(container);
                        targetCell.innerHTML = '';
                        targetCell.style.padding = '0';
                        targetCell.appendChild(wrapper);
                    } else { 
                        const subjectNames = subjectIds.map(id => subjects[id]?.name).filter(Boolean);
                        let content = '';
                        if (subjectNames.length > 0) content += `<div class="font-bold text-sky-900 text-xs leading-none schedule-item">${subjectNames.join(' ')}</div>`;
                        if (classNames.length > 0) {
                            for (let j = 0; j < classNames.length; j += 2) {
                                content += `<div class="text-gray-800 text-[10px] leading-none schedule-item">${classNames.slice(j, j + 2).join(' ')}</div>`;
                            }
                        }
                        if (locationName) content += `<div class="font-semibold text-purple-800 text-[10px] leading-none tracking-tighter schedule-item">${locationName}</div>`;
                        if (content) {
                            targetCell.innerHTML = `<div class="schedule-cell">${content}</div>`;
                        }
                    }

                    if (isDouble) {
                        targetCell.colSpan = 2;
                        const nextCell = getCellFromDisplayIndex(row, day, periodToCellIndex[daySchedule[i + 1].period]);
                        if (nextCell) nextCell.style.display = 'none';
                    }
                }
                i += isDouble ? 2 : 1;
            }
        });
    }

    function buildStaticTable() { const monFriRow = `<td></td><td></td><td></td><td></td><td></td><td></td><td class="rehat-slot"></td><td></td><td></td><td class="rehat-slot"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`; document.getElementById('schedule-tbody').innerHTML = `<tr data-day="Mo" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Mo</th>${monFriRow}</tr><tr data-day="Tu" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Tu</th><td></td><td></td><td></td><td></td><td></td><td></td><td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T1, T2 & T4</div></td><td></td><td></td><td class="long-break-cell" rowspan="3"><div class="vertical-text">REHAT T3 & T5</div></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-day="We" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">We</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-day="Th" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Th</th><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr data-day="Fr" class="day-row"><th class="p-2 border border-gray-300 bg-gray-50 font-semibold sticky-day">Fr</th>${monFriRow}</tr>`; const addIconSvg = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>`; const pasteIconSvg = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M8 2a1 1 0 00-1 1v1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2h-2V3a1 1 0 10-2 0v1H8V3a1 1 0 00-1-1zM5 8h10v8H5V8z"></path></svg>`; document.getElementById('schedule-tbody').querySelectorAll('td').forEach(cell => { cell.innerHTML = `<div class="empty-cell flex items-center justify-center h-full"><div class="add-icon">${addIconSvg}</div><button class="paste-btn hidden">${pasteIconSvg}</button></div>`; cell.style.display = ''; cell.colSpan = 1; cell.style.padding = '0.25rem'; }); }
    const displayIndexToActualCellIndexMap = { We: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 8:7, 9:8, 11:9, 12:10, 13:11, 14:12, 15:13, 16:14, 17:15, 18:16, 19:17, 20:18}, Th: {1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 8:7, 9:8, 11:9, 12:10, 13:11, 14:12, 15:13, 16:14, 17:15, 18:16, 19:17, 20:18}}; displayIndexToActualCellIndexMap.Tu = displayIndexToActualCellIndexMap.We;
    function getCellFromDisplayIndex(row, day, displayIndex) { /* Unchanged */ }
    function getPeriodFromCell(day, cell) { /* Unchanged */ }

    function handleDeleteClick() { 
        const container = document.getElementById('subject-teacher-pairs-container');
        const entriesToDelete = JSON.parse(container.dataset.originalEntries || '[]');
        if (entriesToDelete.length === 0) return;
        
        pendingConfirmationAction = { action: 'deleteSlotEntries', payload: { entriesToDelete } };
        document.getElementById('confirm-title').textContent = 'Confirm Deletion';
        document.getElementById('confirm-message').textContent = 'Are you sure you want to delete all entries in this time slot?';
        const confirmBtn = document.getElementById('confirm-action-btn');
        confirmBtn.textContent = 'Yes, Delete';
        confirmBtn.className = 'bg-red-600 text-white px-4 py-2 text-sm rounded-md hover:bg-red-700';
        toggleModal('confirm-modal', true);
    }
    function handleClearScheduleClick() { /* Unchanged */ }
    
    function openEditModal({day, period}) {
        const container = document.getElementById('subject-teacher-pairs-container');
        container.innerHTML = '';
        document.getElementById('modal-original-day').value = day;
        document.getElementById('modal-period').value = period;

        populateDayPeriodDropdowns(day, period);

        let originalEntries = [];
        let locationId = '';
        let classIds = [];
        let isNew = true;

        if (currentView === 'class') {
            if (!selectedClassId) return;
            document.getElementById('modal-title').textContent = `Edit Entry for ${classes[selectedClassId]?.name}`;
            
            Object.values(schedules).forEach(teacher => {
                (teacher[day] || []).forEach((entry, index) => {
                    if (entry.period === period && entry.classIds?.includes(selectedClassId)) {
                        originalEntries.push({ ...entry, teacherId: teacher.id, day, originalIndex: index });
                    }
                });
            });

            if (originalEntries.length > 0) {
                isNew = false;
                originalEntries.forEach(entry => {
                    (entry.subjectIds || [null]).forEach(subjectId => addSubjectTeacherPairRow(subjectId, entry.teacherId));
                });
                locationId = originalEntries[0].locationId;
                classIds = originalEntries[0].classIds;
            } else {
                addSubjectTeacherPairRow();
                classIds = [selectedClassId];
            }
        } else { // Teacher view
            if (!selectedTeacherId) return;
            const teacher = schedules[selectedTeacherId];
            document.getElementById('modal-title').textContent = `Edit Entry for ${teacher.shortName || teacher.name}`;
            const entryIndex = (teacher[day] || []).findIndex(e => e.period === period);
            
            if (entryIndex > -1) {
                isNew = false;
                const entry = teacher[day][entryIndex];
                originalEntries.push({ ...entry, teacherId: selectedTeacherId, day, originalIndex: entryIndex });
                (entry.subjectIds || [null]).forEach(subjectId => addSubjectTeacherPairRow(subjectId, selectedTeacherId, true));
                locationId = entry.locationId;
                classIds = entry.classIds;
            } else {
                addSubjectTeacherPairRow('', selectedTeacherId, true);
            }
        }

        container.dataset.originalEntries = JSON.stringify(originalEntries);
        document.getElementById('delete-entry-btn').style.display = isNew ? 'none' : 'block';
        
        populateCheckboxDropdown('classes', classIds);
        populateLocationDropdown(locationId);
        toggleModal('edit-modal', true);
    }

    function addSubjectTeacherPairRow(selectedSubjectId = '', selectedTeacherId = '', isTeacherLocked = false) {
        const container = document.getElementById('subject-teacher-pairs-container');
        const row = document.createElement('div');
        row.className = 'subject-teacher-pair-row flex items-center gap-2 mb-2';

        const subjectSelect = document.createElement('select');
        subjectSelect.className = 'modal-subject-select flex-grow p-2 border border-gray-300 rounded-lg bg-white text-sm';
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        Object.values(subjects).sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
            const option = new Option(s.name, s.id, false, s.id === selectedSubjectId);
            subjectSelect.add(option);
        });

        const teacherSelect = document.createElement('select');
        teacherSelect.className = 'modal-teacher-select flex-grow p-2 border border-gray-300 rounded-lg bg-white text-sm';
        teacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
        Object.values(schedules).sort((a,b) => (a.shortName || a.name).localeCompare(b.shortName || b.name)).forEach(t => {
            const option = new Option(t.shortName || t.name, t.id, false, t.id === selectedTeacherId);
            teacherSelect.add(option);
        });
        teacherSelect.disabled = isTeacherLocked;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.innerHTML = '&times;';
        removeBtn.className = 'remove-pair-btn text-red-500 hover:text-red-700 font-bold text-xl px-2';
        removeBtn.onclick = () => row.remove();

        row.append(subjectSelect, teacherSelect, removeBtn);
        container.appendChild(row);
    }
    
    function populateDayPeriodDropdowns(selectedDay, selectedPeriod) { /* Unchanged */ }
    function populateCheckboxDropdown(type, selectedIds) { /* Unchanged */ }
    function populateLocationDropdown(selectedId) { /* Unchanged */ }
    function updateDropdownButtonText(type) { /* Unchanged */ }
    
    async function handleSave(e) { 
        e.preventDefault(); 
        const batch = writeBatch(db);
        const container = document.getElementById('subject-teacher-pairs-container');
        const originalEntries = JSON.parse(container.dataset.originalEntries || '[]');

        const newPairs = [];
        container.querySelectorAll('.subject-teacher-pair-row').forEach(row => {
            const subjectId = row.querySelector('.modal-subject-select').value;
            const teacherId = row.querySelector('.modal-teacher-select').value;
            if (subjectId && teacherId) {
                newPairs.push({ subjectId, teacherId });
            }
        });

        const newTeacherSchedules = {};
        newPairs.forEach(pair => {
            if (!newTeacherSchedules[pair.teacherId]) {
                newTeacherSchedules[pair.teacherId] = { subjectIds: [] };
            }
            newTeacherSchedules[pair.teacherId].subjectIds.push(pair.subjectId);
        });

        const day = document.getElementById('modal-day-select').value;
        const period = document.getElementById('modal-period-select').value;
        const classIds = Array.from(document.querySelectorAll('#classes-dropdown-menu input:checked')).map(el => el.value);
        const locationId = document.getElementById('modal-location-select').value || null;
        
        const affectedTeacherIds = new Set([
            ...originalEntries.map(e => e.teacherId),
            ...Object.keys(newTeacherSchedules)
        ]);

        for (const teacherId of affectedTeacherIds) {
            const teacherDocRef = doc(db, "schedules", teacherId);
            let updatedDaySchedule = schedules[teacherId][day] ? [...schedules[teacherId][day]] : [];

            const originalPeriod = document.getElementById('modal-period').value;
            updatedDaySchedule = updatedDaySchedule.filter(entry => entry.period !== originalPeriod);

            if (newTeacherSchedules[teacherId]) {
                const newEntryForTeacher = {
                    period,
                    classIds,
                    locationId,
                    subjectIds: newTeacherSchedules[teacherId].subjectIds
                };
                updatedDaySchedule.push(newEntryForTeacher);
            }
            
            batch.update(teacherDocRef, { [day]: updatedDaySchedule });
        }

        try {
            await batch.commit();
            toggleModal('edit-modal', false);
        } catch (error) {
            console.error("Save failed:", error);
            alert("An error occurred while saving.");
        }
    }
    
    function toggleModal(id, show) { /* Unchanged */ }
    function switchTab(tabName) { /* Unchanged */ }
    
    main();
</script>
</body>
</html>

